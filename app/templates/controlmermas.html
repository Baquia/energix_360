<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control de Mermas - Aprobaciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- ‚úÖ Estilos tomados de controlmermas.html -->
  <style>
    :root { --verde:#015249; --verde-dark:#013d36; --gris:#f6f7f8; --txt:#111827; --muted:#6b7280; --ok:#15803d; --warn:#b8860b; --no:#b00020; --bord:#e5e7eb; --bg:#ffffff; }
    *{box-sizing:border-box}
    body{font-family:Verdana,sans-serif;background:radial-gradient(circle at top,#d7f2ec 0,#f6f7f8 45%,#f6f7f8 100%);margin:0;color:var(--txt)}
    .layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{background:var(--verde-dark);color:#fff;padding:18px 16px;display:flex;flex-direction:column;gap:14px;position:sticky;top:0;height:100vh}
    .side-title{font-weight:700;font-size:18px;margin-bottom:10px}
    .side-btn{background:#0d4e47;color:#eaf7f6;border:1px solid rgba(0,0,0,.1);border-radius:10px;padding:10px 12px;text-align:left;font-weight:600;box-shadow:0 2px 5px rgba(0,0,0,.08) inset;cursor:pointer}
    .side-btn:hover{background:#0f5c53}
    .side-btn.logout{background:#a50e1d;border-color:#a50e1d}
    .side-btn.logout:hover{background:#8d0c19}
    .brand{margin-top:auto;font-size:12px;opacity:.8}
    .wrap{padding:24px 22px}
    /* Header logos */
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:8px;border-radius:12px;padding:10px 14px;margin-bottom:14px}
    .header .logo{height:42px;max-width:48%;object-fit:contain}
    @media (max-width:560px){ .header{flex-direction:column;justify-content:center}.header .logo{max-width:100%;height:36px} }
    .topbar{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
    h1{color:var(--verde);font-size:24px;margin:8px 0 18px}
    .small{font-size:12px;color:#555}
    .card{background:var(--bg);border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.07);margin-bottom:14px;border:1px solid var(--bord)}
    .row{display:flex;flex-wrap:wrap;gap:16px}
    .col{flex:1 1 300px;min-width:260px}
    .imgbox{width:220px;height:180px;border-radius:10px;overflow:hidden;background:#ddd;display:flex;align-items:center;justify-content:center}
    .imgbox img{width:100%;height:100%;object-fit:cover}
    .meta{font-size:13px;color:#333}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#e0f2fe;font-size:11px;color:#075985;margin-left:4px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button.action{border:0;padding:10px 12px;border-radius:8px;cursor:pointer;color:#fff;font-weight:600;font-size:13px}
    .ok{background:var(--ok)} .warn{background:var(--warn)} .no{background:var(--no)}
    button.action:hover{opacity:.9}
    textarea{width:100%;min-height:60px;resize:vertical;border:1px solid var(--bord);border-radius:8px;padding:8px;font-family:inherit;margin-top:6px}
    .empty{text-align:center;padding:36px;color:#666}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000;padding:14px}
    .modal{width:min(720px,96vw);background:#fff;border-radius:12px;border:1px solid var(--bord);overflow:hidden;animation:pop .18s ease-out}
    @keyframes pop{from{transform:scale(.98);opacity:.6}to{transform:scale(1);opacity:1}}
    .modal-head{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bord);background:#f9fafb}
    .modal-title{font-weight:700;color:var(--verde)}
    .modal-body{padding:16px;display:grid;grid-template-columns:1fr 2fr;gap:16px}
    .pill{display:block;width:100%;text-align:left;padding:10px 12px;border-radius:8px;border:1px solid var(--bord);background:#f3f4f6;cursor:pointer;margin-bottom:10px;font-weight:600;color:#0f3f39}
    .pill.active{background:#e8f4f3;border-color:#b9e2de}
    .sec{background:#fbfbfb;border:1px solid var(--bord);border-radius:12px;padding:12px;min-height:210px}
    .sec h3{margin:0 0 10px 0;font-size:15px;color:#0f3f39}
    .row2{display:flex;gap:10px;flex-wrap:wrap}
    .row2>*{flex:1 1 200px}
    .inp, select{width:100%;padding:10px 12px;border:1px solid var(--bord);border-radius:8px;background:#fff;font-size:14px}
    .modal-foot{padding:14px 16px;border-top:1px solid var(--bord);display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;background:#f9fafb}
    .btn{border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--verde);color:#fff} .btn.secondary{background:#e5e7eb;color:#111827} .btn.ghost{background:transparent;color:var(--verde)}
    @media (max-width:860px){.modal-body{grid-template-columns:1fr}}
    @media (max-width:700px){.layout{grid-template-columns:1fr}.sidebar{position:static;height:auto}}
    /* Informe */
    #report{margin-top:14px}
    .report-head{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .tbl{width:100%;border-collapse:collapse;margin-top:8px}
    .tbl th,.tbl td{border:1px solid var(--bord);padding:8px;text-align:right}
    .tbl th:first-child,.tbl td:first-child{text-align:left}
    .tbl tfoot td{font-weight:700;background:#f9fafb}
    .filters{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .filters select,.filters input[type="date"]{padding:6px 8px;font-size:13px;border-radius:8px;border:1px solid var(--bord)}
    .chart-box{margin-top:16px;border-radius:12px;border:1px solid var(--bord);padding:10px;background:#fafafa}
    .chart-box canvas{width:100%;max-height:280px}
    .legend{font-size:12px;color:#444;margin-top:6px}
  </style>

  <!-- ‚úÖ Script original (se mantiene tal cual) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="side-title">Control de Mermas</div>
      <button id="btnOpenConsultas" class="side-btn">üîé Consultar mermas</button>
      <a class="side-btn logout" href="/logout">‚èª Cerrar sesi√≥n</a>
      <div class="brand">Energix-360</div>
    </aside>

    <main class="wrap">
      <!-- Header logos -->
      <div class="header">
        <img src="{{ url_for('static', filename='logo_' + session['empresa'] + '.png') }}" alt="Logo Cliente" class="logo">
        <img src="{{ url_for('static', filename='logo_energix360.png') }}" alt="Logo Energix 360" class="logo">
      </div>

      <div class="topbar">
        <h1>Pendientes de aprobaci√≥n</h1>
        <div class="small">Actualizaci√≥n autom√°tica cada 10 s</div>
      </div>

      <div id="list"></div>
      <div class="empty" id="empty" style="display:none;">No hay mermas pendientes.</div>

      <div id="report"></div>
    </main>
  </div>

  <!-- MODAL consultas (igual que versi√≥n previa original) -->
  <div id="modalConsultas" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="titleConsultas">
      <div class="modal-head">
        <div class="modal-title" id="titleConsultas">Consultar mermas</div>
        <button class="btn ghost" id="btnCloseModal">‚úï</button>
      </div>

      <div class="modal-body">
        <div>
          <button class="pill active" data-section="zona">Por zona</button>
          <button class="pill" data-section="vendedor">Por vendedor</button>
          <button class="pill" data-section="cliente">Por cliente</button>
          <button class="pill" data-section="vehiculo">Por veh√≠culo</button>
          <button class="pill" data-section="general">Consulta general</button>
        </div>

        <div>
          <div class="sec sec-zona">
            <h3>Consulta por zona</h3>
            <div class="row2">
              <select id="qZona" class="inp">
                <option value="">‚Äî Selecciona una zona ‚Äî</option>
              </select>
              <div class="row2">
                <input id="fDesde_z" type="date" class="inp" />
                <input id="fHasta_z" type="date" class="inp" />
              </div>
            </div>
          </div>

          <div class="sec sec-vendedor" style="display:none;">
            <h3>Consulta por vendedor</h3>
            <div class="row2">
              <select id="qVendedor" class="inp">
                <option value="">‚Äî Selecciona un vendedor ‚Äî</option>
              </select>
              <div class="row2">
                <input id="fDesde_v" type="date" class="inp" />
                <input id="fHasta_v" type="date" class="inp" />
              </div>
            </div>
          </div>

          <div class="sec sec-cliente" style="display:none;">
            <h3>Consulta por cliente</h3>
            <div class="row2">
              <select id="qCliente" class="inp">
                <option value="">‚Äî Selecciona un cliente ‚Äî</option>
              </select>
              <div class="row2">
                <input id="fDesde_c" type="date" class="inp" />
                <input id="fHasta_c" type="date" class="inp" />
              </div>
            </div>
          </div>

          <div class="sec sec-vehiculo" style="display:none;">
            <h3>Consulta por veh√≠culo</h3>
            <div class="row2">
              <select id="qVehiculo" class="inp">
                <option value="">‚Äî Selecciona un veh√≠culo ‚Äî</option>
              </select>
              <div class="row2">
                <input id="fDesde_ve" type="date" class="inp" />
                <input id="fHasta_ve" type="date" class="inp" />
              </div>
            </div>
          </div>

          <div class="sec sec-general" style="display:none;">
            <h3>Consulta general</h3>
            <div class="row2">
              <select id="qEstatus" class="inp">
                <option value="">‚Äî Estatus (todos) ‚Äî</option>
                <option value="aprobada">Aprobada</option>
                <option value="aprobada_no_conforme">Aprobada no conforme</option>
                <option value="rechazada">No aprobada</option>
                <option value="pendiente">Pendiente</option>
              </select>
              <div class="row2">
                <input id="fDesde_g" type="date" class="inp" />
                <input id="fHasta_g" type="date" class="inp" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn secondary" id="btnCerrar">Cerrar</button>
        <button class="btn primary" id="btnEjecutarConsulta">Consultar</button>
      </div>
    </div>
  </div>

  <script>
    // ======== L√ìGICA ORIGINAL (sin cambios) ========
    // Pendientes
    const list = document.getElementById("list");
    const empty = document.getElementById("empty");

    async function cargarPendientes(){
      try{
        const r = await fetch('/mermas/pending');
        const j = await r.json();
        if(!j.success) throw new Error('Error al cargar pendientes');
        list.innerHTML = '';
        if(!j.items || j.items.length === 0){
          empty.style.display='block';
          return;
        }
        empty.style.display='none';
        j.items.forEach(drawCard);
      }catch(e){
        console.error(e);
      }
    }

    function drawCard(it){
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `
        <div class="row">
          <div class="imgbox">
            ${it.evidencia_url ? `<img src="/static/${it.evidencia_url}" alt="evidencia">` : '<span>Sin foto</span>'}
          </div>
          <div class="col">
            <div class="meta">
              <b>${it.cliente}</b> 
              <span class="badge">${it.vehiculo || 'Veh√≠culo ?'}</span><br>
              Factura: <b>${it.factura}</b><br>
              KG factura: <b>${it.kg_factura}</b> ¬∑ KG entregados: <b>${it.kg_entregados}</b><br>
              Merma: <b>${it.merma_kg} kg</b> (<b>${it.merma_pct}%</b>)<br>
              Operador: ${it.operador_nombre || '‚Äî'}<br>
              Fecha: ${new Date(it.fecha).toLocaleString()}
            </div>
            <textarea id="c_${it.id}" placeholder="Comentario (opcional)"></textarea>
            <div class="actions">
              <button class="action ok" onclick="accion(${it.id},'aprobar')">Aprobar</button>
              <button class="action no" onclick="accion(${it.id},'no_aprobar')">No aprobar</button>
              <button class="action warn" onclick="accion(${it.id},'aprobar_nc')">Aprobar no conforme</button>
            </div>
          </div>
        </div>
      `;
      list.appendChild(card);
    }

    async function accion(id, tipo){
      const comentario = (document.getElementById('c_'+id)||{}).value || '';
      try{
        const r = await fetch('/mermas/accion', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id, accion: tipo, comentario })
        });
        const j = await r.json();
        if(!j.success) throw new Error(j.message || 'Error en acci√≥n');
        alert(`Solicitud ${id}: ${j.estado.replace('_',' ')}`);
        await cargarPendientes();
      }catch(e){
        console.error(e);
        alert('No se pudo ejecutar la acci√≥n.');
      }
    }

    cargarPendientes();
    setInterval(cargarPendientes, 10000);

    // ======== Modal de consultas y reportes (original) ========

    const modal = document.getElementById('modalConsultas');
    const btnOpen = document.getElementById('btnOpenConsultas');
    const btnClose = document.getElementById('btnCloseModal');
    const btnCerrar = document.getElementById('btnCerrar');
    const btnConsultar = document.getElementById('btnEjecutarConsulta');

    btnOpen.addEventListener('click', () => {
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
      cargarOpciones('zona', document.getElementById('qZona'));
      cargarOpciones('vendedor', document.getElementById('qVendedor'));
      cargarOpciones('cliente', document.getElementById('qCliente'));
      cargarOpciones('vehiculo', document.getElementById('qVehiculo'));
    });
    function closeModal() { modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); }
    btnClose.addEventListener('click', closeModal);
    btnCerrar.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal.style.display === 'flex') closeModal(); });

    const pills = document.querySelectorAll('.pill');
    const sections = {
      zona: document.querySelector('.sec-zona'),
      vendedor: document.querySelector('.sec-vendedor'),
      cliente: document.querySelector('.sec-cliente'),
      vehiculo: document.querySelector('.sec-vehiculo'),
      general: document.querySelector('.sec-general'),
    };

    pills.forEach(p=>{
      p.addEventListener('click', ()=>{
        pills.forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        const key = p.getAttribute('data-section');
        Object.entries(sections).forEach(([k,el])=>{
          el.style.display = (k===key) ? 'block' : 'none';
        });
        if(key==='zona')      cargarOpciones('zona', document.getElementById('qZona'));
        if(key==='vendedor')  cargarOpciones('vendedor', document.getElementById('qVendedor'));
        if(key==='cliente')   cargarOpciones('cliente', document.getElementById('qCliente'));
        if(key==='vehiculo')  cargarOpciones('vehiculo', document.getElementById('qVehiculo'));
      });
    });

    async function cargarOpciones(tipo, selectEl){
      try{
        if(!selectEl) return;
        const r = await fetch(`/mermas/opciones?tipo=${encodeURIComponent(tipo)}`);
        const j = await r.json();
        if(!j.success) return;
        const valPrev = selectEl.value;
        selectEl.innerHTML = `<option value="">‚Äî Selecciona ${tipo==='vehiculo'?'un veh√≠culo':'una '+tipo} ‚Äî</option>`;
        (j.items||[]).forEach(v=>{
          const opt = document.createElement('option');
          opt.value = v; opt.textContent = v;
          selectEl.appendChild(opt);
        });
        if (valPrev && [...selectEl.options].some(o=>o.value===valPrev)) selectEl.value = valPrev;
      }catch(e){ console.error(e); }
    }

    const report = document.getElementById('report');
    let chartRef = null;

    btnConsultar.addEventListener('click', async ()=>{
      const active = document.querySelector('.pill.active')?.getAttribute('data-section');
      const payload = { tipo: active };
      if (active === 'zona') {
        payload.zona = document.getElementById('qZona').value.trim();
        payload.desde = document.getElementById('fDesde_z').value;
        payload.hasta = document.getElementById('fHasta_z').value;
        if(!payload.zona){ alert('Selecciona una zona.'); return; }
      } else if (active === 'vendedor') {
        payload.vendedor = document.getElementById('qVendedor').value.trim();
        payload.desde = document.getElementById('fDesde_v').value;
        payload.hasta = document.getElementById('fHasta_v').value;
        if(!payload.vendedor){ alert('Selecciona un vendedor.'); return; }
      } else if (active === 'cliente') {
        payload.cliente = document.getElementById('qCliente').value.trim();
        payload.desde = document.getElementById('fDesde_c').value;
        payload.hasta = document.getElementById('fHasta_c').value;
        if(!payload.cliente){ alert('Selecciona un cliente.'); return; }
      } else if (active === 'vehiculo') {
        payload.vehiculo = document.getElementById('qVehiculo').value.trim();
        payload.desde = document.getElementById('fDesde_ve').value;
        payload.hasta = document.getElementById('fHasta_ve').value;
        if(!payload.vehiculo){ alert('Selecciona un veh√≠culo.'); return; }
      } else {
        payload.estatus = document.getElementById('qEstatus').value;
        payload.desde = document.getElementById('fDesde_g').value;
        payload.hasta = document.getElementById('fHasta_g').value;
      }

      try{
        const r = await fetch('/mermas/consulta', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        const j = await r.json();
        if(!j.success) throw new Error(j.message||'Consulta fallida');
        closeModal();
        renderInforme(j);
      }catch(e){
        console.error(e);
        alert('No se pudo ejecutar la consulta.');
      }
    });

    function renderInforme(data){
      report.innerHTML = '';

      const titulo = makeTitulo(data.filtros);
      const head = document.createElement('div');
      head.className = 'report-head card';
      head.innerHTML = `
        <div class="row" style="align-items:center;justify-content:space-between;">
          <div class="pill-mini"><b>${titulo}</b></div>
          <div class="row" style="gap:8px;">
            <span class="pill-mini">KG totales: <b>${fmt(data.resumen.kg_totales)}</b></span>
            <span class="pill-mini">Merma total (kg): <b>${fmt(data.resumen.merma_total)}</b></span>
            <span class="pill-mini">Merma total (%): <b>${fmt(data.resumen.merma_pct_total)}</b>%</span>
            <span class="pill-mini">Registros: <b>${data.resumen.registros}</b></span>
            <button id="btnPDF" class="btn primary">Descargar PDF</button>
          </div>
        </div>
      `;
      report.appendChild(head);

      const cardTabla = document.createElement('div');
      cardTabla.className = 'card';
      cardTabla.innerHTML = `
        <h3 style="margin:0 0 8px 0;color:var(--verde)">Detalle por cliente</h3>
        <table class="tbl">
          <thead>
            <tr><th>Cliente</th><th>KG</th><th>Merma (kg)</th><th>Merma (%)</th></tr>
          </thead>
          <tbody>
            ${data.detalle_clientes.map(r=>`
              <tr>
                <td>${esc(r.cliente)}</td>
                <td>${fmt(r.kg_cliente)}</td>
                <td>${fmt(r.merma_cliente)}</td>
                <td>${fmt(r.pct_cliente)}%</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      report.appendChild(cardTabla);

      const cardChart = document.createElement('div');
      cardChart.className = 'card';
      const chartTitle =
        data.filtros.tipo === 'vendedor' ? 'Merma (%) por cliente (vendedor)'
      : data.filtros.tipo === 'zona'     ? 'Merma (%) por cliente (zona)'
      : data.filtros.tipo === 'cliente'  ? 'Merma (%) por factura'
      : data.filtros.tipo === 'vehiculo' ? 'Merma (%) por fecha/hora de entrega'
      : 'Merma (%)';
      cardChart.innerHTML = `
        <h3 style="margin:0 0 8px 0;color:var(--verde)">${chartTitle}</h3>
        <div class="chart-wrap"><canvas id="cvMerma" class="chart-canvas"></canvas></div>
      `;
      report.appendChild(cardChart);

      const ctx = document.getElementById('cvMerma').getContext('2d');
      if(chartRef){ chartRef.destroy(); }

      const chart = data.chart || {type:'bar', labels:[], values:[], series_label:'Merma (%)', x_title:'', y_title:'Merma (%)'};
      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, ticks: { callback: (val) => `${val}%` }, title: { display: true, text: chart.y_title || 'Merma (%)' } },
          x: { ticks: { maxRotation: 0 }, title: { display: !!chart.x_title, text: chart.x_title || '' } }
        },
        plugins: {
          legend: { display: true },
          tooltip: { callbacks: { label: (ctx) => ` ${ctx.parsed.y}%` } }
        }
      };

      if (chart.type === 'points') {
        chartRef = new Chart(ctx, { type: 'line', data: { labels: chart.labels, datasets: [{ label: chart.series_label || 'Merma (%)', data: chart.values, showLine:false, pointRadius:4, pointHoverRadius:6, pointHitRadius:10 }] }, options: { ...commonOptions } });
      } else {
        chartRef = new Chart(ctx, { type: 'bar', data: { labels: chart.labels, datasets: [{ label: chart.series_label || 'Merma (%)', data: chart.values }] }, options: { ...commonOptions } });
      }

      const cardOps = document.createElement('div');
      cardOps.className = 'card';
      cardOps.innerHTML = `
        <h3 style="margin:0 0 8px 0;color:var(--verde)">Operaciones</h3>
        <div style="overflow:auto">
          <table class="tbl">
            <thead>
              <tr>
                <th>Fecha</th><th>Cliente</th><th>Factura</th>
                <th>KG factura</th><th>KG entregados</th>
                <th>Merma (kg)</th><th>Merma (%)</th><th>Operador</th>
              </tr>
            </thead>
            <tbody>
              ${data.operaciones.map(op=>`
                <tr>
                  <td>${esc(op.fecha)}</td>
                  <td>${esc(op.cliente)}</td>
                  <td>${esc(op.factura)}</td>
                  <td>${fmt(op.kg_factura)}</td>
                  <td>${fmt(op.kg_entregados)}</td>
                  <td>${fmt(op.merma_kg)}</td>
                  <td>${fmt(op.merma_pct)}%</td>
                  <td>${esc(op.operador_nombre)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      report.appendChild(cardOps);

      document.getElementById('btnPDF').onclick = async ()=>{
        let chart_png = null;
        try { chart_png = chartRef.toBase64Image(); } catch(e) { chart_png = null; }
        const payload = {
          titulo,
          filtros: data.filtros,
          resumen: data.resumen,
          detalle_clientes: data.detalle_clientes,
          operaciones: data.operaciones,
          chart_png
        };
        try{
          const r = await fetch('/mermas/consulta/pdf', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
          const blob = await r.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'informe_mermas.pdf';
          document.body.appendChild(a); a.click();
          a.remove(); URL.revokeObjectURL(url);
        }catch(e){ console.error(e); alert('No se pudo generar el PDF.'); }
      };
    }

    function makeTitulo(f){
      const rango = (f.desde||f.hasta) ? ` (${f.desde||'...'} ‚Üí ${f.hasta||'...'})` : '';
      if(f.tipo==='zona' && f.zona) return `Informe por zona: ${f.zona}${rango}`;
      if(f.tipo==='vendedor' && f.vendedor) return `Informe por vendedor: ${f.vendedor}${rango}`;
      if(f.tipo==='cliente' && f.cliente) return `Informe por cliente: ${f.cliente}${rango}`;
      if(f.tipo==='vehiculo' && f.vehiculo) return `Informe por veh√≠culo: ${f.vehiculo}${rango}`;
      if(f.tipo==='general'){
        const e = f.estatus ? ` [${f.estatus}]` : '';
        return `Informe general${e}${rango}`;
      }
      return `Informe de mermas${rango}`;
    }
    function fmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:3}); }
    function esc(s){ const d=document.createElement('div'); d.textContent=String(s||''); return d.textContent; }
  </script>
</body>
</html>
