<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Control de Mermas - BQA ONE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="apple-touch-icon" href="/static/icon-192.png">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#015249">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <script src="/static/js/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* ================= BARRA DE FLUJO (WORKFLOW) ================= */
    .flow-bar {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      border: 1px solid var(--bord);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .flow-btn {
      flex: 1;
      min-width: 140px;
      padding: 10px;
      border: 1px solid var(--bord);
      background: #f8fafc;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 5px;
      transition: all 0.2s;
      color: var(--txt);
    }

    .flow-btn:hover {
      background: #eff6ff;
      border-color: var(--verde);
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .flow-btn i {
      font-size: 1.5rem;
      color: var(--verde);
    }

    .flow-btn span {
      font-size: 0.75rem;
      font-weight: 600;
    }

    .flow-step-badge {
      background: var(--verde);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      margin-bottom: 3px;
    }

    /* ================= ESTILOS GENERALES (ORIGINALES) ================= */
    :root {
      --verde: #015249;
      --verde-dark: #013d36;
      --gris: #f6f7f8;
      --txt: #111827;
      --muted: #6b7280;
      --ok: #15803d;
      --warn: #b45309;
      --no: #be123c;
      --bord: #e5e7eb;
      --bg: #ffffff;
      --orange: #f97316;
      --purple: #1e3a8a;
      ;
      /* Nuevo color para Investigaci√≥n */
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: Verdana, sans-serif;
      background: radial-gradient(circle at top, #d7f2ec 0, #f6f7f8 45%, #f6f7f8 100%);
      margin: 0;
      color: var(--txt);
      min-height: 100vh;
    }

    /* ================= LAYOUT ================= */
    .layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    /* ================= SIDEBAR ================= */
    .sidebar {
      background: var(--verde-dark);
      color: #fff;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: sticky;
      top: 0;
      height: 100vh;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }

    .side-title {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 20px;
      text-align: center;
    }

    .side-btn {
      background: #0d4e47;
      color: #eaf7f6;
      border: 1px solid rgba(0, 0, 0, .1);
      border-radius: 8px;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .side-btn:hover {
      background: #0f5c53;
    }

    .side-btn.active {
      background: #eaf7f6;
      color: var(--verde);
      border-color: white;
    }

    .side-btn.logout {
      background: #a50e1d;
      margin-top: auto;
      border-color: #8d0c19;
      text-decoration: none;
      display: block;
      text-align: center;
      color: white;
    }

    .badge-count {
      background: #ef4444;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      margin-left: auto;
    }

    .brand {
      margin-top: 10px;
      font-size: 11px;
      opacity: 0.7;
      text-align: center;
    }

    /* ================= CONTENIDO PRINCIPAL ================= */
    .wrap {
      padding: 24px;
      overflow-y: auto;
      height: 100vh;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(5px);
      border-radius: 12px;
      padding: 10px 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .logo {
      height: 40px;
      object-fit: contain;
    }

    h1 {
      color: var(--verde);
      font-size: 22px;
      margin: 0 0 5px 0;
    }

    .subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 20px;
    }

    /* ================= TARJETAS DE FACTURA ================= */
    .invoice-card {
      background: var(--bg);
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-bottom: 25px;
      overflow: hidden;
      border: 1px solid var(--bord);
      animation: slideIn 0.3s ease-out;
      border-left: 5px solid transparent;
    }

    /* Indicadores visuales por tipo de bandeja */
    .invoice-card.st-envivo {
      border-left-color: var(--no);
    }

    .invoice-card.st-nocturna {
      border-left-color: var(--warn);
    }

    .invoice-card.st-investigacion {
      border-left-color: var(--purple);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .invoice-header {
      background: var(--verde);
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
    }

    .invoice-header.header-nocturna {
      background: var(--warn);
      color: white;
    }

    .invoice-header.header-investigacion {
      background: var(--purple);
      color: white;
    }

    /* ================= FILA DE √çTEM ================= */
    .item-row {
      display: grid;
      grid-template-columns: 320px 1fr 200px;
      gap: 20px;
      padding: 15px 20px;
      border-bottom: 1px solid var(--bord);
      align-items: center;
      background: #fff;
      transition: opacity 0.3s;
    }

    .item-row:last-child {
      border-bottom: none;
    }

    .item-row:hover {
      background: #f9fafb;
    }

    /* ================= MULTIMEDIA ================= */
    .media-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .thumb-video {
      width: 120px;
      height: 80px;
      background: #000;
      border-radius: 6px;
      object-fit: contain;
      cursor: pointer;
      border: 1px solid #ddd;
    }

    .thumb-img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid #ddd;
      transition: transform 0.2s;
    }

    .thumb-img:hover,
    .thumb-video:hover {
      transform: scale(1.05);
      border-color: var(--verde);
    }

    /* ================= INFO ================= */
    .info-group {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .item-title {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--verde);
      margin-bottom: 6px;
    }

    .item-meta {
      font-size: 0.9rem;
      color: #4b5563;
    }

    .merma-badge {
      background: #fee2e2;
      color: #991b1b;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 1rem;
      margin-top: 8px;
      display: inline-block;
      width: fit-content;
      border: 1px solid #fecaca;
    }

    /* ================= BOTONES ACCI√ìN ================= */
    .action-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .btn-action {
      border: none;
      padding: 12px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      color: white;
      transition: opacity 0.2s;
      font-size: 0.85rem;
      text-align: center;
      font-family: Verdana, sans-serif;
    }

    .btn-action:hover {
      opacity: 0.9;
    }

    .btn-approve {
      background: var(--ok);
    }

    .btn-object {
      background: var(--no);
    }

    /* Cambio a rojo fuerte para objetar */
    .btn-validate {
      background: var(--warn);
    }

    .btn-investigate {
      background: var(--purple);
    }

    /* ================= EMPTY STATE ================= */
    .empty-state {
      text-align: center;
      padding: 50px;
      color: #9ca3af;
      font-size: 1.2rem;
    }

    /* ================= LIGHTBOX ================= */
    #lightbox {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }

    /* ================= MODAL DE INVESTIGACI√ìN (NUEVO) ================= */
    .inv-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: 15px;
      backdrop-filter: blur(3px);
    }

    .inv-card {
      background: white;
      width: 100%;
      max-width: 700px;
      border-radius: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
      animation: popUp 0.3s ease-out;
    }

    @keyframes popUp {
      from {
        transform: scale(0.9);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .inv-header {
      background: var(--purple);
      color: white;
      padding: 15px 20px;
      font-weight: bold;
      font-size: 1.1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .inv-body {
      padding: 20px;
      overflow-y: auto;
    }

    .inv-textarea {
      width: 100%;
      height: 150px;
      padding: 12px;
      border: 1px solid var(--bord);
      border-radius: 6px;
      resize: none;
      font-family: inherit;
      font-size: 0.95rem;
      margin-top: 10px;
      background: #f9fafb;
    }

    .inv-actions {
      padding: 20px;
      background: #f8fafc;
      border-top: 1px solid var(--bord);
      display: flex;
      gap: 15px;
      justify-content: flex-end;
    }

    /* ================= MODAL DE CONSULTAS / REPORTES ================= */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 15px;
    }

    .modal {
      width: min(800px, 95vw);
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }

    .modal-head {
      padding: 15px 20px;
      background: #f9fafb;
      border-bottom: 1px solid var(--bord);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-weight: 700;
      color: var(--verde);
      font-size: 16px;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 20px;
    }

    .pill {
      display: block;
      width: 100%;
      text-align: left;
      padding: 12px;
      margin-bottom: 5px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      color: #555;
      font-size: 12px;
    }

    .pill:hover {
      background: #f0fdf9;
      color: var(--verde);
    }

    .pill.active {
      background: #e0f7fa;
      color: var(--verde);
      border-color: #b2dfdb;
    }

    .sec {
      background: #f8fafc;
      border: 1px solid var(--bord);
      border-radius: 8px;
      padding: 15px;
    }

    .sec h3 {
      margin-top: 0;
      font-size: 14px;
      color: var(--verde);
    }

    .inp {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--bord);
      border-radius: 6px;
      margin-bottom: 10px;
      font-family: Verdana;
      font-size: 13px;
    }

    .modal-foot {
      padding: 15px 20px;
      border-top: 1px solid var(--bord);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background: #f9fafb;
    }

    .btn {
      padding: 10px 18px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
    }

    .btn.primary {
      background: var(--verde);
      color: #fff;
    }

    .btn.secondary {
      background: #fff;
      border: 1px solid var(--bord);
      color: #333;
    }

    /* ESTILOS DE REPORTE GENERADO */
    .report-head {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--bord);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .stat-badge {
      background: #e6fffa;
      color: var(--verde-dark);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 11px;
      border: 1px solid #b2f5ea;
      margin-right: 5px;
    }

    .chart-box {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--bord);
      margin-top: 20px;
    }

    .tbl {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .tbl th {
      background: #f1f5f9;
      padding: 10px;
      text-align: left;
      color: #555;
      font-weight: bold;
      border-bottom: 2px solid var(--bord);
    }

    .tbl td {
      padding: 10px;
      border-bottom: 1px solid var(--bord);
    }

    /* RESPONSIVE MEDIA QUERIES */
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .sidebar {
        flex-direction: row;
        height: auto;
        align-items: center;
        overflow-x: auto;
      }

      .side-btn {
        white-space: nowrap;
        margin: 0 5px;
      }

      .modal-body {
        grid-template-columns: 1fr;
      }

      .item-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .media-group {
        justify-content: center;
      }

      .action-group {
        flex-direction: row;
      }
    }
  </style>
</head>

<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="side-title">Control Mermas</div>

      <button class="side-btn active" onclick="cambiarVista('envivo', this)">
        <i class="bi bi-broadcast"></i> En Vivo (D√≠a)
      </button>

      <button class="side-btn" onclick="cambiarVista('nocturna', this)">
        <i class="bi bi-moon-stars"></i> Rev. Nocturna
      </button>

      <button class="side-btn" onclick="cambiarVista('investigacion', this)">
        <i class="bi bi-search"></i> Investigaci√≥n
      </button>

      <div style="height: 1px; background: rgba(255,255,255,0.2); margin: 10px 0;"></div>

      <button id="btnOpenConsultas" class="side-btn">
        <i class="bi bi-bar-chart-line"></i> Informes
      </button>

      <a class="side-btn logout" href="/logout">
        <i class="bi bi-box-arrow-left"></i> Salir
      </a>

      <div class="brand">Energix-360</div>
    </aside>

    <main class="wrap">
      <div class="header">
        <img src="{{ url_for('static', filename='logo_' + session['empresa'] + '.png') }}" class="logo"
          onerror="this.style.display='none'">
        <img src="{{ url_for('static', filename='logo_energix360.png') }}" class="logo">
      </div>

      <div>
        <h1 id="page-title">Gesti√≥n de Mermas</h1>
        <div class="subtitle" id="page-subtitle">Bandeja de Aprobaciones en Tiempo Real</div>
      </div>

      <div id="list"></div>

      <div id="empty" style="display:none;" class="empty-state">
        ‚úÖ Todo al d√≠a.
      </div>

      <div id="report"></div>

      <div class="flow-bar">
        <button class="flow-btn" onclick="abrirModalReporteVentas()">
          <div class="flow-step-badge">1</div>
          <i class="bi bi-file-earmark-spreadsheet"></i>
          <span>Reporte Ventas<br>(Gerencial)</span>
        </button>

        <button class="flow-btn" onclick="abrirModalNotas()">
          <div class="flow-step-badge">2</div>
          <i class="bi bi-files"></i>
          <span>Consultar Notas<br>(Historial y PDF)</span>
        </button>

        <button class="flow-btn" onclick="activarFlujo(3)">
          <div class="flow-step-badge">3</div>
          <i class="bi bi-moon-stars-fill" style="color:var(--warn)"></i>
          <span>Revisar Pendientes<br>(Nocturnas)</span>
        </button>

        <button class="flow-btn" onclick="activarFlujo('investigacion')">
          <div class="flow-step-badge">4</div>
          <i class="bi bi-search" style="color:var(--purple)"></i>
          <span>Investigaciones<br>(Citar / Atender)</span>
        </button>
      </div>
    </main>
  </div>

  <div id="lightbox" onclick="this.style.display='none'">
    <div id="lightbox-container"></div>
  </div>

  <div id="modalInv" class="inv-modal">
    <div class="inv-card">

      <div class="inv-header">
        <span>‚öñÔ∏è GESTI√ìN DE INVESTIGACI√ìN</span>
        <button onclick="cerrarInv()"
          style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
      </div>

      <div id="inv-note-info"
        style="background: #eff6ff; padding: 10px 20px; border-bottom: 1px solid #dbeafe; display:none; align-items:center; gap:10px;">
        <span style="font-size: 1.5rem;">üìÑ</span>
        <div>
          <strong style="color:#1e3a8a; font-size:0.9rem;">Nota Cr√©dito Generada: <span
              id="inv_nc_num"></span></strong><br>
          <a id="inv_nc_link" href="#" target="_blank"
            style="color:#2563eb; font-size:0.8rem; text-decoration:underline;">Ver Documento PDF</a>
        </div>
      </div>

      <div class="inv-body">
        <p style="color:#666; font-size:0.9rem;">
          Este caso se encuentra en etapa de investigaci√≥n. Por favor registre el testimonio del operador y tome una
          decisi√≥n final.
        </p>

        <label style="font-weight:bold; color:var(--verde);">Testimonio / Descargo del Operador:</label>
        <textarea id="inv_testimonio" class="inv-textarea"
          placeholder="Escriba aqu√≠ la explicaci√≥n detallada del operador sobre la diferencia..."></textarea>

        <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
          <button class="btn primary" style="background:var(--verde);" onclick="guardarTestimonio()">üíæ Guardar
            Progreso</button>
          <span id="save_msg" style="font-size:0.8rem; color:green;"></span>
        </div>

        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">

        <div
          style="background:#fff7ed; padding:10px; border-radius:6px; border:1px solid #fed7aa; font-size:0.85rem; color:#9a3412;">
          <b>Dictamen Final:</b><br>
          ‚Ä¢ <b>Cerrar Caso (Conforme):</b> Se acepta la explicaci√≥n. El caso se archiva.<br>
          ‚Ä¢ <b>A RRHH (No Conforme):</b> Se rechaza la explicaci√≥n. Se env√≠a reporte y evidencias a Talento Humano.
        </div>
      </div>

      <div class="inv-actions">
        <button class="btn-action" style="background:#64748b; width:auto; padding:12px 25px;"
          onclick="cerrarInv()">Cancelar / Salir</button>

        <button class="btn-action" style="background:#b91c1c; width:auto; padding:12px 25px;"
          onclick="decisionFinal('no_conforme')">A RRHH (Sanci√≥n)</button>

        <button class="btn-action" style="background:#15803d; width:auto; padding:12px 25px;"
          onclick="decisionFinal('conforme')">Cerrar Caso</button>
      </div>

    </div>
  </div>

  <div id="modalConsultas" class="modal-backdrop">
    <div class="modal" style="height: auto; max-height: 90vh;">
      <div class="modal-head">
        <div class="modal-title">üìä Informe Operativo por Veh√≠culo</div>
        <button class="btn secondary" id="btnCloseModal">‚úï</button>
      </div>

      <div class="modal-body" style="display: block; padding: 20px;">

        <p style="color:#666; font-size:0.9rem; margin-top:0; margin-bottom: 20px;">
          Este informe analiza el comportamiento f√≠sico de la carga (Curva de Descongelamiento) filtrado por placa.
        </p>

        <label style="font-weight:bold; font-size:0.85rem; display:block; margin-bottom: 5px;">Seleccione
          Veh√≠culo:</label>
        <select id="qVehiculo" class="inp">
          <option value="">Cargando lista...</option>
        </select>

        <label
          style="font-weight:bold; font-size:0.85rem; display:block; margin-top:15px; margin-bottom: 10px;">Seleccione
          Periodo:</label>

        <div style="display:flex; flex-direction:column; gap:8px;">
          <button class="pill active" id="btnRuta" onclick="setRangoRapido('ruta', this)">
            üöö √öltima Ruta (Hoy)
          </button>
          <button class="pill" id="btnSemana" onclick="setRangoRapido('semana', this)">
            üìÖ √öltima Semana (7 D√≠as)
          </button>
          <button class="pill" id="btnMes" onclick="setRangoRapido('mes', this)">
            üóìÔ∏è √öltimo Mes (30 D√≠as)
          </button>
        </div>

        <input type="hidden" id="fDesde_ve">
        <input type="hidden" id="fHasta_ve">

      </div>
      <div class="modal-foot">
        <button class="btn secondary" id="btnCerrar">Cancelar</button>
        <button class="btn primary" id="btnEjecutarConsulta">Generar Gr√°ficas</button>
      </div>
    </div>
  </div>

  <div id="modalFechasReporte" class="modal-backdrop">
    <div class="modal" style="width: 400px; height: auto;">
      <div class="modal-head">
        <div class="modal-title">üìÖ Reporte de Ventas y Operaci√≥n</div>
        <button class="btn secondary" onclick="cerrarModalFechas()">‚úï</button>
      </div>
      <div class="modal-body" style="display:block;">
        <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">
          Seleccione el periodo para generar el PDF consolidado (Ventas, Mermas, Rankings y Netos).
        </p>

        <label style="font-weight:bold; font-size:0.85rem;">Rango de Fechas:</label>
        <div style="display:flex; gap:10px; margin-top:5px;">
          <input type="date" id="rep_inicio" class="inp">
          <input type="date" id="rep_fin" class="inp">
        </div>

        <div style="margin-top:15px; display:flex; gap:10px;">
          <button class="pill" onclick="setFechas('ayer')">Ayer</button>
          <button class="pill" onclick="setFechas('hoy')">Hoy</button>
          <button class="pill" onclick="setFechas('mes')">Este Mes</button>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn secondary" onclick="cerrarModalFechas()">Cancelar</button>
        <button class="btn primary" onclick="generarReporteFinal()">üñ®Ô∏è Generar PDF</button>
      </div>
    </div>
  </div>

  <div id="modalBuscadorNotas" class="modal-backdrop">
    <div class="modal" style="width: 800px; max-height: 85vh;">
      <div class="modal-head">
        <div class="modal-title">üîç Historial de Notas Cr√©dito</div>
        <button class="btn secondary" onclick="cerrarModalNotas()">‚úï</button>
      </div>
      <div class="modal-body" style="display:block; padding:0;">

        <div style="padding: 20px; background: #f8fafc; border-bottom: 1px solid var(--bord);">
          <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
            <div>
              <label style="font-size:0.8rem; font-weight:bold;">Desde:</label>
              <input type="date" id="nc_desde" class="inp" style="margin:0;">
            </div>
            <div>
              <label style="font-size:0.8rem; font-weight:bold;">Hasta:</label>
              <input type="date" id="nc_hasta" class="inp" style="margin:0;">
            </div>
            <div>
              <label style="font-size:0.8rem; font-weight:bold;">Operador (Opcional):</label>
              <select id="nc_operador_sel" class="inp" style="margin:0;">
                <option value="">Todos</option>
              </select>
            </div>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
            <button class="pill" style="width:auto; padding:5px 15px;" onclick="setFechasNC('hoy')">Hoy</button>
            <button class="pill" style="width:auto; padding:5px 15px;" onclick="setFechasNC('ayer')">Ayer</button>
            <button class="pill" style="width:auto; padding:5px 15px;" onclick="setFechasNC('mes')">Este Mes</button>

            <div style="flex:1;"></div>
            <button class="btn primary" onclick="buscarNotasCredito()">üîé BUSCAR</button>
          </div>
        </div>

        <div style="height: 400px; overflow-y: auto; padding: 0;">
          <table class="tbl" style="width:100%;">
            <thead style="position:sticky; top:0; z-index:10;">
              <tr>
                <th>N¬∫ Nota</th>
                <th>Fecha</th>
                <th>Factura</th>
                <th>Cliente</th>
                <th>Operador</th>
                <th style="text-align:center;">Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="nc_tabla_resultados">
              <tr>
                <td colspan="6" style="text-align:center; padding:20px; color:#999;">Utilice los filtros para buscar.
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
      <div class="modal-foot">
        <span style="font-size:0.8rem; color:#666; margin-right:auto;" id="nc_status_bar"></span>
        <button class="btn secondary" onclick="cerrarModalNotas()">Cerrar</button>
      </div>
    </div>
  </div>

  <audio id="alert-sound" src="/static/alert.mp3" preload="auto"></audio>

  <script>
    const list = document.getElementById("list");
    const empty = document.getElementById("empty");
    const alertSound = document.getElementById('alert-sound');

    // VARIABLE DE ESTADO PRINCIPAL: 'envivo', 'nocturna', 'investigacion'
    let currentView = 'envivo';
    let lastDataStr = "";

    // ID del √≠tem activo para el modal de investigaci√≥n
    let activeInvId = null;

    // === CONFIGURACI√ìN DE POLLING ===
    // Eliminada restricci√≥n horaria en frontend para permitir visibilidad 24/7
    const INTERVALO = 15000;

    function cambiarVista(vista, btn) {
      currentView = vista;
      document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');

      // Actualizar t√≠tulos
      const title = document.getElementById('page-title');
      const sub = document.getElementById('page-subtitle');

      if (vista === 'envivo') {
        title.innerText = 'Gesti√≥n de Mermas (D√≠a)';
        title.style.color = 'var(--verde)';
        sub.innerText = 'Bandeja de Aprobaciones en Tiempo Real';
      } else if (vista === 'nocturna') {
        title.innerText = 'Revisi√≥n Nocturna';
        title.style.color = 'var(--warn)';
        sub.innerText = 'Mermas pre-aprobadas en horario nocturno para validaci√≥n';
      } else {
        title.innerText = 'Investigaci√≥n (Etapa 3)';
        title.style.color = 'var(--purple)';
        sub.innerText = 'Casos complejos, testimonios y dict√°menes finales';
      }

      list.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">Cargando...</div>';
      lastDataStr = "";

      // Ejecutar polling inmediatamente
      polling();
    }

    async function polling() {
      // Usamos la nueva ruta unificada del backend con el par√°metro ?view=
      try {
        const url = `/mermas/list_dashboard?view=${currentView}&t=${Date.now()}`;

        const r = await fetch(url);
        const data = await r.json();

        const currentDataStr = JSON.stringify(data.items);
        if (currentDataStr === lastDataStr) return;
        lastDataStr = currentDataStr;

        if (data.success && data.items && data.items.length > 0) {
          renderDashboard(data.items);
          empty.style.display = 'none';
        } else {
          list.innerHTML = '';
          empty.style.display = 'block';

          let msg = '‚úÖ Todo al d√≠a.';
          if (currentView === 'nocturna') msg = 'üåô No hay revisiones nocturnas pendientes.';
          if (currentView === 'investigacion') msg = 'üïµÔ∏è No hay casos en investigaci√≥n.';
          empty.innerText = msg;
        }
      } catch (e) { console.error(e); }
    }

    // Iniciar el ciclo de polling
    setInterval(polling, INTERVALO);
    polling();

    function renderDashboard(items) {
      const groups = {};
      items.forEach(it => {
        if (!it.factura) it.factura = 'Sin Factura';
        if (!groups[it.factura]) {
          groups[it.factura] = { factura: it.factura, cliente: it.cliente || 'Sin Cliente', vehiculo: it.vehiculo || 'Sin Veh√≠culo', items: [] };
        }
        groups[it.factura].items.push(it);
      });

      list.innerHTML = '';

      Object.values(groups).forEach(group => {
        const card = document.createElement('div');

        // Estilo de tarjeta seg√∫n vista
        let cardClass = 'invoice-card';
        let headerClass = 'invoice-header';

        if (currentView === 'envivo') cardClass += ' st-envivo';
        if (currentView === 'nocturna') { cardClass += ' st-nocturna'; headerClass += ' header-nocturna'; }
        if (currentView === 'investigacion') { cardClass += ' st-investigacion'; headerClass += ' header-investigacion'; }

        card.className = cardClass;

        card.innerHTML = `
                <div class="${headerClass}">
                    <div><strong>Factura: ${group.factura}</strong> | Cliente: ${group.cliente}</div>
                    <div>Veh√≠culo: ${group.vehiculo}</div>
                </div>
            `;

        const rowsContainer = document.createElement('div');

        group.items.forEach(it => {
          const row = document.createElement('div');
          row.className = 'item-row';
          row.id = `row-${it.id}`;

          const pctItem = parseFloat(it.merma_pct || 0).toFixed(2);
          let infoExtra = `<span><b>Operador:</b> ${it.operador_nombre || 'Desconocido'}</span>`;

          // --- LOGICA DEL BOT√ìN PDF (NUEVO) ---
          let pdfBtn = '';
          // Verificamos si existe n√∫mero de nota Y ruta del archivo
          if (it.nota_descuento && it.evidencia_nota) {
            const urlPdf = `/static/${it.evidencia_nota}`;
            // Bot√≥n estilizado para ver el PDF
            pdfBtn = `
                  <a href="${urlPdf}" target="_blank" class="btn-action" 
                     style="background:#fff; border:1px solid var(--verde); color:var(--verde); text-align:center; text-decoration:none; display:block; margin-bottom:5px; font-size:0.8rem; padding:8px;">
                     üìÑ Ver Nota ${it.nota_descuento}
                  </a>
              `;
          }

          // --- GENERACI√ìN DIN√ÅMICA DE BOTONES SEG√öN VISTA ---
          let botonesHTML = '';

          if (currentView === 'envivo') {
            // ETAPA 1 (D√çA)
            const retryAlert = it.estatus === 'segunda_revision'
              ? '<span style="color:#d97706; font-weight:bold; font-size:0.8rem; background:#fffbeb; padding:2px 5px; border-radius:4px;">‚ö†Ô∏è RECTIFICACI√ìN</span>'
              : '';

            infoExtra += retryAlert;

            botonesHTML = `
                        <button class="btn-action btn-approve" onclick="procesar(${it.id}, 'aprobar')">‚úì APROBAR</button>
                        <button class="btn-action btn-object" onclick="procesar(${it.id}, 'objetar')">‚ùå OBJETAR</button>
                    `;
          }
          else if (currentView === 'nocturna') {
            // ETAPA 2 (NOCHE - DIFERIDA)
            botonesHTML = `
                        ${pdfBtn} <div style="display:flex; gap:5px;">
                            <button class="btn-action btn-approve" style="flex:1;" onclick="procesar(${it.id}, 'aprobar')">‚úÖ VALIDAR</button>
                            <button class="btn-action btn-validate" style="flex:1;" onclick="procesar(${it.id}, 'a_investigacion')">üîç INVESTIGAR</button>
                        </div>
                    `;
          }
          else if (currentView === 'investigacion') {
            // ETAPA 3 (INVESTIGACI√ìN)
            const txtSafe = (it.testimonio_operador || '').replace(/"/g, '&quot;');
            const notaNum = it.nota_descuento || '';
            const notaUrl = it.evidencia_nota ? `/static/${it.evidencia_nota}` : '';

            botonesHTML = `
                        ${pdfBtn} <button class="btn-action btn-investigate" onclick="abrirInvestigacion(${it.id}, '${txtSafe}', '${notaNum}', '${notaUrl}')">
                           üìù GESTIONAR CASO
                        </button>
                    `;
          }

          const urlVid = it.evidencia_url1 ? `/static/${it.evidencia_url1}` : '#';
          const urlImg1 = it.evidencia_url ? `/static/${it.evidencia_url}` : '#';
          const urlImg2 = it.evidencia_url2 ? `/static/${it.evidencia_url2}` : '#';

          row.innerHTML = `
                    <div class="media-group">
                        <video class="thumb-video" src="${urlVid}" 
                               onclick="verGrande('video', this.src)" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>
                        <img class="thumb-img" src="${urlImg1}" onclick="verGrande('img', this.src)">
                        <img class="thumb-img" src="${urlImg2}" onclick="verGrande('img', this.src)">
                    </div>
                    <div class="info-group">
                        <div class="item-title">${it.item || 'Item'}</div>
                        <div class="item-meta">${infoExtra}</div>
                        <div class="merma-badge">Merma: ${it.merma_kg || 0} kg (${pctItem}%)</div>
                    </div>
                    <div class="action-group">
                        ${botonesHTML}
                    </div>
                `;
          rowsContainer.appendChild(row);
        });

        card.appendChild(rowsContainer);
        list.appendChild(card);
      });

      // Sonido solo en Envivo
      if (currentView === 'envivo' && items.length > 0) {
        try { alertSound.play(); } catch (e) { }
      }
    }

    async function procesar(id, accion) {
      if (!id) return;
      if (accion === 'objetar' && !confirm("¬øEst√° seguro de objetar? Esto devolver√° la solicitud al conductor.")) return;
      if (accion === 'aprobar' && !confirm("¬øConfirmar Aprobaci√≥n?")) return;

      const row = document.getElementById(`row-${id}`);
      if (row) row.style.opacity = '0.5';

      try {
        const res = await fetch('/mermas/accion', {
          method: 'POST',
          body: JSON.stringify({ id: id, accion: accion })
        });
        if (res.ok) setTimeout(polling, 500);
      } catch (e) {
        alert("Hubo un error al procesar la solicitud.");
        if (row) row.style.opacity = '1';
      }
    }

    function verGrande(type, src) {
      if (src.endsWith('#')) return;
      const box = document.getElementById('lightbox');
      const container = document.getElementById('lightbox-container');
      box.style.display = 'flex';
      container.innerHTML = type === 'video'
        ? `<video src="${src}" controls autoplay style="max-width:90vw; max-height:90vh"></video>`
        : `<img src="${src}" style="max-width:90vw; max-height:90vh; object-fit:contain;">`;
    }

    // === L√ìGICA MODAL DE INVESTIGACI√ìN (ETAPA 3) ===
    // === ACTUALIZACI√ìN DE LA FUNCI√ìN ABRIR INVESTIGACI√ìN ===
    function abrirInvestigacion(id, testimonioActual, notaNum, notaUrl) {
      activeInvId = id;
      document.getElementById('inv_testimonio').value = testimonioActual || '';
      document.getElementById('save_msg').innerText = '';

      // L√≥gica para mostrar la barra de la nota cr√©dito
      const infoBox = document.getElementById('inv-note-info');
      if (notaNum && notaUrl) {
        document.getElementById('inv_nc_num').innerText = notaNum;
        document.getElementById('inv_nc_link').href = notaUrl;
        infoBox.style.display = 'flex';
      } else {
        infoBox.style.display = 'none';
      }

      document.getElementById('modalInv').style.display = 'flex';
    }

    function cerrarInv() {
      document.getElementById('modalInv').style.display = 'none';
      activeInvId = null;
    }

    async function guardarTestimonio() {
      if (!activeInvId) return;
      const txt = document.getElementById('inv_testimonio').value;
      const btn = event.target;
      btn.innerText = 'Guardando...';

      try {
        const r = await fetch('/mermas/guardar_testimonio', {
          method: 'POST',
          body: JSON.stringify({ id: activeInvId, testimonio: txt })
        });
        const d = await r.json();
        if (d.success) {
          document.getElementById('save_msg').innerText = 'Guardado Correctamente ‚úÖ';
          setTimeout(() => document.getElementById('save_msg').innerText = '', 2000);
        }
      } catch (e) { alert("Error guardando"); }
      btn.innerText = 'üíæ Guardar Progreso';
    }

    async function decisionFinal(decision) {
      if (!activeInvId) return;
      const txt = document.getElementById('inv_testimonio').value;

      if (decision === 'no_conforme' && txt.length < 5) {
        alert("‚ö†Ô∏è Requerido: Para enviar a RRHH debe escribir el testimonio/descargo del operador.");
        return;
      }

      const msg = decision === 'conforme'
        ? "¬øConfirmar cierre del caso (CONFORME)?"
        : "¬øConfirmar reporte a RRHH (NO CONFORME)? Esta acci√≥n es irreversible.";

      if (!confirm(msg)) return;

      try {
        await fetch('/mermas/decision_final', {
          method: 'POST',
          body: JSON.stringify({
            id: activeInvId,
            decision: decision,
            comentario: "Gesti√≥n desde Panel"
          })
        });
        cerrarInv();
        polling();
      } catch (e) { alert("Error de conexi√≥n"); }
    }

    // === L√ìGICA MODAL DE INFORMES (SIMPLIFICADO) ===
    const modal = document.getElementById('modalConsultas');
    const report = document.getElementById('report');
    let chartRef = null;

    // BOT√ìN "INFORMES" DEL MEN√ö LATERAL
    document.getElementById('btnOpenConsultas').onclick = () => {
      modal.style.display = 'flex';

      // 1. Cargar lista de veh√≠culos
      loadVehiculosOptions();

      // 2. Por defecto seleccionamos "√öltima Ruta" (Hoy)
      setRangoRapido('ruta', document.getElementById('btnRuta'));
    };

    function closeModal() { modal.style.display = 'none'; }
    document.getElementById('btnCloseModal').onclick = closeModal;
    document.getElementById('btnCerrar').onclick = closeModal;

    // NUEVA FUNCI√ìN PARA GESTIONAR LOS BOTONES DE TIEMPO
    function setRangoRapido(tipo, btnElement) {
      // 1. Gesti√≥n visual (clase active)
      document.querySelectorAll('#modalConsultas .pill').forEach(b => b.classList.remove('active'));
      if (btnElement) btnElement.classList.add('active');

      // 2. C√°lculo de fechas
      const hoy = new Date();
      const fmt = d => {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      let fechaInicio = new Date(hoy);

      if (tipo === 'ruta') {
        // √öltima ruta = Hoy (Asumimos operaci√≥n en curso o reci√©n terminada)
        // Si quisieras "Ayer", cambiar√≠as 0 por 1 abajo
        fechaInicio.setDate(hoy.getDate() - 0);
      } else if (tipo === 'semana') {
        fechaInicio.setDate(hoy.getDate() - 7);
      } else if (tipo === 'mes') {
        fechaInicio.setDate(hoy.getDate() - 30);
      }

      // 3. Asignar a los inputs ocultos
      document.getElementById('fDesde_ve').value = fmt(fechaInicio);
      document.getElementById('fHasta_ve').value = fmt(hoy);
    }

    async function loadVehiculosOptions() {
      const sel = document.getElementById('qVehiculo');
      sel.innerHTML = '<option value="">Cargando...</option>';
      try {
        const r = await fetch(`/mermas/opciones?tipo=vehiculo`);
        const j = await r.json();
        sel.innerHTML = '<option value="">Todos los veh√≠culos</option>';
        if (j.success && j.items) {
          j.items.forEach(v => sel.innerHTML += `<option value="${v}">${v}</option>`);
        }
      } catch (e) {
        sel.innerHTML = '<option value="">Error al cargar</option>';
      }
    }

    // GENERAR INFORME (Siempre fuerza tipo 'vehiculo')
    document.getElementById('btnEjecutarConsulta').onclick = async () => {
      const vehiculo = document.getElementById('qVehiculo').value;
      const desde = document.getElementById('fDesde_ve').value;
      const hasta = document.getElementById('fHasta_ve').value;

      if (!desde || !hasta) return alert("Por favor seleccione el rango de fechas.");

      const payload = {
        tipo: 'vehiculo', // Hardcodeado: Solo nos interesa este tipo
        vehiculo: vehiculo,
        desde: desde,
        hasta: hasta
      };

      const btn = document.getElementById('btnEjecutarConsulta');
      const originalText = btn.innerText;
      btn.innerText = "Generando...";
      btn.disabled = true;

      try {
        const r = await fetch('/mermas/consulta', { method: 'POST', body: JSON.stringify(payload) });
        const data = await r.json();

        if (data.success) {
          closeModal();

          // === CAMBIO CR√çTICO AQU√ç ===
          // Guardamos la placa elegida dentro de los datos para que el reporte sepa de qui√©n es
          data.placa = vehiculo; 
          // ===========================

          renderReport(data);
        } else {
          alert("No se encontraron datos para ese rango.");
        }
      } catch (e) {
        console.error(e);
        alert("Error de conexi√≥n");
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    };

    function renderReport(data) {
      document.getElementById('list').innerHTML = '';
      document.getElementById('empty').style.display = 'none';

      // 1. PROCESAMIENTO DE DATOS (CURVAS POR D√çA)
      const viajes = {};

      data.operaciones.forEach(op => {
        // op.fecha viene como "YYYY-MM-DD HH:MM:SS"
        // Ejemplo: "2026-01-28 08:20:00"

        if (!op.fecha || op.fecha.length < 16) return; // Validaci√≥n seguridad

        const fechaKey = op.fecha.substring(0, 10); // "2026-01-28"

        // PARSEO MANUAL DE HORA (M√°s robusto que new Date())
        // Extraemos caracteres de hora y minutos directamente del string
        const hh = parseInt(op.fecha.substring(11, 13));
        const mm = parseInt(op.fecha.substring(14, 16));

        // Convertimos a decimal (Ej: 08:30 -> 8.5)
        const horaDecimal = hh + (mm / 60.0);

        if (!viajes[fechaKey]) viajes[fechaKey] = [];

        viajes[fechaKey].push({
          x: horaDecimal,
          y: parseFloat(op.merma_pct || 0),
          cliente: op.cliente,
          factura: op.factura
        });
      });

      // 2. CONSTRUIR DATASETS (L√çNEAS)
      const datasets = [];
      // Colores vivos para diferenciar d√≠as
      const colores = ['#006d77', '#e63946', '#f4a261', '#2a9d8f', '#264653', '#e76f51', '#457b9d'];
      let colorIdx = 0;

      // Ordenar fechas para que la leyenda salga cronol√≥gica
      Object.keys(viajes).sort().forEach(fecha => {
        // Ordenar puntos por hora (para que la l√≠nea no retroceda)
        viajes[fecha].sort((a, b) => a.x - b.x);

        datasets.push({
          label: fecha, // Cada d√≠a es una l√≠nea
          data: viajes[fecha],
          borderColor: colores[colorIdx % colores.length],
          backgroundColor: colores[colorIdx % colores.length],
          borderWidth: 3,
          pointRadius: 5,
          pointHoverRadius: 8,
          fill: false,
          tension: 0.3 // Curva suave
        });
        colorIdx++;
      });

      // 3. RENDER HTML
      report.innerHTML = `
            <div class="report-head">
                <div>
                   <h3 style="margin:0 0 5px 0; color:var(--verde);">üìà Evoluci√≥n T√©rmica - ${data.placa || 'Veh√≠culo'}</h3>
                   <div style="font-size:0.9rem; color:#666;">
                     An√°lisis de la merma a lo largo del turno (Hora vs %)
                   </div>
                </div>
                <div style="text-align:right;">
                     <button id="btnPDF" class="btn primary" style="margin-bottom:5px;">üì• Descargar PDF</button><br>
                     <span class="stat-badge">Total: ${data.resumen.kg_totales} kg</span>
                     <span class="stat-badge" style="background:#fff5f5; color:#c53030; border-color:#feb2b2;">Merma Global: ${data.resumen.merma_pct_total.toFixed(2)}%</span>
                </div>
            </div>

            <div class="chart-box">
                <div style="height:400px;">
                    <canvas id="cvMerma"></canvas>
                </div>
                <div style="font-size:0.8rem; color:#666; text-align:center; margin-top:10px; font-weight:bold;">
                    HORA DEL D√çA (EJE X)
                </div>
            </div>

            <div class="chart-box">
                <div style="max-height:300px; overflow-y:auto;">
                    <table class="tbl">
                        <thead><tr><th>Hora</th><th>Fecha</th><th>Cliente</th><th>Kg Ent</th><th>Merma</th><th>%</th></tr></thead>
                        <tbody>
                            ${data.operaciones.map(o => {
        const horaStr = o.fecha.substring(11, 16);
        const fechaStr = o.fecha.substring(0, 10);
        const pct = parseFloat(o.merma_pct).toFixed(2);
        return `<tr><td><b>${horaStr}</b></td><td>${fechaStr}</td><td>${o.cliente.substring(0, 20)}</td><td>${o.kg_entregados}</td><td style="color:#b00020">${o.merma_kg}</td><td><b>${pct}%</b></td></tr>`;
      }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            <button onclick="location.reload()" class="btn secondary" style="margin-top:20px;">Volver</button>
        `;

      // 4. INICIALIZAR CHART.JS
      if (chartRef) chartRef.destroy();

      chartRef = new Chart(document.getElementById('cvMerma'), {
        type: 'line',
        data: { datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'linear',
              position: 'bottom',
              min: 5,  // Desde las 5 AM
              max: 22, // Hasta las 10 PM
              title: { display: true, text: 'Hora (Formato 24h)' },
              ticks: { stepSize: 1, callback: v => v + ':00' }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: '% de Merma' }
            }
          },
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                title: ctx => `Hora: ${Math.floor(ctx[0].raw.x)}:${Math.round((ctx[0].raw.x % 1) * 60).toString().padStart(2, '0')}`,
                label: ctx => `${ctx.dataset.label}: ${ctx.raw.y.toFixed(2)}% (${ctx.raw.cliente})`
              }
            }
          }
        }
      });

      // 5. DESCARGA PDF (NOMBRE CORRECTO)
      document.getElementById('btnPDF').onclick = async () => {
        const btn = document.getElementById('btnPDF');
        btn.innerText = "Generando...";
        btn.disabled = true;

        try {
          const placaClean = (data.placa || 'Vehiculo').toUpperCase().trim().replace(/\s+/g, '_');
          const pdfPayload = {
            ...data,
            chart_png: chartRef.toBase64Image(),
            filename: `mermas_${placaClean}.pdf`, // Nombre solicitado
            titulo: `Reporte Operativo - ${placaClean}`
          };

          const r = await fetch('/mermas/consulta/pdf', { method: 'POST', body: JSON.stringify(pdfPayload) });
          const blob = await r.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = pdfPayload.filename;
          a.click();
        } catch (e) {
          alert("Error generando PDF");
        } finally {
          btn.innerText = "üì• Descargar PDF";
          btn.disabled = false;
        }
      };
    }

    // === FUNCIONES DE FLUJO DE TRABAJO ===

    // ACCI√ìN 1: Listado detallado del d√≠a anterior (PDF)
    function descargarReporteDiaAnterior() {
      const ayer = new Date();
      ayer.setDate(ayer.getDate() - 1);
      const fechaStr = ayer.toISOString().split('T')[0];

      if (confirm(`¬øGenerar reporte detallado de Mermas Bajos Impacto (<=2%) del d√≠a ${fechaStr}?`)) {
        window.open(`/mermas/reporte_controlador_diario?fecha=${fechaStr}`, '_blank');
      }
    }

    // ACCI√ìN 2: PDF Masivo de Notas Cr√©dito
    function descargarNotasMasivas() {
      const ayer = new Date();
      ayer.setDate(ayer.getDate() - 1);
      const fechaStr = ayer.toISOString().split('T')[0];

      if (confirm(`¬øDescargar TODAS las Notas Cr√©dito (PDF unificado) del d√≠a ${fechaStr}?`)) {
        window.open(`/mermas/notas_masivas_diario?fecha=${fechaStr}`, '_blank');
      }
    }

    // ACCIONES 3, 4, 5, 6: Navegaci√≥n inteligente
    // ACCIONES DE NAVEGACI√ìN INTELIGENTE
    function activarFlujo(paso) {
      if (paso === 3) {
        // Ir a revisi√≥n nocturna
        // El √≠ndice [1] corresponde al segundo bot√≥n del sidebar (Rev. Nocturna)
        cambiarVista('nocturna', document.querySelectorAll('.side-btn')[1]);
        alert("PASO 3: Revise la lista de 'Revisi√≥n Nocturna'.\n\n- Use 'Validar' si la evidencia es correcta.\n- Use 'A Investigaci√≥n' si tiene dudas o requiere explicaci√≥n.");
      }
      else if (paso === 'investigacion') {
        // Ir a investigaciones (Unificado)
        // El √≠ndice [2] corresponde al tercer bot√≥n del sidebar (Investigaci√≥n)
        cambiarVista('investigacion', document.querySelectorAll('.side-btn')[2]);
        alert("PASO 4 (INVESTIGACIONES):\n\nAqu√≠ est√°n los casos pendientes de explicaci√≥n.\n1. Contacte al operador (Citar).\n2. Haga clic en 'Gestionar Caso' para escribir el testimonio y decidir.");
      }
    }

    // === L√ìGICA REPORTE DE VENTAS (INFO 1, 2 y 3) ===

    function abrirModalReporteVentas() {
      // Pre-seleccionar "Ayer" por defecto
      setFechas('ayer');
      document.getElementById('modalFechasReporte').style.display = 'flex';
    }

    function cerrarModalFechas() {
      document.getElementById('modalFechasReporte').style.display = 'none';
    }

    function setFechas(tipo) {
      const hoy = new Date();
      const inicio = document.getElementById('rep_inicio');
      const fin = document.getElementById('rep_fin');

      // Funci√≥n auxiliar para formato YYYY-MM-DD local
      const fmt = d => {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      if (tipo === 'hoy') {
        inicio.value = fmt(hoy);
        fin.value = fmt(hoy);
      } else if (tipo === 'ayer') {
        const ayer = new Date(hoy);
        ayer.setDate(hoy.getDate() - 1);
        inicio.value = fmt(ayer);
        fin.value = fmt(ayer);
      } else if (tipo === 'mes') {
        const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        inicio.value = fmt(primerDia);
        fin.value = fmt(hoy);
      }
    }

    function generarReporteFinal() {
      const ini = document.getElementById('rep_inicio').value;
      const f = document.getElementById('rep_fin').value;

      if (!ini || !f) return alert("Seleccione fechas v√°lidas.");

      // Abrir PDF en nueva pesta√±a
      const url = `/mermas/reporte_ventas_avanzado?inicio=${ini}&fin=${f}`;
      window.open(url, '_blank');
      cerrarModalFechas();
    }

    // === L√ìGICA DE BUSCADOR DE NOTAS CR√âDITO ===

    function abrirModalNotas() {
      // 1. Pre-seleccionar fechas (Ayer por defecto)
      setFechasNC('ayer');

      // 2. Cargar lista de operadores si est√° vac√≠a
      const sel = document.getElementById('nc_operador_sel');
      if (sel.options.length <= 1) {
        cargarOperadoresEnSelect();
      }

      // 3. Limpiar tabla
      document.getElementById('nc_tabla_resultados').innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#666;">Presione "BUSCAR" para ver resultados.</td></tr>';

      document.getElementById('modalBuscadorNotas').style.display = 'flex';
    }

    function cerrarModalNotas() {
      document.getElementById('modalBuscadorNotas').style.display = 'none';
    }

    async function cargarOperadoresEnSelect() {
      try {
        const r = await fetch(`/mermas/opciones?tipo=vendedor`); // Reutilizamos tu API existente
        const j = await r.json();
        const sel = document.getElementById('nc_operador_sel');
        if (j.success) {
          j.items.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op;
            opt.innerText = op;
            sel.appendChild(opt);
          });
        }
      } catch (e) { console.error("Error cargando operadores", e); }
    }

    function setFechasNC(tipo) {
      const hoy = new Date();
      const inicio = document.getElementById('nc_desde');
      const fin = document.getElementById('nc_hasta');

      const fmt = d => d.toISOString().split('T')[0]; // Formato YYYY-MM-DD

      if (tipo === 'hoy') {
        inicio.value = fmt(hoy);
        fin.value = fmt(hoy);
      } else if (tipo === 'ayer') {
        const ayer = new Date(hoy);
        ayer.setDate(hoy.getDate() - 1);
        inicio.value = fmt(ayer);
        fin.value = fmt(ayer);
      } else if (tipo === 'mes') {
        const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        inicio.value = fmt(primerDia);
        fin.value = fmt(hoy);
      }
    }

    async function buscarNotasCredito() {
      const desde = document.getElementById('nc_desde').value;
      const hasta = document.getElementById('nc_hasta').value;
      const operador = document.getElementById('nc_operador_sel').value;
      const tbody = document.getElementById('nc_tabla_resultados');
      const statusBar = document.getElementById('nc_status_bar');

      if (!desde || !hasta) return alert("Seleccione rango de fechas.");

      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">‚è≥ Buscando...</td></tr>';

      try {
        const r = await fetch('/mermas/buscar_notas_historial', {
          method: 'POST',
          body: JSON.stringify({ desde, hasta, operador })
        });
        const data = await r.json();

        if (data.success) {
          if (data.notas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No se encontraron notas en ese periodo.</td></tr>';
            statusBar.innerText = "0 resultados";
            return;
          }

          let html = '';
          data.notas.forEach(n => {
            // Bot√≥n: Si hay URL, muestra PDF. Si no, muestra alerta.
            const btnAccion = n.url
              ? `<a href="${n.url}" target="_blank" class="btn primary" style="padding:5px 10px; font-size:0.75rem; text-decoration:none;">üëÅÔ∏è VER PDF</a>`
              : `<span style="color:#999; font-size:0.8rem;">(Sin PDF)</span>`;

            html += `
                    <tr>
                        <td style="font-weight:bold; color:#b91c1c;">${n.nota}</td>
                        <td>${n.fecha.substring(0, 16)}</td>
                        <td>${n.factura}</td>
                        <td>${n.cliente.substring(0, 20)}</td>
                        <td style="font-size:0.8rem;">${n.operador.substring(0, 15)}</td>
                        <td style="text-align:center;">${btnAccion}</td>
                    </tr>
                `;
          });
          tbody.innerHTML = html;
          statusBar.innerText = `${data.notas.length} notas encontradas.`;
        } else {
          alert("Error: " + data.message);
        }
      } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Error de conexi√≥n.</td></tr>';
      }
    }
  </script>
</body>

</html>