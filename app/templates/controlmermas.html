<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Control de Mermas - BQA ONE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="apple-touch-icon" href="/static/icon-192.png">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#015249">

  <script src="/static/js/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* ================= ESTILOS GENERALES ================= */
    :root {
      --verde: #015249;
      --verde-dark: #013d36;
      --gris: #f6f7f8;
      --txt: #111827;
      --muted: #6b7280;
      --ok: #15803d;
      --warn: #b8860b;
      --no: #b00020;
      --bord: #e5e7eb;
      --bg: #ffffff;
      --orange: #f97316;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: Verdana, sans-serif;
      background: radial-gradient(circle at top, #d7f2ec 0, #f6f7f8 45%, #f6f7f8 100%);
      margin: 0;
      color: var(--txt);
      min-height: 100vh;
    }

    /* ================= LAYOUT ================= */
    .layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    /* ================= SIDEBAR ================= */
    .sidebar {
      background: var(--verde-dark);
      color: #fff;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: sticky;
      top: 0;
      height: 100vh;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }

    .side-title {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 20px;
      text-align: center;
    }

    .side-btn {
      background: #0d4e47;
      color: #eaf7f6;
      border: 1px solid rgba(0, 0, 0, .1);
      border-radius: 8px;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }

    .side-btn:hover {
      background: #0f5c53;
    }

    .side-btn.active {
      background: #eaf7f6;
      color: var(--verde);
      border-color: white;
    }

    .side-btn.logout {
      background: #a50e1d;
      margin-top: auto;
      border-color: #8d0c19;
      text-decoration: none;
      display: block;
      text-align: center;
      color: white;
    }

    .brand {
      margin-top: 10px;
      font-size: 11px;
      opacity: 0.7;
      text-align: center;
    }

    /* ================= CONTENIDO PRINCIPAL ================= */
    .wrap {
      padding: 24px;
      overflow-y: auto;
      height: 100vh;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(5px);
      border-radius: 12px;
      padding: 10px 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .logo {
      height: 40px;
      object-fit: contain;
    }

    h1 {
      color: var(--verde);
      font-size: 22px;
      margin: 0 0 5px 0;
    }

    .subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 20px;
    }

    /* ================= TARJETAS DE FACTURA ================= */
    .invoice-card {
      background: var(--bg);
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-bottom: 25px;
      overflow: hidden;
      border: 1px solid var(--bord);
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .invoice-header {
      background: var(--verde);
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
    }

    /* ================= FILA DE √çTEM ================= */
    .item-row {
      display: grid;
      grid-template-columns: 320px 1fr 200px;
      gap: 20px;
      padding: 15px 20px;
      border-bottom: 1px solid var(--bord);
      align-items: center;
      background: #fff;
      transition: opacity 0.3s;
    }

    .item-row:last-child {
      border-bottom: none;
    }

    .item-row:hover {
      background: #f9fafb;
    }

    /* ================= MULTIMEDIA ================= */
    .media-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .thumb-video {
      width: 120px;
      height: 80px;
      background: #000;
      border-radius: 6px;
      object-fit: contain;
      cursor: pointer;
      border: 1px solid #ddd;
    }

    .thumb-img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid #ddd;
      transition: transform 0.2s;
    }

    .thumb-img:hover,
    .thumb-video:hover {
      transform: scale(1.05);
      border-color: var(--verde);
    }

    /* ================= INFO ================= */
    .info-group {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .item-title {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--verde);
      margin-bottom: 6px;
    }

    .item-meta {
      font-size: 0.9rem;
      color: #4b5563;
    }

    .merma-badge {
      background: #fee2e2;
      color: #991b1b;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 1rem;
      margin-top: 8px;
      display: inline-block;
      width: fit-content;
      border: 1px solid #fecaca;
    }

    /* ================= BOTONES ACCI√ìN ================= */
    .action-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .btn-action {
      border: none;
      padding: 12px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      color: white;
      transition: opacity 0.2s;
      font-size: 0.85rem;
      text-align: center;
      font-family: Verdana, sans-serif;
    }

    .btn-action:hover {
      opacity: 0.9;
    }

    .btn-approve {
      background: var(--ok);
    }

    .btn-object {
      background: var(--orange);
    }

    .btn-reject {
      background: transparent;
      color: var(--no);
      border: 1px solid var(--no);
      padding: 8px;
      font-size: 0.75rem;
      margin-top: 5px;
    }

    .btn-reject:hover {
      background: #fef2f2;
    }

    /* ================= EMPTY STATE ================= */
    .empty-state {
      text-align: center;
      padding: 50px;
      color: #9ca3af;
      font-size: 1.2rem;
    }

    /* ================= LIGHTBOX ================= */
    #lightbox {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }

    /* ================= MODAL DE VALIDACI√ìN / AUDITOR√çA ================= */
    .validation-modal {
      display: none; /* Oculto por defecto */
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }

    .val-card {
      background: white;
      width: 100%;
      max-width: 900px;
      border-radius: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }

    .val-header {
      background: #0f766e;
      color: white;
      padding: 15px 20px;
      font-weight: bold;
      font-size: 1.1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .val-body {
      padding: 20px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .val-media {
      background: #000;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      border-radius: 8px;
      align-items: center;
      justify-content: center;
    }

    .val-media video {
      width: 100%;
      max-height: 300px;
      background: #000;
      object-fit: contain;
    }

    .val-thumbs {
        display: flex;
        gap: 10px;
        width: 100%;
        justify-content: center;
    }

    .val-thumbs img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border: 2px solid #fff;
        cursor: pointer;
        border-radius: 6px;
        transition: transform 0.2s;
    }
    
    .val-thumbs img:hover {
        transform: scale(1.1);
    }

    .val-form h3 {
      margin-top: 0;
      font-size: 1.2rem;
      color: var(--verde);
    }

    .val-form p {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 10px;
    }

    .val-form textarea {
      width: 100%;
      height: 200px;
      padding: 12px;
      border: 1px solid var(--bord);
      border-radius: 6px;
      resize: none;
      font-family: inherit;
      font-size: 0.95rem;
      margin-top: 10px;
    }

    .val-actions {
      padding: 20px;
      background: #f8fafc;
      border-top: 1px solid var(--bord);
      display: flex;
      gap: 15px;
      justify-content: flex-end;
    }

    /* ================= MODAL DE CONSULTAS / REPORTES ================= */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 15px;
    }

    .modal {
      width: min(800px, 95vw);
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }

    .modal-head {
      padding: 15px 20px;
      background: #f9fafb;
      border-bottom: 1px solid var(--bord);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-weight: 700;
      color: var(--verde);
      font-size: 16px;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 20px;
    }

    .pill {
      display: block;
      width: 100%;
      text-align: left;
      padding: 12px;
      margin-bottom: 5px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      color: #555;
      font-size: 12px;
    }

    .pill:hover {
      background: #f0fdf9;
      color: var(--verde);
    }

    .pill.active {
      background: #e0f7fa;
      color: var(--verde);
      border-color: #b2dfdb;
    }

    .sec {
      background: #f8fafc;
      border: 1px solid var(--bord);
      border-radius: 8px;
      padding: 15px;
    }

    .sec h3 {
      margin-top: 0;
      font-size: 14px;
      color: var(--verde);
    }

    .inp {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--bord);
      border-radius: 6px;
      margin-bottom: 10px;
      font-family: Verdana;
      font-size: 13px;
    }

    .modal-foot {
      padding: 15px 20px;
      border-top: 1px solid var(--bord);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background: #f9fafb;
    }

    .btn {
      padding: 10px 18px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
    }

    .btn.primary {
      background: var(--verde);
      color: #fff;
    }

    .btn.secondary {
      background: #fff;
      border: 1px solid var(--bord);
      color: #333;
    }

    /* ESTILOS DE REPORTE GENERADO */
    .report-head {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--bord);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .stat-badge {
      background: #e6fffa;
      color: var(--verde-dark);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 11px;
      border: 1px solid #b2f5ea;
      margin-right: 5px;
    }

    .chart-box {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--bord);
      margin-top: 20px;
    }

    .tbl {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .tbl th {
      background: #f1f5f9;
      padding: 10px;
      text-align: left;
      color: #555;
      font-weight: bold;
      border-bottom: 2px solid var(--bord);
    }

    .tbl td {
      padding: 10px;
      border-bottom: 1px solid var(--bord);
    }

    /* RESPONSIVE MEDIA QUERIES */
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .sidebar {
        flex-direction: row;
        height: auto;
        align-items: center;
        overflow-x: auto;
      }

      .side-btn {
        white-space: nowrap;
        margin: 0 5px;
      }

      .modal-body {
        grid-template-columns: 1fr;
      }

      .item-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .media-group {
        justify-content: center;
      }

      .action-group {
        flex-direction: row;
      }
      
      .val-body {
          grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="side-title">Control Mermas</div>
      
      <button class="side-btn active" onclick="cambiarVista('pending', this)">üìã Aprobaciones</button>
      <button class="side-btn" onclick="cambiarVista('review', this)">üïµÔ∏è Investigaci√≥n NC</button>
      <button id="btnOpenConsultas" class="side-btn">üìä Informes</button>
      
      <a class="side-btn logout" href="/logout">‚èª Salir</a>
      <div class="brand">Energix-360</div>
    </aside>

    <main class="wrap">
      <div class="header">
        <img src="{{ url_for('static', filename='logo_' + session['empresa'] + '.png') }}" class="logo" onerror="this.style.display='none'">
        <img src="{{ url_for('static', filename='logo_energix360.png') }}" class="logo">
      </div>

      <div>
        <h1 id="page-title">Gesti√≥n de Mermas</h1>
        <div class="subtitle">Administraci√≥n de solicitudes y generaci√≥n de informes.</div>
      </div>

      <div id="list"></div>
      
      <div id="empty" style="display:none;" class="empty-state">
        ‚úÖ Todo al d√≠a.
      </div>

      <div id="report"></div>
    </main>
  </div>

  <div id="lightbox" onclick="this.style.display='none'"><div id="lightbox-container"></div></div>

  <div id="modalValidacion" class="validation-modal">
    <div class="val-card">
        <div class="val-header">
            <span>AUDITOR√çA Y VALIDACI√ìN</span>
            <button onclick="cerrarValidacion()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div class="val-body">
            <div class="val-media">
                <video id="v_video" controls></video>
                <div class="val-thumbs">
                    <img id="v_img1" onclick="verGrande('img', this.src)">
                    <img id="v_img2" onclick="verGrande('img', this.src)">
                </div>
            </div>
            
            <div class="val-form">
                <h3>Hechos y Argumentos</h3>
                <p>Escriba los detalles de la investigaci√≥n. Si decide rechazar, este texto se enviar√° por correo al √°rea de Talento Humano.</p>
                <textarea id="v_argumentos" placeholder="Describa los hallazgos de la auditor√≠a y la justificaci√≥n de la decisi√≥n..."></textarea>
                
                <div style="margin-top:15px; font-size:0.8rem; color:#d97706; background:#fffbeb; padding:10px; border-radius:6px; border:1px solid #fcd34d;">
                    <b>‚ö† Nota Importante:</b>
                    <ul style="margin:5px 0; padding-left:20px;">
                        <li><b>Conforme:</b> Cierra el caso como validado y borra evidencias.</li>
                        <li><b>No Conforme:</b> Env√≠a email con evidencias a Talento Humano y luego las borra del sistema.</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="val-actions">
            <button class="btn-action" style="background:#b91c1c; width:auto; padding:12px 25px;" onclick="enviarValidacion('no_conforme')">‚úñ NO CONFORME</button>
            <button class="btn-action" style="background:#15803d; width:auto; padding:12px 25px;" onclick="enviarValidacion('conforme')">‚úî CONFORME</button>
        </div>
    </div>
  </div>

  <div id="modalConsultas" class="modal-backdrop">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">Consultar Mermas</div>
        <button class="btn secondary" id="btnCloseModal">‚úï</button>
      </div>
      <div class="modal-body">
        <div>
          <button class="pill active" data-section="zona">Por Zona</button>
          <button class="pill" data-section="vendedor">Por Vendedor</button>
          <button class="pill" data-section="cliente">Por Cliente</button>
          <button class="pill" data-section="vehiculo">Por Veh√≠culo</button>
        </div>
        <div>
          <div class="sec sec-zona">
            <h3>Filtros de Zona</h3>
            <select id="qZona" class="inp"><option value="">Selecciona...</option></select>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <input id="fDesde_z" type="date" class="inp"> <input id="fHasta_z" type="date" class="inp">
            </div>
          </div>
          <div class="sec sec-vendedor" style="display:none;">
            <h3>Filtros de Vendedor</h3>
            <select id="qVendedor" class="inp"><option value="">Selecciona...</option></select>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <input id="fDesde_v" type="date" class="inp"> <input id="fHasta_v" type="date" class="inp">
            </div>
          </div>
          <div class="sec sec-cliente" style="display:none;">
            <h3>Filtros de Cliente</h3>
            <select id="qCliente" class="inp"><option value="">Selecciona...</option></select>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <input id="fDesde_c" type="date" class="inp"> <input id="fHasta_c" type="date" class="inp">
            </div>
          </div>
          <div class="sec sec-vehiculo" style="display:none;">
            <h3>Filtros de Veh√≠culo</h3>
            <select id="qVehiculo" class="inp"><option value="">Selecciona...</option></select>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <input id="fDesde_ve" type="date" class="inp"> <input id="fHasta_ve" type="date" class="inp">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn secondary" id="btnCerrar">Cancelar</button>
        <button class="btn primary" id="btnEjecutarConsulta">Generar</button>
      </div>
    </div>
  </div>

  <audio id="alert-sound" src="/static/alert.mp3" preload="auto"></audio>

  <script>
    const list = document.getElementById("list");
    const empty = document.getElementById("empty");
    const alertSound = document.getElementById('alert-sound');
    
    let currentView = 'pending'; 
    let lastDataStr = "";
    
    // Almacena datos del √≠tem activo para el modal de auditor√≠a
    let activeItemData = null;

    // === CONFIGURACI√ìN DE POLLING Y HORARIO ===
    // Configurado para: Intervalo de 15 segundos y horario de 4:00 AM a 10:00 PM
    const HORA_INICIO = 4;   // 4:00 AM
    const HORA_FIN = 17;     // 5:00 PM (17:00)
    const INTERVALO = 15000; // 15 Segundos

    function cambiarVista(vista, btn) {
        currentView = vista;
        document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');

        const title = document.getElementById('page-title');
        title.innerText = vista === 'pending' ? 'Gesti√≥n de Mermas' : 'Investigaci√≥n No Conformes';
        title.style.color = vista === 'pending' ? 'var(--verde)' : '#b45309';

        list.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">Cargando...</div>';
        lastDataStr = "";
        
        // Ejecutar polling inmediatamente al cambiar de vista
        polling();
    }

    async function polling() {
      // === 1. CHEQUEO DE HORARIO (AHORRO RECURSOS) ===
      const ahora = new Date();
      const horaActual = ahora.getHours();

      // Si estamos fuera del horario laboral, detenemos la petici√≥n
      if (horaActual < HORA_INICIO || horaActual >= HORA_FIN) {
          console.log("üí§ Sistema en reposo nocturno (Fuera de horario).");
          if(list.innerHTML === "" || list.innerHTML.includes("Cargando")) {
             list.innerHTML = '<div class="empty-state">üí§ Sistema en reposo nocturno (4:00 AM - 10:00 PM)</div>';
          }
          return; 
      }

      // === 2. L√ìGICA NORMAL DE CONSULTA ===
      try {
        const url = currentView === 'pending' 
            ? '/mermas/pending?t=' + Date.now() 
            : '/mermas/review_list?t=' + Date.now();

        const r = await fetch(url);
        const data = await r.json();
        
        const currentDataStr = JSON.stringify(data.items);
        if (currentDataStr === lastDataStr) return;
        lastDataStr = currentDataStr;

        if (data.success && data.items && data.items.length > 0) {
            renderDashboard(data.items);
            empty.style.display = 'none';
        } else {
            list.innerHTML = '';
            empty.style.display = 'block';
            empty.innerText = currentView === 'pending' 
                ? '‚úÖ Todo al d√≠a. No hay solicitudes pendientes.' 
                : '‚úÖ Excelente. No hay casos pendientes de investigaci√≥n.';
        }
      } catch (e) { console.error(e); }
    }
    
    // Iniciar el ciclo de polling
    setInterval(polling, INTERVALO);
    // Ejecutar una vez al cargar la p√°gina
    polling();

    function renderDashboard(items) {
        const groups = {};
        items.forEach(it => {
            if (!groups[it.factura]) {
                groups[it.factura] = { factura: it.factura, cliente: it.cliente, vehiculo: it.vehiculo, items: [] };
            }
            groups[it.factura].items.push(it);
        });

        list.innerHTML = ''; 

        Object.values(groups).forEach(group => {
            const card = document.createElement('div');
            card.className = 'invoice-card';
            
            const headerStyle = currentView === 'review' ? 'background:#b45309;' : '';
            
            card.innerHTML = `
                <div class="invoice-header" style="${headerStyle}">
                    <div><strong>Factura: ${group.factura}</strong> | Cliente: ${group.cliente}</div>
                    <div>Veh√≠culo: ${group.vehiculo}</div>
                </div>
            `;

            const rowsContainer = document.createElement('div');

            group.items.forEach(it => {
                const row = document.createElement('div');
                row.className = 'item-row';
                row.id = `row-${it.id}`;

                const pctItem = parseFloat(it.merma_pct).toFixed(2);
                let pctTotal = "0.00";
                
                if (it.total_factura_kg && parseFloat(it.total_factura_kg) > 0) {
                    pctTotal = ((parseFloat(it.merma_kg) / parseFloat(it.total_factura_kg)) * 100).toFixed(4);
                }

                const infoExtra = currentView === 'review' 
                    ? `
                    <div style="font-size:0.8rem; background:#fef3c7; padding:8px; border-radius:6px; margin-top:5px; border:1px solid #fcd34d; color:#92400e;">
                       <div><b>Vendedor:</b> ${it.operador_nombre}</div>
                       <div><b>Nota:</b> ${it.nota_descuento || 'Pendiente'}</div>
                       <div style="margin-top:5px; border-top:1px solid #fcd34d; padding-top:4px;">
                           % vs √çtem: <b>${pctItem}%</b> <br>
                           % vs Total Factura: <b>${pctTotal}%</b>
                       </div>
                    </div>
                    ` 
                    : `<span><b>Operador:</b> ${it.operador_nombre}</span>`;

                // --- BOTONES ---
                let botonesHTML = '';
                if (currentView === 'pending') {
                    // Vista Normal: Solo APROBAR u OBJETAR
                    botonesHTML = `
                        <button class="btn-action btn-approve" onclick="procesar(${it.id}, 'aprobar')">‚úì APROBAR</button>
                        <button class="btn-action btn-object" onclick="procesar(${it.id}, 'objetar')">‚ö†Ô∏è OBJETAR</button>
                    `;
                } else {
                    // Vista Investigaci√≥n: Solo VALIDADO (Abre Modal)
                    // Convertimos el objeto item a string seguro para pasarlo a la funci√≥n
                    const itemJson = JSON.stringify(it).replace(/"/g, '&quot;');
                    botonesHTML = `
                        <button class="btn-action" style="background:#0f766e;" onclick="abrirValidacion(${itemJson})">
                           üßê VALIDAR
                        </button>
                    `;
                }
                
                const isRetry = it.estatus === 'segunda_revision';
                const retryAlert = isRetry ? '<div style="color:#d97706; font-weight:bold; font-size:0.8rem; background:#fffbeb; padding:2px 5px; border-radius:4px;">‚ö†Ô∏è SEGUNDO INTENTO (RECTIFICADO)</div>' : '';

                row.innerHTML = `
                    <div class="media-group">
                        <video class="thumb-video" src="/static/${it.evidencia_url1}" 
                               onclick="verGrande('video', this.src)" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>
                        <img class="thumb-img" src="/static/${it.evidencia_url}" onclick="verGrande('img', this.src)">
                        <img class="thumb-img" src="/static/${it.evidencia_url2}" onclick="verGrande('img', this.src)">
                    </div>
                    <div class="info-group">
                        <div class="item-title">${it.item} ${retryAlert}</div>
                        <div class="item-meta">${infoExtra}</div>
                        <div class="merma-badge">Merma: ${it.merma_kg} kg (${pctItem}%)</div>
                    </div>
                    <div class="action-group">
                        ${botonesHTML}
                    </div>
                `;
                rowsContainer.appendChild(row);
            });

            card.appendChild(rowsContainer);
            list.appendChild(card);
        });
        
        if(currentView === 'pending' && items.length > 0) { 
            try { alertSound.play(); } catch(e){} 
        }
    }

    async function procesar(id, accion) {
        const row = document.getElementById(`row-${id}`);
        if(row) {
            row.style.opacity = '0.5';
        }

        await fetch('/mermas/accion', {
            method: 'POST', 
            body: JSON.stringify({ id: id, accion: accion }) 
        });
        
        setTimeout(polling, 500); 
    }

    function verGrande(type, src) {
        const box = document.getElementById('lightbox');
        const container = document.getElementById('lightbox-container');
        box.style.display = 'flex';
        container.innerHTML = type === 'video' 
            ? `<video src="${src}" controls autoplay style="max-width:90vw; max-height:90vh"></video>`
            : `<img src="${src}" style="max-width:90vw; max-height:90vh; object-fit:contain;">`;
    }

    // === L√ìGICA MODAL DE VALIDACI√ìN (AUDITOR√çA) ===
    function abrirValidacion(item) {
        activeItemData = item;
        // Cargar datos en el modal
        document.getElementById('v_video').src = '/static/' + item.evidencia_url1;
        document.getElementById('v_img1').src = '/static/' + item.evidencia_url;
        document.getElementById('v_img2').src = '/static/' + item.evidencia_url2;
        document.getElementById('v_argumentos').value = ""; // Limpiar texto anterior
        
        document.getElementById('modalValidacion').style.display = 'flex';
    }

    function cerrarValidacion() {
        document.getElementById('modalValidacion').style.display = 'none';
        activeItemData = null;
        // Detener video si estaba reproduci√©ndose
        const v = document.getElementById('v_video');
        v.pause();
        v.src = "";
    }

    async function enviarValidacion(decision) {
        if(!activeItemData) return;
        
        const args = document.getElementById('v_argumentos').value;
        // Validaci√≥n simple: Si es No Conforme, exigir argumentos
        if (decision === 'no_conforme' && args.trim().length < 5) {
            alert("Para declarar NO CONFORME, es obligatorio escribir los argumentos y hechos.");
            return;
        }

        // Bloquear bot√≥n para evitar doble env√≠o
        const btn = event.target;
        const textoOriginal = btn.innerText;
        btn.innerText = "Procesando..."; 
        btn.disabled = true;

        try {
            const resp = await fetch('/mermas/validar_investigacion', {
                method: 'POST',
                body: JSON.stringify({
                    id: activeItemData.id,
                    decision: decision,
                    argumentos: args
                })
            });
            const data = await resp.json();
            
            if(data.success) {
                cerrarValidacion();
                setTimeout(polling, 500); // Refrescar lista
            } else {
                alert("Error: " + (data.message || "No se pudo procesar."));
            }
        } catch(e) {
            alert("Error de conexi√≥n");
        } finally {
            btn.innerText = textoOriginal;
            btn.disabled = false;
        }
    }

    // === L√ìGICA MODAL DE CONSULTAS / REPORTES ===
    const modal = document.getElementById('modalConsultas');
    const report = document.getElementById('report');
    let chartRef = null;

    document.getElementById('btnOpenConsultas').onclick = () => {
      modal.style.display = 'flex';
      ['zona', 'vendedor', 'cliente', 'vehiculo'].forEach(t => loadOpts(t));
    };
    function closeModal() { modal.style.display = 'none'; }
    document.getElementById('btnCloseModal').onclick = closeModal;
    document.getElementById('btnCerrar').onclick = closeModal;

    async function loadOpts(tipo) {
      const sel = document.getElementById('q' + tipo.charAt(0).toUpperCase() + tipo.slice(1));
      const r = await fetch(`/mermas/opciones?tipo=${tipo}`);
      const j = await r.json();
      sel.innerHTML = '<option value="">Selecciona...</option>';
      j.items.forEach(v => sel.innerHTML += `<option value="${v}">${v}</option>`);
    }

    document.querySelectorAll('.pill').forEach(p => {
      p.onclick = () => {
        document.querySelectorAll('.pill').forEach(x => x.classList.remove('active'));
        p.classList.add('active');
        document.querySelectorAll('.sec').forEach(s => s.style.display = 'none');
        document.querySelector('.sec-' + p.dataset.section).style.display = 'block';
      }
    });

    document.getElementById('btnEjecutarConsulta').onclick = async () => {
      const type = document.querySelector('.pill.active').dataset.section;
      const payload = { tipo: type };
      const setP = (k, v) => payload[k] = document.getElementById(v).value;
      if(type==='zona') { setP('zona','qZona'); setP('desde','fDesde_z'); }
      else if(type==='vendedor') { setP('vendedor','qVendedor'); setP('desde','fDesde_v'); }
      else if(type==='cliente') { setP('cliente','qCliente'); setP('desde','fDesde_c'); }
      else if(type==='vehiculo') { setP('vehiculo','qVehiculo'); setP('desde','fDesde_ve'); }

      const r = await fetch('/mermas/consulta', { method: 'POST', body: JSON.stringify(payload) });
      const data = await r.json();
      closeModal();
      renderReport(data);
    };

    function renderReport(data) {
      document.getElementById('list').innerHTML = '';
      document.getElementById('empty').style.display = 'none';

      report.innerHTML = `
            <div class="report-head">
                <div>
                   <h3 style="margin:0 0 5px 0; color:var(--verde);">Informe Generado</h3>
                   <div style="display:flex; gap:5px;">
                     <span class="stat-badge">Total: ${data.resumen.kg_totales} kg</span>
                     <span class="stat-badge" style="background:#fff5f5; color:#c53030; border-color:#feb2b2;">Merma: ${data.resumen.merma_total} kg (${data.resumen.merma_pct_total}%)</span>
                   </div>
                </div>
                <button id="btnPDF" class="btn primary">üì• Descargar PDF</button>
            </div>
            <div class="chart-box"><div style="height:300px;"><canvas id="cvMerma"></canvas></div></div>
            <div class="chart-box">
                <table class="tbl">
                    <thead><tr><th>Fecha</th><th>Cliente</th><th>Factura</th><th>KG Ent</th><th>Merma</th><th>%</th></tr></thead>
                    <tbody>${data.operaciones.map(o => `<tr><td>${o.fecha}</td><td>${o.cliente}</td><td>${o.factura}</td><td>${o.kg_entregados}</td><td style="color:#b00020">${o.merma_kg}</td><td><b>${o.merma_pct}%</b></td></tr>`).join('')}</tbody>
                </table>
            </div>
            <button onclick="location.reload()" class="btn secondary" style="margin-top:20px;">Volver al inicio</button>
        `;

      if (chartRef) chartRef.destroy();
      chartRef = new Chart(document.getElementById('cvMerma'), {
        type: data.chart.type === 'points' ? 'line' : 'bar',
        data: { labels: data.chart.labels, datasets: [{ label: 'Merma %', data: data.chart.values, backgroundColor: '#015249', borderColor: '#015249' }] },
        options: { maintainAspectRatio: false }
      });

      document.getElementById('btnPDF').onclick = async () => {
        data.chart_png = chartRef.toBase64Image();
        const r = await fetch('/mermas/consulta/pdf', { method: 'POST', body: JSON.stringify(data) });
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'Reporte_Energix.pdf'; a.click();
      };
    }
  </script>
</body>
</html>