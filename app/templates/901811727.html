<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Webmaster - Energix 360</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: Verdana, sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding: 0;
        }

        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #e8f5e9;
            padding: 10px 20px;
            border-bottom: 1px solid #ccc;
            flex-wrap: wrap;
            gap: 20px;
        }

        .layout {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            min-height: calc(100vh - 60px);
        }

        .sidebar-left,
        .sidebar-right {
            width: 100%;
            max-width: 240px;
            background-color: #f0f0f0;
            padding: 15px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
            flex: 0 0 auto;
        }

        @media (min-width: 768px) {
            .sidebar-left {
                width: 20%;
            }
        }

        .main-content {
            flex: 1 1 auto;
            padding: 20px;
            position: relative;
            min-width: 0;
            max-width: 100%;
            box-sizing: border-box;
        }

        .welcome {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #015249;
        }

        .form-section {
            display: none;
            max-width: 700px;
            margin: 40px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #ffffff;
            box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-custom {
            background-color: #015249;
            color: white;
            border: none;
        }

        .btn-custom:hover {
            background-color: #013d36;
        }

        .btn-secondary {
            background-color: #cccccc;
            color: #333;
        }

        .btn-danger {
            background-color: #cc0000;
        }
    </style>
</head>

<body>
    <div class="header">
        <div style="flex: 1; text-align: left;">
            <h4 class="m-0">Panel de Control</h4>
        </div>
        <div style="flex: 1; text-align: center;">
            <p class="m-0 fw-bold text-muted">Bienvenido {{ nombre }} | Empresa: {{ empresa }}</p>
        </div>
        <div style="flex: 1; text-align: right;">
            <a href="/logout" class="btn btn-custom">Cerrar sesión</a>
        </div>
    </div>

    <div class="layout">
        <div class="sidebar-left">
            <div class="d-grid gap-2">
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('crearEmpresa')">Crear empresa</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('editarEmpresa')">Editar empresa</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('borrarEmpresa')">Borrar empresa</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('crearPerfil')">Crear perfiles</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('editarPerfil')">Editar perfiles</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('borrarPerfil')">Borrar perfiles</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('crearUsuario')">Crear usuario</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('editarUsuario')">Editar usuario</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('borrarUsuario')">Borrar usuario</button>
            </div>
        </div>

        <div class="main-content">
            <!-- FORMULARIOS ORIGINALES INSERTADOS AQUÍ -->

            <!-- Crear Empresa -->
            <div id="crearEmpresa" class="form-section">
                <h4>Crear Empresa</h4>
                <form id="formCrearEmpresa" data-url="/registrar_empresa"
                    data-confirmar="¿Desea registrar esta empresa?">
                    <div class="mb-2">
                        <label for="nombre_comercial">Nombre Comercial</label>
                        <input type="text" id="nombre_comercial" name="nombre_comercial" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label for="nit">NIT</label>
                        <input type="text" id="nit" name="nit" class="form-control">
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-custom"
                            onclick="confirmarEnvioGenerico('formCrearEmpresa')">Registrar</button>
                        <button type="button" class="btn btn-secondary"
                            onclick="limpiarFormulario('crearEmpresa')">Limpiar</button>
                        <button type="button" class="btn btn-danger"
                            onclick="ocultarFormulario('crearEmpresa')">Cerrar</button>
                    </div>
                </form>
            </div>

            <!-- Aquí irían los demás formularios: editarEmpresa, borrarEmpresa, crearPerfil, etc. -->
            <!-- Se recomienda que cada <form> tenga data-url y data-confirmar para integrarse con el modal unificado -->


            <div id="crearPerfil" class="form-section">
                <h5>Crear Perfil</h5>
                <form id="form_crearPerfil" data-url="/registrar_perfil" data-confirmar="¿Desea registrar este perfil?">
                    <div class="mb-3">
                        <label for="empresa_select" class="form-label">Empresa</label>
                        <select id="empresa_select" name="empresa_select" class="form-select"
                            onchange="actualizarNit()">
                            <option value="">Seleccione una empresa</option>
                            {% for empresa in empresas %}
                            <option data-nit="{{ empresa.nit }}" value="{{ empresa.nombre_comercial }}">{{
                                empresa.nombre_comercial }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="nit" class="form-label">NIT</label>
                        <input type="text" id="nit" name="nit" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label for="operacion" class="form-label">Operación</label>
                        <select id="operacion" name="operacion" class="form-select">
                            <option value="">Seleccione operación</option>
                            <option value="Electricidad">Electricidad</option>
                            <option value="Gas">Gas</option>
                            <option value="Carbon">Carbón</option>
                            <option value="Flota">Flota</option>
                            <option value="Mantenimiento">Mantenimiento</option>
                            <option value="Gerencia">Gerencia</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="perfil" class="form-label">Nombre del Perfil</label>
                        <input type="text" id="perfil" name="perfil" class="form-control"
                            placeholder="Ingrese el perfil">
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-custom"
                            onclick="confirmarEnvioGenerico('form_crearPerfil')">Registrar</button>
                        <button type="button" class="btn btn-secondary"
                            onclick="limpiarFormulario('crearPerfil')">Limpiar</button>
                        <button type="button" class="btn btn-danger"
                            onclick="ocultarFormulario('crearPerfil')">Cerrar</button>
                    </div>
                </form>
            </div>
            <!-- Crear Usuario -->
            <!-- Crear Usuario -->
            <div id="crearUsuario" class="form-section">
                <h4>Crear Usuario</h4>
                <form id="form_crearUsuario" data-url="/registrar_usuario"
                    data-confirmar="¿Desea registrar este usuario?">
                    <div class="mb-2">
                        <label for="cedula">Cédula</label>
                        <input type="text" id="cedula" name="cedula" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label for="nombre">Nombre completo</label>
                        <input type="text" id="nombre" name="nombre" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label for="password">Contraseña</label>
                        <input type="password" id="password" name="password" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label for="empresa_select_usuario">Empresa</label>
                        <select id="empresa_select_usuario" name="empresa_select" class="form-select"
                            onchange="actualizarEmpresaUsuario()">
                            <option value="">Seleccione una empresa</option>
                            {% for empresa in empresas %}
                            <option data-id="{{ empresa.nit }}" value="{{ empresa.nombre_comercial }}">{{
                                empresa.nombre_comercial }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="empresa_id">NIT Empresa</label>
                        <input type="text" id="empresa_id" name="empresa_id" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label for="operacion_usuario">Operación</label>
                        <select id="operacion_usuario" name="operacion" class="form-select"
                            onchange="actualizarPerfilesPorEmpresaYOperacion()">
                            <option value="">Seleccione operación</option>
                            <option value="Electricidad">Electricidad</option>
                            <option value="Gas">Gas</option>
                            <option value="Carbon">Carbón</option>
                            <option value="Flota">Flota</option>
                            <option value="Mantenimiento">Mantenimiento</option>
                            <option value="Gerencia">Gerencia</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="tipo_usuario">Tipo de usuario</label>
                        <select id="tipo_usuario" name="tipo_usuario" class="form-select">
                            <option value="">Seleccione tipo</option>
                            <option value="cliente">Cliente</option>
                            <option value="webmaster">Webmaster</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="clase">Clase</label>
                        <select id="clase" name="clase" class="form-select">
                            <option value="">Seleccione clase</option>
                            <option value="op">Operativo</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="perfil_usuario">Perfil</label>
                        <select id="perfil_usuario" name="perfil" class="form-select">
                            <option value="">Seleccione un perfil disponible</option>
                        </select>
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-custom"
                            onclick="confirmarEnvioGenerico('form_crearUsuario')">Registrar</button>
                        <button type="button" class="btn btn-secondary"
                            onclick="limpiarFormulario('crearUsuario')">Limpiar</button>
                        <button type="button" class="btn btn-danger"
                            onclick="ocultarFormulario('crearUsuario')">Cerrar</button>
                    </div>
                </form>
            </div>

        </div>


        <!-- MODAL DE CONFIRMACION GLOBAL -->
        <div class="modal fade" id="modalConfirmacionGlobal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="modalMensajeGlobal">
                        <!-- mensaje se inserta dinámicamente -->
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                        <button class="btn btn-custom" id="btnConfirmarGlobal">Sí</button>
                    </div>
                </div>
            </div>

            <!--JS-AJAX PARA OCULTAR MOSTRAR LOS MODALES Y LIMPIAR LOS INPUTS PARA LOS FORMULARIOS-->
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    function mostrarFormulario(id) {
                        document.querySelectorAll('.form-section').forEach(div => div.style.display = 'none');
                        const target = document.getElementById(id);
                        if (target) {
                            target.style.display = 'block';
                        }
                    }

                    window.mostrarFormulario = mostrarFormulario;

                    window.ocultarFormulario = function (id) {
                        document.getElementById(id).style.display = 'none';
                        const select = document.getElementById('opcionesEmpresas');
                        if (select) {
                            select.value = "";
                        }
                    }

                    window.limpiarFormulario = function (id) {
                        const form = document.querySelector(`#${id} form`);
                        const inputs = form.querySelectorAll('input');
                        inputs.forEach(input => input.value = '');
                        const selects = form.querySelectorAll('select');
                        selects.forEach(select => select.selectedIndex = 0);
                    }
                });
            </script>
            <!--JS-AJAX PARA OCULTAR MOSTRAR LOS MODALES Y LIMPIAR LOS INPUTS PARA LOS FORMULARIOS-->

            <!--JS-AJAX PARA EL MODAL DE CONFIRMACIÓN-->

            <script>
                let formularioActivo = null;

                function confirmarEnvioGenerico(formId) {
                    const form = document.getElementById(formId);
                    if (!form) return;

                    formularioActivo = form;
                    const mensaje = form.dataset.confirmar || "¿Desea continuar?";
                    document.getElementById('modalMensajeGlobal').textContent = mensaje;

                    const modal = new bootstrap.Modal(document.getElementById('modalConfirmacionGlobal'));
                    modal.show();
                }

                document.getElementById('btnConfirmarGlobal').addEventListener('click', () => {
                    if (!formularioActivo) return;

                    const url = formularioActivo.dataset.url;
                    const data = new FormData(formularioActivo);
                    const contenedor = formularioActivo.closest('.form-section');

                    fetch(url, {
                        method: 'POST',
                        body: data
                    })
                        .then(res => res.json())
                        .then(result => {
                            alert(result.message);
                            if (result.success && contenedor) {
                                formularioActivo.reset();
                                ocultarFormulario(contenedor.id);
                            }
                        })
                        .catch(err => {
                            alert('Error al procesar la operación.');
                            console.error(err);
                        });

                    bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionGlobal')).hide();
                });
            </script>
            <!--JS-AJAX PARA EL MODAL DE CONFIRMACIÓN-->

            <!--JS AJAX SELECCIONAR ROLES EN CRERA USUARIO-->
            <script>
                function actualizarEmpresaUsuario() {
                    const select = document.getElementById('empresa_select_usuario');
                    const selected = select.options[select.selectedIndex];
                    const id = selected.getAttribute('data-id') || '';
                    document.getElementById('empresa_id').value = id;
                    actualizarPerfilesPorEmpresaYOperacion();
                }

                function actualizarPerfilesPorEmpresaYOperacion() {
                    const empresaId = document.getElementById('empresa_id').value;
                    const operacion = document.getElementById('operacion_usuario').value;

                    console.log("→ buscando perfiles para:", empresaId, operacion); // ✅ nuevo

                    if (!empresaId || !operacion) {
                        document.getElementById('perfil').innerHTML = '<option value="">Seleccione un perfil disponible</option>';
                        return;
                    }

                    fetch(`/obtener_perfiles?empresa_id=${encodeURIComponent(empresaId)}&operacion=${encodeURIComponent(operacion)}`)
                        .then(res => res.json())
                        .then(data => {
                            const perfilSelect = document.getElementById('perfil_usuario');
                            perfilSelect.innerHTML = '<option value="">Seleccione un perfil disponible</option>';
                            data.perfiles.forEach(perfil => {
                                const option = document.createElement('option');
                                option.value = perfil;
                                option.textContent = perfil;
                                perfilSelect.appendChild(option);
                            });
                        })
                        .catch(err => {
                            console.error('Error al obtener perfiles:', err);
                            alert('No se pudieron cargar los perfiles.');
                        });
                }

            </script>



            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>