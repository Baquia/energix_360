<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="apple-touch-icon" href="/static/icon-192.png">
  <title>Panel Webmaster BQA-ONE</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#015249">

  <script src="/static/js/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>


  <style>
    :root {
      --color-primary: #015249;
      --color-primary-dark: #013d36;
      --color-bg: #f6f7f8;
      --color-surface: #ffffff;
      --color-border: #e5e7eb;
      --color-text: #111827;
      --color-muted: #6b7280;
      --color-danger: #b00020;
      --shadow-soft: 0 4px 14px rgba(15, 23, 42, 0.08);
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Verdana, sans-serif;
      background: radial-gradient(circle at top, #d7f2ec 0, #f6f7f8 45%, #f6f7f8 100%);
      color: var(--color-text);
      overflow-x: hidden;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(1, 82, 73, 0.3);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(1, 82, 73, 0.6);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      padding: 12px 16px;
      max-width: 1280px;
      margin: 0 auto 6px auto;
    }

    .layout {
      display: flex;
      flex-wrap: nowrap;
      max-width: 1280px;
      margin: 0 auto;
      padding: 8px 12px 20px;
      gap: 20px;
      align-items: flex-start;
    }

    /* SIDEBAR */
    .sidebar-left {
      flex: 0 0 260px;
      max-width: 260px;
      background: linear-gradient(180deg, var(--color-primary-dark) 0%, #002824 100%);
      color: #fff;
      border-radius: 16px;
      box-shadow: var(--shadow-soft);
      min-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.05);
      position: sticky;
      top: 20px;
    }

    .sidebar-section-title {
      padding: 15px 20px 10px 20px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: rgba(255, 255, 255, 0.4);
      font-weight: 700;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      margin-bottom: 5px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-section-title:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.02);
    }

    .scrollable-list {
      max-height: 250px;
      overflow-y: auto;
      padding-right: 5px;
    }

    .scrollable-list::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
    }

    .nav-item {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 12px 20px;
      color: #e0e0e0;
      text-decoration: none;
      border: none;
      border-left: 4px solid transparent;
      background: transparent;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
      outline: none;
    }

    .nav-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
      color: #fff;
      padding-left: 24px;
    }

    .nav-item.active {
      background-color: rgba(1, 82, 73, 0.6);
      border-left-color: #4ade80;
      color: #fff;
      font-weight: 600;
    }

    .submenu-operacion {
      background-color: #002f2a;
      padding-left: 35px;
      font-size: 0.85rem;
      color: #94a3b8;
    }

    .submenu-operacion:hover {
      color: #4ade80;
      background-color: #002521;
    }

    .icon-spacer {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 24px;
      margin-right: 12px;
      font-size: 1.1em;
    }

    /* CONTENIDO */
    .main-content {
      flex: 1;
    }

    /* ESTILOS DE TARJETAS KPI (MEJORADOS) */
    .kpi-card-box {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.04), 0 1px 3px rgba(0, 0, 0, 0.08);
      padding: 20px 15px;
      text-align: center;
      border-top: 5px solid;
      transition: transform 0.2s ease;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .kpi-card-box:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }

    .kpi-label {
      font-size: 0.75rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .kpi-value {
      font-size: 1.4rem;
      font-weight: 800;
      margin: 0;
      color: #0f172a;
    }

    /* Colores espec√≠ficos para bordes */
    .border-kpi-1 {
      border-color: #3b82f6;
    }

    /* Azul */
    .border-kpi-2 {
      border-color: #10b981;
    }

    /* Verde */
    .border-kpi-3 {
      border-color: #f59e0b;
    }

    /* Ambar */
    .border-kpi-4 {
      border-color: #6366f1;
    }

    /* Indigo */
    .border-kpi-5 {
      border-color: #64748b;
    }

    /* Gris */
    .border-kpi-6 {
      border-color: #ec4899;
    }

    /* Rosa */

    .text-kpi-1 {
      color: #3b82f6;
    }

    .text-kpi-2 {
      color: #10b981;
    }

    .text-kpi-3 {
      color: #f59e0b;
    }

    .text-kpi-4 {
      color: #6366f1;
    }

    .text-kpi-6 {
      color: #ec4899;
    }

    .form-section {
      display: none;
      margin-bottom: 20px;
      padding: 25px;
      border-radius: 14px;
      border: 1px solid var(--color-border);
      background: #ffffff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
    }

    .form-section.active {
      display: block;
    }

    .btn-custom {
      background-color: #01675b;
      border-color: #01675b;
      color: #fff;
      border-radius: 8px;
      padding: 8px 16px;
    }

    .btn-custom:hover {
      background-color: #013d36;
    }

    .form-control,
    .form-select {
      border-radius: 8px;
      padding: 10px;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(1, 82, 73, 0.1);
    }

    @media (max-width: 900px) {
      .layout {
        flex-direction: column;
      }

      .sidebar-left {
        max-width: 100%;
        min-height: auto;
        position: relative;
        top: 0;
      }
    }

    /* OVERLAY MODALES */
    .pregunta-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(1, 61, 54, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }

    .pregunta-card {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 400px;
      animation: scaleUp 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes scaleUp {
      from {
        transform: scale(0.9);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* ========================================= */
    /* ESTILOS EXCLUSIVOS PARA LA PLANTILLA PDF */
    /* ========================================= */
    #contenedorFantasma {
      position: absolute;
      left: -9999px;
      top: 0;
    }

    #reporteImpresion {
      background-color: white;
      width: 720px;
      /* Ancho fijo para PDF Letter/A4 */
      padding: 40px;
      margin: 0 auto;
      font-family: 'Arial', sans-serif;
      color: #000;
      display: none;
      /* Oculto por defecto */
    }

    /* Cuando se genera el PDF, html2pdf lo har√° visible internamente */
    .modo-impresion #reporteImpresion {
      display: block !important;
    }

    .rep-header {
      border-bottom: 2px solid #015249;
      padding-bottom: 10px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .rep-logo {
      height: 60px;
      object-fit: contain;
    }

    .rep-title h2 {
      margin: 0;
      color: #015249;
      font-size: 24px;
      text-transform: uppercase;
    }

    .rep-title p {
      margin: 0;
      font-size: 12px;
      color: #666;
    }

    .rep-grid-info {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
      padding: 15px;
      background: #f9f9f9;
    }

    .rep-item label {
      display: block;
      font-size: 10px;
      font-weight: bold;
      color: #555;
      text-transform: uppercase;
    }

    .rep-item span {
      font-size: 12px;
      font-weight: bold;
      color: #000;
    }

    .rep-section-title {
      font-size: 14px;
      font-weight: bold;
      border-bottom: 1px solid #000;
      margin-bottom: 15px;
      padding-bottom: 5px;
      text-transform: uppercase;
      color: #000;
      margin-top: 20px;
    }

    .rep-kpis {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      /* 3 Columnas estrictas */
      gap: 15px;
      margin-bottom: 20px;
    }

    .rep-card {
      border: 1px solid #000;
      padding: 15px;
      text-align: center;
      border-radius: 4px;
      background: #fff;
    }

    .rep-card-label {
      font-size: 10px;
      text-transform: uppercase;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }

    .rep-card-value {
      font-size: 18px;
      font-weight: bold;
      color: #015249;
    }

    .rep-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-bottom: 20px;
    }

    .rep-table th {
      background: #eee;
      border: 1px solid #000;
      padding: 5px;
      font-weight: bold;
      text-align: center;
    }

    .rep-table td {
      border: 1px solid #000;
      padding: 5px;
      text-align: center;
    }

    #repGraficoImg {
      width: 100%;
      height: 250px;
      object-fit: contain;
      border: 1px solid #eee;
      display: block;
      margin: 0 auto;
    }

    /* ================================================== */
    /* ESTILOS PARA VALIDACI√ìN DE TANQUEOS (MODO LISTA)   */
    /* ================================================== */

    /* Contenedor principal: Lista vertical de tarjetas */
    .validacion-grid {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 20px;
      width: 100%;
    }

    /* La Tarjeta (Fila completa) */
    .tanqueo-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      transition: box-shadow 0.2s;
    }

    .tanqueo-card:hover {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    /* Cabecera Verde */
    .tanqueo-header {
      background: #0f766e;
      color: white;
      padding: 8px 15px;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Cuerpo flexible (3 columnas) */
    .tanqueo-body {
      padding: 0;
      display: flex;
      flex-wrap: wrap;
      /* Permite que baje en moviles */
      width: 100%;
    }

    /* COLUMNA 1: Metadatos (Izquierda) */
    .t-meta {
      flex: 0 0 260px;
      /* Ancho fijo */
      padding: 15px;
      background: #f8fafc;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 10px;
      font-size: 0.85rem;
      color: #334155;
    }

    .t-meta strong {
      color: #0f172a;
      display: block;
      margin-bottom: 2px;
    }

    /* COLUMNA 2: Detalles/Tabla (Centro) */
    .t-details {
      flex: 1;
      /* Ocupa el espacio restante */
      padding: 15px;
      min-width: 300px;
      overflow-x: auto;
    }

    /* COLUMNA 3: Acciones (Derecha) */
    .t-actions {
      flex: 0 0 180px;
      /* Ancho fijo para botones */
      padding: 15px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 10px;
      background: #fdfdfd;
      border-left: 1px solid #e5e7eb;
    }

    /* ESTILOS DE LA TABLA INTERNA */
    .mini-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .mini-table th {
      text-align: left;
      padding: 8px;
      color: #64748b;
      font-weight: 600;
      border-bottom: 2px solid #e2e8f0;
      font-size: 0.75rem;
      text-transform: uppercase;
    }

    .mini-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: top;
    }

    .mini-table tr:last-child td {
      border-bottom: none;
    }

    /* Miniaturas de fotos */
    .thumb-val {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid #cbd5e1;
      display: block;
      margin-top: 5px;
      transition: transform 0.2s;
    }

    .thumb-val:hover {
      transform: scale(1.1);
      border-color: #0f766e;
    }

    /* RESPONSIVE (Celulares) */
    @media (max-width: 900px) {
      .tanqueo-body {
        flex-direction: column;
      }

      .t-meta,
      .t-details,
      .t-actions {
        width: 100%;
        flex: auto;
        border-right: none;
        border-left: none;
        border-bottom: 1px solid #e5e7eb;
      }

      .t-actions {
        flex-direction: row;
        /* Botones lado a lado en m√≥vil */
        padding: 20px;
      }
    }

    /* Estilos Espec√≠ficos Validaci√≥n Tanqueos */
    .tanqueo-card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fff;
      overflow: hidden;
    }

    .tanqueo-header {
      background: #015249 !important;
      /* Tu color corporativo */
    }

    .thumb-val {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #ddd;
      cursor: zoom-in;
      transition: transform 0.2s;
      margin-top: 5px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .thumb-val:hover {
      transform: scale(1.5);
      z-index: 10;
      position: relative;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 768px) {

      .col-md-3,
      .col-md-7,
      .col-md-2 {
        width: 100% !important;
        border-right: none !important;
        border-bottom: 1px solid #ddd;
      }

      .tanqueo-card .d-flex.flex-wrap {
        flex-direction: column;
      }
    }
  </style>

</head>
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js").catch(err => console.error("Error SW:", err));
    });
  }
</script>

<body>
  <div class="header">
    <div style="flex: 1; text-align: left;">
      <h4 class="m-0 fw-bold" style="color: var(--color-primary);">Panel de Control</h4>
    </div>
    <div style="flex: 1; text-align: center;">
      <p class="m-0 fw-bold text-muted">Bienvenido {{ nombre }} | Empresa: {{ empresa }}</p>
    </div>
    <div style="flex: 1; text-align: right;">
      <a href="/logout" class="btn btn-custom">Cerrar sesi√≥n</a>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar-left">
      <div class="sidebar-section-title" data-bs-toggle="collapse" data-bs-target="#seccionAdmin">
        <span>ADMINISTRACI√ìN</span> <span>‚ñæ</span>
      </div>
      <div class="collapse show" id="seccionAdmin">
        <button class="nav-item" onclick="activarMenu(this, 'crearEmpresa')"><span class="icon-spacer">üè¢</span> Crear
          Empresa</button>
        <button class="nav-item" type="button" data-bs-toggle="collapse" data-bs-target="#menuPerfiles"><span
            class="icon-spacer">üë•</span> Gesti√≥n Perfiles</button>
        <div class="collapse" id="menuPerfiles">
          <button class="nav-item submenu-operacion" onclick="activarMenu(this, 'crearPerfil')">Crear Nuevo</button>
          <button class="nav-item submenu-operacion" onclick="activarMenu(this, 'editarPerfil')">Editar
            Existente</button>
        </div>
        <button class="nav-item" type="button" data-bs-toggle="collapse" data-bs-target="#menuUsuarios"><span
            class="icon-spacer">üë§</span> Gesti√≥n Usuarios</button>
        <div class="collapse" id="menuUsuarios">
          <button class="nav-item submenu-operacion" onclick="activarMenu(this, 'crearUsuario')">Crear Usuario</button>
          <button class="nav-item submenu-operacion" onclick="activarMenu(this, 'editarUsuario')">Editar
            Usuario</button>
        </div>
      </div>

      <div class="sidebar-section-title mt-2" data-bs-toggle="collapse" data-bs-target="#seccionInformes"><span>INFORMES
          GLP</span> <span>‚ñæ</span></div>
      <div class="collapse show scrollable-list" id="seccionInformes">
        <div class="client-list">
          <button class="nav-item" onclick="cargarOperacionesModerno(this, '890707006')"><span
              class="icon-spacer">üêî</span> Pollos Gar SAS</button>
          <button class="nav-item" onclick="cargarOperacionesModerno(this, '900977113')"><span
              class="icon-spacer">üèñÔ∏è</span> Fenix Beach</button>
          <button class="nav-item" onclick="cargarOperacionesModerno(this, '901370428')"><span
              class="icon-spacer">üõí</span> Mercacentro</button>
        </div>
      </div>

      <div id="contenedorOperaciones"
        style="display:none; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px;">
        <div class="sidebar-section-title" style="color: #4ade80;" data-bs-toggle="collapse"
          data-bs-target="#listaOperacionesDinamica"><span>OPERACIONES</span> <span>‚ñæ</span></div>
        <div id="listaOperacionesDinamica" class="collapse show"></div>
      </div>

      <div style="display:none;">
        <select id="menuDesplegable" class="form-select" onchange="mostrarFormularioSeleccionado()"></select>
        <select id="clienteSelect" class="form-select" onchange="cargarOperaciones()">
          <option value="">INFORMES</option>
          <option value="890707006">Pollos Gar SAS</option>
          <option value="900977113">Fenix Beach Cartagena</option>
          <option value="901370428">Mercacentro</option>
        </select>
        <ul id="submenu" class="submenu"></ul>
        <div id="submenuContainer"></div>
      </div>
    </div>


    <div class="main-content">
      <div id="crearEmpresa" class="form-section">
        <h4>Crear Empresa</h4>
        <form id="formCrearEmpresa" data-url="/registrar_empresa" data-confirmar="¬øDesea registrar esta empresa?">
          <div class="mb-2"><label>Nombre Comercial</label><input type="text" name="nombre_comercial"
              class="form-control"></div>
          <div class="mb-2"><label>NIT</label><input type="text" name="nit" class="form-control"></div>
          <div class="mt-3"><button type="button" class="btn btn-custom"
              onclick="confirmarEnvioGenerico('formCrearEmpresa')">Registrar</button></div>
        </form>
      </div>

      <div id="crearPerfil" class="form-section">
        <h5>Crear Perfil</h5>
        <form id="form_crearPerfil" data-url="/registrar_perfil" data-confirmar="¬øDesea registrar este perfil?">
          <div class="mb-3">
            <label class="form-label">Empresa</label>
            <select name="empresa_select" class="form-select" onchange="actualizarNit()">
              <option value="">Seleccione una empresa</option>
              {% for empresa in empresas %}<option data-nit="{{ empresa.nit }}" value="{{ empresa.nombre_comercial }}">
                {{ empresa.nombre_comercial }}</option>{% endfor %}
            </select>
          </div>
          <div class="mb-3"><label class="form-label">NIT</label><input type="text" id="nit" name="nit"
              class="form-control"></div>
          <div class="mb-3">
            <label class="form-label">Operaci√≥n</label>
            <select name="operacion" class="form-select">
              <option value="Electricidad">Gestion Electricidad</option>
              <option value="Gas">Gestion Gas Avicola</option>
              <option value="Carbon">Gestion Carb√≥n</option>
            </select>
          </div>
          <div class="mb-3"><label class="form-label">Nombre del Perfil</label><input type="text" name="perfil"
              class="form-control"></div>
          <div class="mt-3"><button type="button" class="btn btn-custom"
              onclick="confirmarEnvioGenerico('form_crearPerfil')">Registrar</button></div>
        </form>
      </div>

      <div id="crearUsuario" class="form-section">
        <h4>Crear Usuario</h4>
        <form id="form_crearUsuario" data-url="/registrar_usuario" data-confirmar="¬øDesea registrar este usuario?">
          <div class="mb-2"><label>C√©dula</label><input type="text" name="cedula" class="form-control"></div>
          <div class="mb-2"><label>Nombre</label><input type="text" name="nombre" class="form-control"></div>
          <div class="mb-2"><label>Contrase√±a</label><input type="password" name="password" class="form-control"></div>
          <div class="mb-2"><label>Empresa</label>
            <select id="empresa_select_usuario" name="empresa_select" class="form-select"
              onchange="actualizarEmpresaUsuario()">
              <option value="">Seleccione...</option>
              {% for empresa in empresas %}<option data-id="{{ empresa.nit }}" value="{{ empresa.nombre_comercial }}">{{
                empresa.nombre_comercial }}</option>{% endfor %}
            </select>
          </div>
          <input type="hidden" id="empresa_id" name="empresa_id">
          <div class="mb-2"><label>Operaci√≥n</label><select id="operacion_usuario" name="operacion" class="form-select"
              onchange="actualizarPerfilesPorEmpresaYOperacion()">
              <option value="Gas">Gas</option>
            </select></div>
          <div class="mb-2"><label>Perfil</label><select id="perfil_usuario" name="perfil" class="form-select"></select>
          </div>
          <div class="mt-3"><button type="button" class="btn btn-custom"
              onclick="confirmarEnvioGenerico('form_crearUsuario')">Registrar</button></div>
        </form>
      </div>

      <div id="seccionInforme" class="content-section"
        style="display: none; animation: slideIn 0.5s; position: relative; background-color: #ffffff !important; padding: 25px;">

        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h4 id="tituloInforme" style="color: var(--color-primary); font-weight:700; margin-bottom: 0;">Informe de
              Gesti√≥n GLP</h4>
            <small id="subtituloPeriodo" class="text-muted fw-bold">Periodo...</small>
          </div>
          <div>
            <button class="btn btn-custom btn-sm me-2" id="btnDescargarPdf" onclick="descargarPDF()">Descargar
              PDF</button>
            <button class="btn btn-danger btn-sm" id="btnCerrarInforme" onclick="cerrarInforme()">&times;
              Cerrar</button>
          </div>
        </div>

        <div class="row g-3 mb-4 text-center" id="kpiContainer">

          <div class="col-md-4 col-sm-6" id="kpiCard1">
            <div class="kpi-card-box border-kpi-1">
              <div class="kpi-label" id="kpi1Label">Saldo Inicial</div>
              <div class="kpi-value text-kpi-1" id="kpi1Value">0</div>
            </div>
          </div>

          <div class="col-md-4 col-sm-6" id="kpiCard2">
            <div class="kpi-card-box border-kpi-2">
              <div class="kpi-label" id="kpi2Label">Pedidos Gas</div>
              <div class="kpi-value text-kpi-2" id="kpi2Value">0</div>
            </div>
          </div>

          <div class="col-md-4 col-sm-6" id="kpiCard3">
            <div class="kpi-card-box border-kpi-3">
              <div class="kpi-label" id="kpi3Label">Consumos Parciales</div>
              <div class="kpi-value text-kpi-3" id="kpi3Value">0</div>
            </div>
          </div>

          <div class="col-md-4 col-sm-6" id="kpiCard5">
            <div class="kpi-card-box border-kpi-5">
              <div class="kpi-label" id="kpi5Label">Pollitos</div>
              <div class="kpi-value" id="kpi5Value" style="color: #475569;">0</div>
            </div>
          </div>

          <div class="col-md-4 col-sm-6" id="kpiCard6">
            <div class="kpi-card-box border-kpi-6">
              <div class="kpi-label" id="kpi6Label">Inversi√≥n Total ($)</div>
              <div class="kpi-value text-kpi-6" id="kpi6Value">0</div>
            </div>
          </div>

          <div class="col-md-4 col-sm-6" id="kpiCard4">
            <div class="kpi-card-box border-kpi-4">
              <div class="kpi-label" id="kpi4Label">Eficiencia Actual</div>
              <div class="kpi-value text-kpi-4" id="kpi4Value">0</div>
            </div>
          </div>

        </div>

        <div class="card p-3 mb-4 shadow-sm"
          style="border-radius:12px; border:none; box-shadow:0 4px 12px rgba(0,0,0,0.05);">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title m-0" style="color:var(--color-primary); font-size:1rem;">An√°lisis Gr√°fico</h5>
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-outline-primary btn-sm active"
                onclick="cambiarVistaGrafico('rendimiento')">Rendimiento</button>
              <button type="button" class="btn btn-outline-primary btn-sm"
                onclick="cambiarVistaGrafico('saldos')">Saldos</button>
            </div>
          </div>
          <div style="height: 320px; width: 100%;">
            <canvas id="graficoConsumo"></canvas>
          </div>
        </div>

        <div class="card p-3 shadow-sm" style="border-radius:12px; border:none;">
          <h5 class="card-title mb-3" style="color:var(--color-primary); font-size:1rem;">Resumen por Granja</h5>
          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table id="tablaConsumo" class="table table-hover table-bordered table-sm text-center">
              <thead class="table-light sticky-top">
                <tr></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <style>
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateY(20px);
          }

          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        @media (max-width: 576px) {
          #tablaConsumo {
            font-size: 0.75rem;
          }
        }
      </style>
      <div id="seccionValidacionTanqueos" class="content-section" style="display: none; animation: slideIn 0.5s;">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 style="color: var(--color-primary); font-weight:700;">Validaci√≥n de Tanqueos</h4>
          <button class="btn btn-secondary btn-sm" onclick="cerrarValidacionView()">&times; Cerrar</button>
        </div>

        <div id="loadingTanqueos" style="display:none; text-align:center; color:#666;">Cargando tanqueos pendientes...
        </div>
        <div id="gridTanqueos" class="validacion-grid"></div>
        <div id="emptyTanqueos" style="display:none; text-align:center; padding:40px; color:#999;">
          ‚úÖ No hay tanqueos pendientes de validaci√≥n.
        </div>
      </div>

      <div class="modal fade" id="modalDecisionTanqueo" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header" style="background:#015249; color:white;">
              <h5 class="modal-title">Validar Tanqueo</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
              <h4 class="mb-3">¬øLa informaci√≥n del tanqueo es correcta?</h4>
              <p class="text-muted mb-4">
                <strong>SI:</strong> Se aprueba y se borran las fotos.<br>
                <strong>NO:</strong> Se env√≠a alerta a Gerencia Granjas y se borran las fotos.
              </p>
              <div class="d-flex gap-3 justify-content-center">
                <button class="btn btn-danger px-4" onclick="confirmarDecisionTanqueo('NO')">NO (Irregular)</button>
                <button class="btn btn-success px-4" onclick="confirmarDecisionTanqueo('SI')">SI (Correcto)</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="lightboxSimple"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10000; justify-content:center; align-items:center;"
        onclick="this.style.display='none'">
        <img id="lbImg" src="" style="max-width:90%; max-height:90%; border:2px solid white; border-radius:4px;">
      </div>

    </div>

    <div class="modal fade" id="modalConfirmacionGlobal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmaci√≥n</h5><button type="button" class="btn-close"
              data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="modalMensajeGlobal"></div>
          <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">No</button><button
              class="btn btn-custom" id="btnConfirmarGlobal">S√≠</button></div>
        </div>
      </div>
    </div>

    <div id="contenedorFantasma">
      <div id="reporteImpresion">
        <div class="rep-header">
          <img id="repLogoCliente" src="" class="rep-logo">
          <div class="rep-title text-center">
            <h2>Informe de Gesti√≥n GLP</h2>
            <p>Generado por Webmaster BQA-ONE</p>
          </div>
          <img src="/static/logo_energix360.png" class="rep-logo">
        </div>

        <div class="rep-grid-info">
          <div class="rep-item"><label>Cliente</label><span id="repCliente">---</span></div>
          <div class="rep-item"><label>Ubicaci√≥n</label><span id="repUbicacion">---</span></div>
          <div class="rep-item"><label>Periodo</label><span id="repPeriodo">---</span></div>
          <div class="rep-item"><label>Fecha Reporte</label><span id="repFecha">---</span></div>
          <div class="rep-item"><label>Responsable</label><span id="repUsuario">{{ nombre }}</span></div>
          <div class="rep-item"><label>Tipo</label><span id="repTipo">---</span></div>
        </div>

        <div class="rep-section-title">Indicadores Clave</div>
        <div class="rep-kpis">
          <div class="rep-card">
            <div class="rep-card-label" id="lblKpi1">---</div>
            <div class="rep-card-value" id="valKpi1">0</div>
          </div>
          <div class="rep-card">
            <div class="rep-card-label" id="lblKpi2">---</div>
            <div class="rep-card-value" id="valKpi2">0</div>
          </div>
          <div class="rep-card">
            <div class="rep-card-label" id="lblKpi3">---</div>
            <div class="rep-card-value" id="valKpi3">0</div>
          </div>
          <div class="rep-card">
            <div class="rep-card-label" id="lblKpi4">---</div>
            <div class="rep-card-value" id="valKpi4">0</div>
          </div>
          <div class="rep-card">
            <div class="rep-card-label" id="lblKpi5">---</div>
            <div class="rep-card-value" id="valKpi5">0</div>
          </div>
          <div class="rep-card">
            <div class="rep-card-label" id="lblKpi6">---</div>
            <div class="rep-card-value" id="valKpi6">0</div>
          </div>
        </div>

        <div class="rep-section-title">Tendencia de Rendimiento</div>
        <img id="repGraficoImg" src="">

        <div class="rep-section-title" style="margin-top:20px;">Detalle Operativo</div>
        <table class="rep-table">
          <thead>
            <tr>
              <th>Granja / Ubicaci√≥n</th>
              <th>Consumo (kg)</th>
              <th>Poblaci√≥n</th>
              <th>Eficiencia (kg/ave)</th>
            </tr>
          </thead>
          <tbody id="repTablaBody">
          </tbody>
        </table>

        <div
          style="margin-top: 40px; border-top: 1px solid #ccc; padding-top: 10px; font-size: 10px; color: #888; text-align: center;">
          Este documento es un reporte generado autom√°ticamente por el sistema BQA ONE. <br>
          Fecha de impresi√≥n: <span id="repFooterFecha"></span>
        </div>
      </div>
    </div>


    <script>


      // --- FUNCIONES DE INTERFAZ ---
      function activarMenu(elemento, formularioId) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.submenu-operacion').forEach(el => el.classList.remove('active'));
        if (elemento) elemento.classList.add('active');
        mostrarFormulario(formularioId);
        cerrarInforme();
      }

      function cargarOperacionesModerno(elemento, clienteId) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if (elemento) elemento.classList.add('active');

        const selectViejo = document.getElementById("clienteSelect");
        if (selectViejo) { selectViejo.value = clienteId; selectViejo.dispatchEvent(new Event('change')); }

        const contenedor = document.getElementById("contenedorOperaciones");
        const lista = document.getElementById("listaOperacionesDinamica");
        lista.innerHTML = '';

        if (operaciones[clienteId]) {
          contenedor.style.display = 'block';
          operaciones[clienteId].forEach(op => {
            const btn = document.createElement("button");
            btn.className = "nav-item submenu-operacion";
            btn.innerHTML = `<span class="icon-spacer">üîπ</span> ${op.replace('Gestion ', '')}`;

            if (op === "Gestion Gas Avicola") {
              btn.onclick = function () {
                document.querySelectorAll('.submenu-operacion').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activarL√≥gicaInteractividadInformes(clienteId);
              };
              // Solo agregamos el bot√≥n principal, la validaci√≥n ir√° dentro del men√∫ de informes
              lista.appendChild(btn);

            } else {
              // L√≥gica para otras operaciones
              btn.onclick = function () { alert("Opci√≥n: " + op); };
              lista.appendChild(btn);
            }
          });
        } else { contenedor.style.display = 'none'; }

        // Limpiar vistas previas
        document.querySelectorAll('.form-section').forEach(div => div.style.display = 'none');
        cerrarInforme();
        if (typeof cerrarValidacionView === 'function') cerrarValidacionView();
      }

      function mostrarFormularioSeleccionado() { mostrarFormulario(document.getElementById("menuDesplegable").value); }

      /* --- L√ìGICA VALIDACI√ìN TANQUEOS --- */
      let idTanqueoSeleccionado = null;

      function cerrarValidacionView() {
        document.getElementById('seccionValidacionTanqueos').style.display = 'none';
      }

      function verFoto(src) {
        if (!src) return;
        document.getElementById('lbImg').src = src;
        document.getElementById('lightboxSimple').style.display = 'flex';
      }

      function cargarValidacionesTanqueos(empresaId) {
        // Ocultar otras secciones
        document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.form-section').forEach(el => el.style.display = 'none');
        document.getElementById('seccionValidacionTanqueos').style.display = 'block';

        const grid = document.getElementById('gridTanqueos');
        const loading = document.getElementById('loadingTanqueos');
        const empty = document.getElementById('emptyTanqueos');

        grid.innerHTML = '';
        loading.style.display = 'block';
        empty.style.display = 'none';

        fetch('/obtener_tanqueos_validacion', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ empresa_id: empresaId })
        })
          .then(r => r.json())
          .then(data => {
            loading.style.display = 'none';

            if (data.success && data.items.length > 0) {
              data.items.forEach(item => {
                // Crear fila html de tanques
                let filasHtml = '';
                item.subfilas.forEach(t => {
                  const imgAntes = t.foto_antes ? `<img src="${t.foto_antes}" class="thumb-val" onclick="verFoto(this.src)">` : '<span class="badge bg-secondary">Sin foto</span>';
                  const imgDesp = t.foto_despues ? `<img src="${t.foto_despues}" class="thumb-val" onclick="verFoto(this.src)">` : '<span class="badge bg-secondary">Sin foto</span>';
                  const imgVoucher = t.foto_voucher ? `<img src="${t.foto_voucher}" class="thumb-val" onclick="verFoto(this.src)">` : '<span class="badge bg-warning text-dark">Pendiente</span>';

                  filasHtml += `
                        <tr>
                            <td class="fw-bold text-primary">TK-${t.numero}</td>
                            
                            <td class="text-center border-start">
                                <div class="small fw-bold text-muted">Antes</div>
                                <div class="fs-5">${t.pct_antes}%</div>
                                ${imgAntes}
                            </td>
                            
                            <td class="text-center border-start">
                                <div class="small fw-bold text-muted">Despu√©s</div>
                                <div class="fs-5">${t.pct_despues}%</div>
                                ${imgDesp}
                            </td>

                            <td class="text-center border-start bg-light">
                                <div class="small fw-bold text-muted">Voucher</div>
                                ${imgVoucher}
                            </td>

                            <td class="text-center align-middle border-start">
                                <input type="checkbox" class="chk-prevalidacion form-check-input" style="width: 25px; height: 25px; cursor: pointer;" title="Confirmar revisi√≥n">
                            </td>
                        </tr>
                    `;
                });

                // Crear tarjeta contenedora
                const card = document.createElement('div');
                card.className = 'tanqueo-card mb-4 shadow-sm';
                card.id = `card-t-${item.id}`;
                card.innerHTML = `
                    <div class="tanqueo-header d-flex justify-content-between px-3 py-2 bg-primary text-white rounded-top">
                        <span><i class="fs-6">üìÖ</i> ${item.fecha}</span>
                        <span class="fw-bold">${item.ubicacion}</span>
                    </div>
                    
                    <div class="d-flex flex-wrap">
                        <div class="col-md-3 col-12 p-3 bg-light border-end">
                            <h6 class="text-muted text-uppercase small fw-bold mb-3">Detalles Operaci√≥n</h6>
                            <div class="mb-2">
                                <small class="d-block text-muted">Empresa</small>
                                <strong>${item.empresa}</strong>
                            </div>
                            <div class="mb-2">
                                <small class="d-block text-muted">Registrado por</small>
                                <span class="badge bg-info text-dark">${item.usuario}</span>
                            </div>
                            <div class="mb-2">
                                <small class="d-block text-muted">Lote / Referencia</small>
                                <code class="fs-6 text-dark">${item.lote}</code>
                            </div>
                            <div class="alert alert-warning mt-3 py-2 small">
                                <i class="icon-info"></i> Revise porcentajes y fotos antes de validar.
                            </div>
                        </div>

                        <div class="col-md-7 col-12 p-0">
                            <div class="table-responsive">
                                <table class="table table-borderless align-middle mb-0">
                                    <tbody>
                                        ${filasHtml}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="col-md-2 col-12 p-3 d-flex flex-column justify-content-center border-start bg-white">
                            <button class="btn btn-success mb-2 w-100 py-3" onclick="validarChecksYProcesar(${item.id})">
                                ‚úÖ VALIDAR
                            </button>
                            <button class="btn btn-outline-danger w-100 py-2" onclick="abrirModalDecision(${item.id}, 'NO')">
                                ‚ùå RECHAZAR
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
              });
            } else {
              empty.style.display = 'block';
            }
          })
          .catch(err => {
            loading.style.display = 'none';
            console.error(err);
            alert("Error cargando tanqueos.");
          });
      }

      // Funci√≥n auxiliar para obligar a marcar los checks antes de dar SI
      function validarChecksYProcesar(id) {
        const card = document.getElementById(`card-t-${id}`);
        const checks = card.querySelectorAll('.chk-prevalidacion');
        let todosMarcados = true;

        // Verificar si todos los checks est√°n marcados
        checks.forEach(c => {
          if (!c.checked) todosMarcados = false;
        });

        if (!todosMarcados) {
          alert("‚ö†Ô∏è Por favor, marca la casilla de revisi√≥n (checkbox) de cada tanque antes de validar.");
          return;
        }

        // Si todo est√° marcado, abrimos el modal de confirmaci√≥n SI
        idTanqueoSeleccionado = id;
        confirmarDecisionTanqueo('SI');
        // Nota: Reusamos tu funci√≥n confirmarDecisionTanqueo existente, 
        // pero saltamos el modal intermedio de "¬øSI o NO?" porque ya apret√≥ el bot√≥n SI.
      }

      // Ajuste a tu funci√≥n existente para manejar el flujo directo de botones
      function abrirModalDecision(id, tipoDirecto) {
        idTanqueoSeleccionado = id;
        // Si viene del bot√≥n NO, pedimos confirmaci√≥n de rechazo
        if (tipoDirecto === 'NO') {
          // Puedes usar el modal existente o un confirm simple
          if (confirm("¬øEst√°s seguro de RECHAZAR esta operaci√≥n? Se enviar√° alerta a Gerencia.")) {
            confirmarDecisionTanqueo('NO');
          }
        }
      }

      function abrirModalDecision(id) {
        idTanqueoSeleccionado = id;
        new bootstrap.Modal(document.getElementById('modalDecisionTanqueo')).show();
      }

      function confirmarDecisionTanqueo(decision) {
        if (!idTanqueoSeleccionado) return;

        // UI Feedback
        const modalEl = document.getElementById('modalDecisionTanqueo');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        const card = document.getElementById(`card-t-${idTanqueoSeleccionado}`);
        if (card) card.style.opacity = '0.5';

        fetch('/procesar_validacion_tanqueo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: idTanqueoSeleccionado, decision: decision })
        })
          .then(r => r.json())
          .then(resp => {
            if (resp.success) {
              if (card) card.remove();
              // Verificar si qued√≥ vac√≠o
              if (document.getElementById('gridTanqueos').children.length === 0) {
                document.getElementById('emptyTanqueos').style.display = 'block';
              }
              alert(decision === 'SI' ? "‚úÖ Validado correctamente." : "üì© Reporte enviado a Gerencia Granjas.");
            } else {
              if (card) card.style.opacity = '1';
              alert("Error: " + resp.message);
            }
          })
          .catch(err => {
            if (card) card.style.opacity = '1';
            alert("Error de conexi√≥n");
          });
      }
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        window.mostrarFormulario = function (id) {
          document.querySelectorAll('.form-section').forEach(div => div.style.display = 'none');
          const target = document.getElementById(id);
          if (target) target.style.display = 'block';
        }
        window.ocultarFormulario = function (id) { document.getElementById(id).style.display = 'none'; }
        window.limpiarFormulario = function (id) { document.querySelector(`#${id} form`).reset(); }
      });

      let formularioActivo = null;
      function confirmarEnvioGenerico(formId) {
        const form = document.getElementById(formId);
        if (!form) return;
        formularioActivo = form;
        document.getElementById('modalMensajeGlobal').textContent = form.dataset.confirmar || "¬øDesea continuar?";
        new bootstrap.Modal(document.getElementById('modalConfirmacionGlobal')).show();
      }
      document.getElementById('btnConfirmarGlobal').addEventListener('click', () => {
        if (!formularioActivo) return;
        const url = formularioActivo.dataset.url;
        const data = new FormData(formularioActivo);
        fetch(url, { method: 'POST', body: data }).then(res => res.json()).then(result => {
          alert(result.message);
          if (result.success) { formularioActivo.reset(); ocultarFormulario(formularioActivo.closest('.form-section').id); }
        });
        bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionGlobal')).hide();
      });

      function actualizarEmpresaUsuario() {
        const s = document.getElementById('empresa_select_usuario');
        document.getElementById('empresa_id').value = s.options[s.selectedIndex].getAttribute('data-id') || '';
        actualizarPerfilesPorEmpresaYOperacion();
      }
      function actualizarPerfilesPorEmpresaYOperacion() {
        const eid = document.getElementById('empresa_id').value;
        const op = document.getElementById('operacion_usuario').value;
        if (!eid || !op) return;
        fetch(`/obtener_perfiles?empresa_id=${eid}&operacion=${op}`).then(r => r.json()).then(d => {
          const s = document.getElementById('perfil_usuario'); s.innerHTML = '';
          d.perfiles.forEach(p => { const o = document.createElement('option'); o.value = p; o.textContent = p; s.appendChild(o); });
        });
      }
    </script>

    <script>
      const operaciones = {
        "890707006": ["Gestion Electricidad", "Gestion Gas Avicola", "Gestion Carb√≥n", "Gestion Flota Cautiva", "Gestion Transporte Especial", "Gestion Mantenimiento", "Gestion Procesos Industriales", "Gestion EDS"],
        "900977113": ["Gestion Electricidad", "Gestion Gas Avicola", "Gestion Carb√≥n"],
        "901370428": ["Gestion Electricidad", "Gestion Gas Avicola"]
      };

      let chartInstancia = null;
      let datosGlobales = null;

      function cerrarInforme() { document.getElementById('seccionInforme').style.display = 'none'; }

      // --- RENDERIZADO DE INFORME EN PANTALLA ---
      function renderizarInforme(data) {
        document.getElementById('seccionInforme').style.display = 'block';
        const kpis = data.kpis;

        const setCard = (id, label, value, isMoney = false, decimals = 0) => {
          const card = document.getElementById(id);
          if (label === "---") { card.style.display = 'none'; return; }
          card.style.display = 'block';

          const numId = id.replace('kpiCard', '');
          document.getElementById(`kpi${numId}Label`).textContent = label;

          let valStr = "";
          if (isMoney) {
            valStr = "$ " + Number(value).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
          } else {
            valStr = Number(value).toLocaleString(undefined, { maximumFractionDigits: decimals });
          }
          document.getElementById(`kpi${numId}Value`).textContent = valStr;
        };

        setCard('kpiCard1', kpis.card1_label, kpis.card1_value);
        setCard('kpiCard2', kpis.card2_label, kpis.card2_value);
        setCard('kpiCard3', kpis.card3_label, kpis.card3_value);
        setCard('kpiCard4', kpis.card4_label, kpis.card4_value, false, 4);
        setCard('kpiCard5', kpis.card5_label, kpis.card5_value);
        setCard('kpiCard6', kpis.card6_label, kpis.card6_value, true);

        cambiarVistaGrafico('rendimiento');

        // Tabla
        const tbody = document.getElementById('tablaConsumo').querySelector('tbody');
        const thead = document.getElementById('tablaConsumo').querySelector('thead tr');
        thead.innerHTML = `<th>Granja</th><th>Total kg</th><th>Pollitos</th><th>kg/pollito</th>`;
        tbody.innerHTML = '';
        data.tabla_resumen.forEach(row => {
          tbody.innerHTML += `<tr>
                  <td class="text-start fw-bold">${row.granja}</td>
                  <td class="text-end">${Number(row.total_kg).toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                  <td class="text-end">${Number(row.pollitos).toLocaleString()}</td>
                  <td class="text-end">${Number(row.kg_pollito).toFixed(4)}</td>
              </tr>`;
        });
        document.getElementById('seccionInforme').scrollIntoView({ behavior: 'smooth' });
      }

      function cambiarVistaGrafico(vista) {
        if (!datosGlobales) return;
        const ctx = document.getElementById('graficoConsumo').getContext('2d');
        if (chartInstancia) chartInstancia.destroy();
        const series = datosGlobales.series;
        let datasets = [];
        if (vista === 'rendimiento') {
          datasets = [{ label: 'Rendimiento (kg/ave)', data: series.kg_pollito, borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.1)', borderWidth: 2, pointRadius: 3, fill: true, tension: 0.3 }];
        } else if (vista === 'saldos') {
          datasets = [
            { label: 'Saldo Inicial', data: series.saldo_inicial, borderColor: '#3b82f6', backgroundColor: '#3b82f6', pointStyle: 'rectRot', showLine: false },
            { label: 'Ingresos', type: 'bar', data: series.ingresos, backgroundColor: '#10b981' }
          ];
        }
        chartInstancia = new Chart(ctx, { type: 'line', data: { labels: series.fechas, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false } });
      }

      // --- GENERACI√ìN DE PDF PROFESIONAL (PLANTILLA FANTASMA) ---
      function descargarPDF() {
        const btn = document.getElementById('btnDescargarPdf');
        btn.textContent = "Generando Documento...";
        btn.disabled = true;

        // 1. RECOLECTAR DATOS DE LA PANTALLA
        const select = document.getElementById("clienteSelect");
        const clienteNombre = select.options[select.selectedIndex].text;
        const ubicacion = document.getElementById("tituloInforme").textContent.replace("Informe de Gesti√≥n GLP", "").trim() || "Consolidado";
        const periodo = document.getElementById("subtituloPeriodo").textContent;

        // 2. LLENAR LA PLANTILLA OCULTA (MAPPING)
        // Encabezado
        document.getElementById("repCliente").textContent = clienteNombre;
        document.getElementById("repUbicacion").textContent = ubicacion;
        document.getElementById("repPeriodo").textContent = periodo;
        document.getElementById("repFecha").textContent = new Date().toLocaleDateString();
        document.getElementById("repFooterFecha").textContent = new Date().toLocaleString();
        document.getElementById("repTipo").textContent = ubicacion.includes("Zona") ? "Zonal" : "Sede/Granja";

        // Logo
        const logoImg = document.getElementById("repLogoCliente");
        logoImg.src = `/static/logo_${clienteNombre}.png`;

        // Funci√≥n interna para generar
        const runGeneration = () => {
          // KPIs (Copiamos texto y valor de las tarjetas visibles)
          for (let i = 1; i <= 6; i++) {
            document.getElementById(`lblKpi${i}`).textContent = document.getElementById(`kpi${i}Label`).textContent;
            document.getElementById(`valKpi${i}`).textContent = document.getElementById(`kpi${i}Value`).textContent;
          }

          // GR√ÅFICO (Convertir Canvas a Imagen)
          const canvas = document.getElementById('graficoConsumo');
          if (canvas) {
            const imgData = canvas.toDataURL("image/jpeg", 1.0);
            document.getElementById("repGraficoImg").src = imgData;
          }

          // TABLA (Clonar filas)
          const tablaBodyOriginal = document.getElementById('tablaConsumo').querySelector('tbody');
          const tablaBodyRep = document.getElementById('repTablaBody');
          tablaBodyRep.innerHTML = tablaBodyOriginal.innerHTML; // Copia exacta de filas

          // 3. GENERAR PDF DESDE LA PLANTILLA
          const elementoParaPDF = document.getElementById('reporteImpresion');
          elementoParaPDF.style.display = 'block'; // Hacer visible para el renderizador

          const opt = {
            margin: 0.5,
            filename: `Informe_Formal_${clienteNombre}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff' },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
          };

          html2pdf().set(opt).from(elementoParaPDF).save()
            .then(() => {
              btn.textContent = "Descargar PDF";
              btn.disabled = false;
              elementoParaPDF.style.display = 'none';
            })
            .catch(err => {
              console.error(err);
              alert("Error generando el documento.");
              btn.textContent = "Descargar PDF";
              btn.disabled = false;
              elementoParaPDF.style.display = 'none';
            });
        };

        // Esperar carga de logo
        if (logoImg.complete) {
          runGeneration();
        } else {
          logoImg.onload = runGeneration;
          logoImg.onerror = () => {
            console.warn("Logo no encontrado, generando sin logo.");
            runGeneration();
          };
        }
      }

      // --- INTERACTIVIDAD ---
      function mostrarPregunta(txt, opts, cb) {
        const ov = document.createElement("div"); ov.className = "pregunta-overlay";
        const card = document.createElement("div"); card.className = "pregunta-card";

        card.innerHTML = `<h5 style="color:#015249; text-align:center; margin-bottom:20px;">${txt}</h5>`;
        const sel = document.createElement("select"); sel.className = "form-select mb-4";
        sel.innerHTML = '<option value="">Seleccione...</option>';
        opts.forEach(o => sel.innerHTML += `<option value="${o.value}">${o.text}</option>`);
        card.appendChild(sel);

        const row = document.createElement("div"); row.style.display = "flex"; row.style.gap = "10px";
        const b1 = document.createElement("button"); b1.className = "btn btn-secondary"; b1.innerText = "Cancelar"; b1.onclick = () => ov.remove();
        const b2 = document.createElement("button"); b2.className = "btn btn-custom"; b2.style.flex = "1"; b2.innerText = "Continuar";
        b2.onclick = () => { if (sel.value) { ov.remove(); cb(sel.value); } };
        row.appendChild(b1); row.appendChild(b2); card.appendChild(row);
        ov.appendChild(card); document.body.appendChild(ov);
      }

      // --- NUEVA FUNCI√ìN: SELECTOR DE FECHAS MODAL ---
      function mostrarSelectorFechas(callback) {
        const ov = document.createElement("div");
        ov.className = "pregunta-overlay";
        const card = document.createElement("div");
        card.className = "pregunta-card";

        card.innerHTML = `
        <h5 style="color:#015249; text-align:center; margin-bottom:15px; font-weight:bold;">Seleccione el Rango</h5>
        <div class="mb-2">
            <label class="form-label" style="font-size:0.8rem; font-weight:bold;">Fecha Inicio</label>
            <input type="date" id="tempFechaIni" class="form-control">
        </div>
        <div class="mb-4">
            <label class="form-label" style="font-size:0.8rem; font-weight:bold;">Fecha Fin</label>
            <input type="date" id="tempFechaFin" class="form-control">
        </div>
        <div style="display:flex; gap:10px;">
            <button id="btnCancelFecha" class="btn btn-secondary">Cancelar</button>
            <button id="btnConfirmFecha" class="btn btn-custom" style="flex:1;">Generar</button>
        </div>
        `;
        ov.appendChild(card);
        document.body.appendChild(ov);

        document.getElementById("btnCancelFecha").onclick = () => ov.remove();
        document.getElementById("btnConfirmFecha").onclick = () => {
          const ini = document.getElementById("tempFechaIni").value;
          const fin = document.getElementById("tempFechaFin").value;
          if (ini && fin) {
            if (ini > fin) { alert("La fecha de inicio no puede ser mayor a la fecha fin."); return; }
            ov.remove();
            callback(ini, fin);
          } else { alert("Por favor seleccione ambas fechas."); }
        };
      }

      function activarL√≥gicaInteractividadInformes(cid) {
        // 1. Definimos las opciones base
        let opciones = [
          { value: "granja", text: "Por Granja" },
          { value: "zona", text: "Por Zona" },
          { value: "general", text: "General" }
        ];

        // 2. Si es el cliente Pollos Gar, agregamos la opci√≥n de Validaci√≥n
        if (cid === '890707006') {
          opciones.push({ value: "validacion", text: "üßê Validaci√≥n Tanqueos" });
        }

        // 3. Mostramos la pregunta
        mostrarPregunta("Tipo de informe", opciones, (t) => {

          // CASO A: Si elige Validaci√≥n, cargamos la vista de validaci√≥n inmediatamente
          if (t === "validacion") {
            cargarValidacionesTanqueos(cid);
            return; // Detenemos aqu√≠, no preguntamos fechas
          }

          // CASO B: Informes normales (Sigue el flujo de fechas/ubicaci√≥n)
          if (t === "general") {
            pregPeriodo(cid, t, null);
          } else {
            fetch('/obtener_ubicaciones', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ tipo: t, empresa_id: cid })
            })
              .then(r => r.json())
              .then(d => {
                if (d.success) {
                  mostrarPregunta(`Seleccione ${t}`, d.ubicaciones.map(u => ({ value: u, text: u })), (u) => pregPeriodo(cid, t, u));
                }
              });
          }
        });
      }

      function pregPeriodo(cid, t, u) {
        mostrarPregunta("Periodo", [
          { value: "Actual", text: "Actual (Activos)" },
          { value: "Personalizado", text: "Hist√≥rico" }
        ], (p) => {
          if (p === "Personalizado") {
            // USAR NUEVO SELECTOR DE FECHAS
            mostrarSelectorFechas((ini, fin) => {
              generarInformeFinal(cid, t, u, p, ini, fin);
            });
          } else {
            generarInformeFinal(cid, t, u, p, null, null);
          }
        });
      }

      function generarInformeFinal(eid, t, u, p, ini, fin) {
        fetch('/generar_informe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tipo_informe: t, periodo: p, fecha_inicio: ini, fecha_fin: fin, ubicacion: u, empresa_id: eid })
        })
          .then(r => r.json()).then(resp => {
            if (resp.success) {
              datosGlobales = resp.data;
              document.getElementById("tituloInforme").textContent = `Informe GLP ${u || ''}`;

              // --- CAMBIO: Solo mostramos fechas si es Personalizado ---
              let textoMostrar = p; // Por defecto toma el valor "Actual"

              if (p === "Personalizado" && ini && fin) {
                textoMostrar = `Del ${ini} al ${fin}`;
              }
              // Si es "Actual", se queda intacto como "Actual".

              document.getElementById("subtituloPeriodo").textContent = textoMostrar;

              renderizarInforme(resp.data);
            } else alert(resp.message);
          });
      }


    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>