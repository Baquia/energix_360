<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="apple-touch-icon" href="/static/icon-192.png">
  <title>Panel Webmaster BQA-ONE</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#015249">

  <script src="/static/js/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>


  <style>
    /* ========================================= */
    /* 1. VARIABLES Y DISE√ëO H√çBRIDO (PC/M√ìVIL)  */
    /* ========================================= */
    :root {
      --color-primary: #015249;
      --color-primary-dark: #003832;
      --header-height: 60px;
      --bg-light: #f6f7f8;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-light);
      color: #1f2937;
      padding-top: var(--header-height);
      /* Espacio para el header fijo */
      overflow-x: hidden;
    }

    /* HEADER FIJO */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--header-height);
      background: white;
      z-index: 1040;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .btn-hamburguesa {
      display: none;
      /* Oculto en PC */
      background: none;
      border: none;
      font-size: 1.6rem;
      color: var(--color-primary);
      cursor: pointer;
      padding: 5px;
      margin-right: 10px;
    }

    /* LAYOUT PRINCIPAL */
    .layout {
      display: flex;
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
      gap: 20px;
      position: relative;
    }

    /* SIDEBAR (PC: Fijo / M√≥vil: Oculto) */
    .sidebar-left {
      flex: 0 0 260px;
      width: 260px;
      background: linear-gradient(180deg, var(--color-primary) 0%, #002521 100%);
      color: white;
      border-radius: 12px;
      height: calc(100vh - 90px);
      position: sticky;
      top: 80px;
      overflow-y: auto;
      box-shadow: 4px 0 15px rgba(0, 0, 0, 0.05);
      z-index: 1000;
      transition: transform 0.3s ease;
    }

    .main-content {
      flex: 1;
      min-width: 0;
    }

    /* NAVEGACI√ìN */
    .sidebar-section-title {
      padding: 15px 20px 10px 20px;
      font-size: 0.75rem;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.5);
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
    }

    .nav-item {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 12px 20px;
      color: #e2e8f0;
      background: transparent;
      border: none;
      text-align: left;
      font-size: 0.95rem;
      border-left: 4px solid transparent;
      cursor: pointer;
      text-decoration: none;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.15);
      border-left-color: #34d399;
      color: white;
      font-weight: 600;
    }

    .submenu-operacion {
      background-color: #002f2a;
      padding-left: 35px;
      font-size: 0.85rem;
      color: #94a3b8;
    }

    .submenu-operacion:hover {
      color: #4ade80;
      background-color: #002521;
    }

    .icon-spacer {
      display: inline-flex;
      width: 25px;
      justify-content: center;
      margin-right: 10px;
    }

    /* ========================================= */
    /* 2. MEDIA QUERIES (M√ìVIL)                  */
    /* ========================================= */
    @media (max-width: 992px) {

      /* Header */
      .btn-hamburguesa {
        display: block;
      }

      .header h4 {
        font-size: 1.1rem;
      }

      /* Layout */
      .layout {
        display: block;
        padding: 10px;
      }

      /* Sidebar Offcanvas */
      .sidebar-left {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 280px;
        border-radius: 0;
        transform: translateX(-105%);
        /* Oculto */
        z-index: 2000;
      }

      .sidebar-left.show {
        transform: translateX(0);
      }

      /* Overlay Oscuro */
      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1999;
        display: none;
        backdrop-filter: blur(2px);
      }

      .sidebar-overlay.show {
        display: block;
      }

      /* Ajustes generales m√≥vil */
      .form-section {
        padding: 15px;
      }

      .btn {
        padding: 10px 15px;
        font-size: 1rem;
      }

      /* Botones m√°s grandes */
      .table-responsive {
        font-size: 0.85rem;
      }
    }

    /* ========================================= */
    /* 3. ESTILOS ESPEC√çFICOS (KPIs, Audit, PDF) */
    /* ========================================= */

    /* KPI CARDS */
    .kpi-card-box {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      padding: 20px;
      text-align: center;
      border-top: 5px solid #ccc;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .kpi-value {
      font-size: 1.5rem;
      font-weight: 800;
      color: #111;
    }

    /* Colores KPI */
    .border-kpi-1 {
      border-color: #3b82f6;
    }

    .text-kpi-1 {
      color: #3b82f6;
    }

    .border-kpi-2 {
      border-color: #10b981;
    }

    .text-kpi-2 {
      color: #10b981;
    }

    .border-kpi-3 {
      border-color: #f59e0b;
    }

    .text-kpi-3 {
      color: #f59e0b;
    }

    .border-kpi-4 {
      border-color: #6366f1;
    }

    .text-kpi-4 {
      color: #6366f1;
    }

    .border-kpi-5 {
      border-color: #64748b;
    }

    .border-kpi-6 {
      border-color: #ec4899;
    }

    .text-kpi-6 {
      color: #ec4899;
    }

    /* AUDIT LOG */
    .audit-modal-body {
      background: #f8f9fa;
      max-height: 70vh;
      overflow-y: auto;
      padding: 20px;
    }

    .timeline {
      border-left: 2px solid #e0e0e0;
      padding-left: 30px;
      margin-top: 10px;
    }

    .timeline-item {
      position: relative;
      margin-bottom: 25px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      border-left: 4px solid #ccc;
    }

    .timeline-dot {
      position: absolute;
      left: -39px;
      top: 15px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: white;
      border: 3px solid #ccc;
    }

    .mod-glp {
      border-color: #015249;
    }

    .mod-glp .timeline-dot {
      border-color: #015249;
    }

    .mod-alerta {
      border-color: #ef4444;
    }

    .mod-alerta .timeline-dot {
      border-color: #ef4444;
    }

    .live-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      background-color: #22c55e;
      border-radius: 50%;
      margin-right: 5px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
      }

      70% {
        box-shadow: 0 0 0 6px rgba(34, 197, 94, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
      }
    }

    /* ESTILOS PDF FANTASMA */
    #contenedorFantasma {
      position: absolute;
      left: -9999px;
      top: 0;
    }

    #reporteImpresion {
      width: 750px;
      padding: 40px;
      background: white;
      font-family: Arial, sans-serif;
      display: none;
    }

    .modo-impresion #reporteImpresion {
      display: block !important;
    }

    .rep-header {
      display: flex;
      justify-content: space-between;
      border-bottom: 2px solid #015249;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .rep-logo {
      height: 60px;
      object-fit: contain;
    }

    .rep-grid-info {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
      padding: 15px;
      background: #f9f9f9;
    }

    .rep-item label {
      font-size: 10px;
      font-weight: bold;
      color: #555;
      text-transform: uppercase;
      display: block;
    }

    .rep-item span {
      font-size: 12px;
      font-weight: bold;
    }

    .rep-kpis {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .rep-card {
      border: 1px solid #000;
      padding: 15px;
      text-align: center;
      border-radius: 4px;
    }

    .rep-card-label {
      font-size: 10px;
      font-weight: bold;
      color: #555;
      text-transform: uppercase;
    }

    .rep-card-value {
      font-size: 18px;
      font-weight: bold;
      color: #015249;
    }

    .rep-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-bottom: 20px;
    }

    .rep-table th,
    .rep-table td {
      border: 1px solid #000;
      padding: 5px;
      text-align: center;
    }

    #repGraficoImg {
      width: 100%;
      height: 250px;
      object-fit: contain;
      border: 1px solid #eee;
      display: block;
      margin: 0 auto;
    }

    /* UTILIDADES */
    .form-section {
      display: none;
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .form-section.active {
      display: block;
    }

    .btn-custom {
      background-color: var(--color-primary);
      color: white;
      border: none;
    }

    .btn-custom:hover {
      background-color: var(--color-primary-dark);
      color: white;
    }

    /* OVERLAY PREGUNTAS */
    .pregunta-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 50, 40, 0.7);
      backdrop-filter: blur(3px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .pregunta-card {
      background: white;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    /* TARJETA VALIDACI√ìN (NUEVO ESTILO RESPONSIVE) */
    .validacion-grid {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .tanqueo-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .tanqueo-header {
      background: var(--color-primary);
      color: white;
      padding: 10px 15px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
    }

    .thumb-val {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ddd;
      cursor: zoom-in;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }
  </style>

</head>
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js").catch(err => console.error("Error SW:", err));
    });
  }
</script>

<body>
  <div id="mobileOverlay" class="sidebar-overlay" onclick="toggleMenu()"></div>

  <div class="header">
    <div class="d-flex align-items-center">
      <button class="btn-hamburguesa" onclick="toggleMenu()">‚ò∞</button>
      <h4 class="m-0 fw-bold" style="color: var(--color-primary);">Panel Webmaster</h4>
    </div>

    <div class="d-none d-md-block text-center text-muted small fw-bold">
      {{ nombre }} | {{ empresa }}
    </div>

    <div>
      <a href="/logout" class="btn btn-outline-danger btn-sm">Salir</a>
    </div>
  </div>

  <div class="layout">

    <div class="sidebar-left" id="sidebarMenu">

      <div class="d-lg-none p-3 border-bottom border-secondary mb-2 text-end">
        <button class="btn btn-sm btn-light w-100" onclick="toggleMenu()">‚úï Cerrar Men√∫</button>
      </div>

      <div class="sidebar-section-title" data-bs-toggle="collapse" data-bs-target="#seccionAdmin">
        <span>ADMINISTRACI√ìN</span> <span>‚ñæ</span>
      </div>
      <div class="collapse show" id="seccionAdmin">
        <button class="nav-item" onclick="abrirAuditLog()">
          <span class="icon-spacer">üëÅÔ∏è</span> Audit Log
        </button>
        <button class="nav-item" onclick="activarMenu(this, 'crearEmpresa')">
          <span class="icon-spacer">üè¢</span> Crear Empresa
        </button>

        <button class="nav-item" type="button" data-bs-toggle="collapse" data-bs-target="#menuPerfiles">
          <span class="icon-spacer">üë•</span> Gesti√≥n Perfiles
        </button>
        <div class="collapse" id="menuPerfiles">
          <button class="nav-item submenu-operacion" onclick="activarMenu(this, 'crearPerfil')">Crear Nuevo</button>
          <button class="nav-item submenu-operacion" onclick="activarMenu(this, 'editarPerfil')">Editar
            Existente</button>
        </div>

        <button class="nav-item" type="button" data-bs-toggle="collapse" data-bs-target="#menuUsuarios">
          <span class="icon-spacer">üë§</span> Gesti√≥n Usuarios
        </button>
        <div class="collapse" id="menuUsuarios">
          <button class="nav-item submenu-operacion" onclick="activarMenu(this, 'crearUsuario')">Crear Usuario</button>
          <button class="nav-item submenu-operacion" onclick="activarMenu(this, 'editarUsuario')">Editar
            Usuario</button>
        </div>
      </div>

      <div class="sidebar-section-title mt-2" data-bs-toggle="collapse" data-bs-target="#seccionInformes">
        <span>INFORMES GLP</span> <span>‚ñæ</span>
      </div>
      <div class="collapse show" id="seccionInformes">
        <div class="client-list">
          <button class="nav-item" onclick="cargarOperacionesModerno(this, '890707006')">
            <span class="icon-spacer">üêî</span> Pollos Gar SAS
          </button>
          <button class="nav-item" onclick="cargarOperacionesModerno(this, '900977113')">
            <span class="icon-spacer">üèñÔ∏è</span> Fenix Beach
          </button>
          <button class="nav-item" onclick="cargarOperacionesModerno(this, '901370428')">
            <span class="icon-spacer">üõí</span> Mercacentro
          </button>
        </div>
      </div>

      <div id="contenedorOperaciones"
        style="display:none; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px;">
        <div class="sidebar-section-title" style="color: #4ade80;" data-bs-toggle="collapse"
          data-bs-target="#listaOperacionesDinamica">
          <span>OPERACIONES</span> <span>‚ñæ</span>
        </div>
        <div id="listaOperacionesDinamica" class="collapse show"></div>
      </div>

      <div style="display:none;">
        <select id="menuDesplegable" class="form-select" onchange="mostrarFormularioSeleccionado()"></select>
        <select id="clienteSelect" class="form-select" onchange="cargarOperaciones()">
          <option value="">INFORMES</option>
          <option value="890707006">Pollos Gar SAS</option>
          <option value="900977113">Fenix Beach Cartagena</option>
          <option value="901370428">Mercacentro</option>
        </select>
        <ul id="submenu" class="submenu"></ul>
        <div id="submenuContainer"></div>
      </div>
    </div>


    <div class="main-content">
      <div id="seccionAprobacionesGLP" class="form-section">
        <h4 class="mb-3 text-primary">Aprobaci√≥n de Solicitudes GLP</h4>
        <p class="text-muted small">Analice las solicitudes de consumo y apruebe para que el cliente pueda enviarlas.
        </p>

        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark">
              <tr>
                <th>Fecha</th>
                <th>Cliente / Sede</th>
                <th>Lote (D√≠as)</th>
                <th>Tanques (Nivel Actual)</th>
                <th>Solicita</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="tablaAprobacionesGLP">
            </tbody>
          </table>
        </div>
        <div id="msgSinAprobaciones" class="alert alert-info text-center" style="display:none;">
          No hay solicitudes pendientes.
        </div>
      </div>

      <div id="crearEmpresa" class="form-section">
        <h4 class="mb-3">Crear Empresa</h4>
        <form id="formCrearEmpresa" data-url="/registrar_empresa" data-confirmar="¬øDesea registrar esta empresa?">
          <div class="mb-2"><label>Nombre Comercial</label><input type="text" name="nombre_comercial"
              class="form-control"></div>
          <div class="mb-2"><label>NIT</label><input type="text" name="nit" class="form-control"></div>
          <div class="mt-3"><button type="button" class="btn btn-custom"
              onclick="confirmarEnvioGenerico('formCrearEmpresa')">Registrar</button></div>
        </form>
      </div>

      <div id="crearPerfil" class="form-section">
        <h5 class="mb-3">Crear Perfil</h5>
        <form id="form_crearPerfil" data-url="/registrar_perfil" data-confirmar="¬øDesea registrar este perfil?">
          <div class="mb-3">
            <label class="form-label">Empresa</label>
            <select name="empresa_select" class="form-select" onchange="actualizarNit()">
              <option value="">Seleccione una empresa</option>
              {% for empresa in empresas %}
              <option data-nit="{{ empresa.nit }}" value="{{ empresa.nombre_comercial }}">{{ empresa.nombre_comercial }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3"><label class="form-label">NIT</label><input type="text" id="nit" name="nit"
              class="form-control"></div>
          <div class="mb-3">
            <label class="form-label">Operaci√≥n</label>
            <select name="operacion" class="form-select">
              <option value="Electricidad">Gestion Electricidad</option>
              <option value="Gas">Gestion Gas Avicola</option>
              <option value="Carbon">Gestion Carb√≥n</option>
            </select>
          </div>
          <div class="mb-3"><label class="form-label">Nombre del Perfil</label><input type="text" name="perfil"
              class="form-control"></div>
          <div class="mt-3"><button type="button" class="btn btn-custom"
              onclick="confirmarEnvioGenerico('form_crearPerfil')">Registrar</button></div>
        </form>
      </div>

      <div id="crearUsuario" class="form-section">
        <h4 class="mb-3">Crear Usuario</h4>
        <form id="form_crearUsuario" data-url="/registrar_usuario" data-confirmar="¬øDesea registrar este usuario?">
          <div class="mb-2"><label>C√©dula</label><input type="text" name="cedula" class="form-control"></div>
          <div class="mb-2"><label>Nombre</label><input type="text" name="nombre" class="form-control"></div>
          <div class="mb-2"><label>Contrase√±a</label><input type="password" name="password" class="form-control"></div>
          <div class="mb-2"><label>Empresa</label>
            <select id="empresa_select_usuario" name="empresa_select" class="form-select"
              onchange="actualizarEmpresaUsuario()">
              <option value="">Seleccione...</option>
              {% for empresa in empresas %}
              <option data-id="{{ empresa.nit }}" value="{{ empresa.nombre_comercial }}">{{ empresa.nombre_comercial }}
              </option>
              {% endfor %}
            </select>
          </div>
          <input type="hidden" id="empresa_id" name="empresa_id">
          <div class="mb-2">
            <label>Operaci√≥n</label>
            <select id="operacion_usuario" name="operacion" class="form-select"
              onchange="actualizarPerfilesPorEmpresaYOperacion()">
              <option value="Gas">Gas</option>
            </select>
          </div>
          <div class="mb-2"><label>Perfil</label><select id="perfil_usuario" name="perfil" class="form-select"></select>
          </div>
          <div class="mt-3"><button type="button" class="btn btn-custom"
              onclick="confirmarEnvioGenerico('form_crearUsuario')">Registrar</button></div>
        </form>
      </div>

      <div id="seccionInforme" class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h4 id="tituloInforme" style="color: var(--color-primary); font-weight:700; margin-bottom: 0;">Informe GLP
            </h4>
            <small id="subtituloPeriodo" class="text-muted fw-bold">Periodo...</small>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-custom btn-sm" id="btnDescargarPdf" onclick="descargarPDF()">Descargar PDF</button>
            <button class="btn btn-danger btn-sm" onclick="cerrarInforme()">Cerrar</button>
          </div>
        </div>

        <div class="row g-3 mb-4" id="kpiContainer">
          <div class="col-md-4 col-6" id="kpiCard1">
            <div class="kpi-card-box border-kpi-1">
              <div class="kpi-label" id="kpi1Label">Saldo Inicial</div>
              <div class="kpi-value text-kpi-1" id="kpi1Value">0</div>
            </div>
          </div>
          <div class="col-md-4 col-6" id="kpiCard2">
            <div class="kpi-card-box border-kpi-2">
              <div class="kpi-label" id="kpi2Label">Pedidos Gas</div>
              <div class="kpi-value text-kpi-2" id="kpi2Value">0</div>
            </div>
          </div>
          <div class="col-md-4 col-6" id="kpiCard3">
            <div class="kpi-card-box border-kpi-3">
              <div class="kpi-label" id="kpi3Label">Consumos</div>
              <div class="kpi-value text-kpi-3" id="kpi3Value">0</div>
            </div>
          </div>
          <div class="col-md-4 col-6" id="kpiCard5">
            <div class="kpi-card-box border-kpi-5">
              <div class="kpi-label" id="kpi5Label">Pollitos</div>
              <div class="kpi-value" id="kpi5Value" style="color: #475569;">0</div>
            </div>
          </div>
          <div class="col-md-4 col-6" id="kpiCard6">
            <div class="kpi-card-box border-kpi-6">
              <div class="kpi-label" id="kpi6Label">Inversi√≥n ($)</div>
              <div class="kpi-value text-kpi-6" id="kpi6Value">0</div>
            </div>
          </div>
          <div class="col-md-4 col-6" id="kpiCard4">
            <div class="kpi-card-box border-kpi-4">
              <div class="kpi-label" id="kpi4Label">Eficiencia</div>
              <div class="kpi-value text-kpi-4" id="kpi4Value">0</div>
            </div>
          </div>
        </div>

        <div class="card p-3 mb-4 shadow-sm border-0">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title m-0 fs-6 text-primary">An√°lisis Gr√°fico</h5>
            <div class="btn-group">
              <button type="button" class="btn btn-outline-primary btn-sm active"
                onclick="cambiarVistaGrafico('rendimiento')">Rendimiento</button>
              <button type="button" class="btn btn-outline-primary btn-sm"
                onclick="cambiarVistaGrafico('saldos')">Saldos</button>
            </div>
          </div>
          <div style="height: 320px; width: 100%;">
            <canvas id="graficoConsumo"></canvas>
          </div>
        </div>

        <div class="card p-3 shadow-sm border-0">
          <h5 class="card-title mb-3 fs-6 text-primary">Resumen por Granja</h5>
          <div class="table-responsive">
            <table id="tablaConsumo" class="table table-hover table-bordered table-sm text-center mb-0">
              <thead class="table-light">
                <tr></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="seccionValidacionTanqueos" class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 style="color: var(--color-primary); font-weight:700;">Validaci√≥n Tanqueos</h4>
          <button class="btn btn-secondary btn-sm" onclick="cerrarValidacionView()">&times; Cerrar</button>
        </div>

        <div id="loadingTanqueos" style="display:none; text-align:center; color:#666; padding: 20px;">
          <div class="spinner-border text-primary" role="status"></div>
          <div class="mt-2">Cargando pendientes...</div>
        </div>

        <div id="gridTanqueos" class="validacion-grid"></div>

        <div id="emptyTanqueos" style="display:none; text-align:center; padding:40px; color:#999;">
          ‚úÖ No hay tanqueos pendientes de validaci√≥n.
        </div>
      </div>

    </div>
    <div class="modal fade" id="modalDecisionTanqueo" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Validar Tanqueo</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center p-4">
            <h4 class="mb-3">¬øInformaci√≥n correcta?</h4>
            <p class="text-muted mb-4 small">
              <strong>SI:</strong> Aprueba y borra fotos.<br>
              <strong>NO:</strong> Alerta a Gerencia y borra fotos.
            </p>
            <div class="d-flex gap-3 justify-content-center">
              <button class="btn btn-danger px-4" onclick="confirmarDecisionTanqueo('NO')">NO</button>
              <button class="btn btn-success px-4" onclick="confirmarDecisionTanqueo('SI')">SI</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalConfirmacionGlobal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmaci√≥n</h5><button type="button" class="btn-close"
              data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="modalMensajeGlobal"></div>
          <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">No</button><button
              class="btn btn-custom" id="btnConfirmarGlobal">S√≠</button></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalAuditLog" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered"">
        <div class=" modal-content">
        <div class="modal-header" style="background-color: #015249; color: white;">
          <h5 class="modal-title">
            Bit√°cora de Eventos
            <small style="font-size: 0.7rem; color: #82e9de; margin-left: 10px;">
              <span class="live-indicator"></span> En vivo
            </small>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="p-3 bg-white border-bottom">
          <select id="selectEmpresaAudit" class="form-select" onchange="cargarLogAudit()">
            <option value="">-- Seleccione Empresa --</option>
            {% for empresa in empresas %}
            <option value="{{ empresa.nit }}">{{ empresa.nombre_comercial }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="audit-modal-body">
          <div id="auditTimeline" class="timeline">
            <div class="text-center text-muted mt-4">Selecciona una empresa...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="lightboxSimple"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10000; justify-content:center; align-items:center;"
    onclick="this.style.display='none'">
    <img id="lbImg" src="" style="max-width:90%; max-height:90%; border:2px solid white; border-radius:4px;">
  </div>

  <div id="contenedorFantasma">
    <div id="contenedorFantasma">
      <div id="reporteImpresion">
        <div class="rep-header">
          <img id="repLogoCliente" src="" class="rep-logo">
          <div class="rep-title text-center">
            <h2 id="repTituloPrincipal">Informe de Gesti√≥n GLP</h2>
            <p id="repSubtituloPrincipal">Generado por Webmaster BQA-ONE</p>
          </div>
          <img src="/static/logo_energix360.png" class="rep-logo">
        </div>

        <div class="rep-grid-info">
          <div class="rep-item"><label>Cliente</label><span id="repCliente">---</span></div>
          <div class="rep-item"><label>Ubicaci√≥n</label><span id="repUbicacion">---</span></div>
          <div class="rep-item"><label>Periodo/Lote</label><span id="repPeriodo">---</span></div>
          <div class="rep-item"><label>Fecha Reporte</label><span id="repFecha">---</span></div>
          <div class="rep-item"><label>Responsable</label><span id="repUsuario">{{ nombre }}</span></div>
        </div>

        <div id="repSectionKPIs">
          <div class="rep-section-title">Indicadores Clave</div>
          <div class="rep-kpis">
            <div class="rep-card">
              <div class="rep-card-label" id="lblKpi1"></div>
              <div class="rep-card-value" id="valKpi1"></div>
            </div>
            <div class="rep-card">
              <div class="rep-card-label" id="lblKpi2"></div>
              <div class="rep-card-value" id="valKpi2"></div>
            </div>
            <div class="rep-card">
              <div class="rep-card-label" id="lblKpi3"></div>
              <div class="rep-card-value" id="valKpi3"></div>
            </div>
            <div class="rep-card">
              <div class="rep-card-label" id="lblKpi4"></div>
              <div class="rep-card-value" id="valKpi4"></div>
            </div>
            <div class="rep-card">
              <div class="rep-card-label" id="lblKpi5"></div>
              <div class="rep-card-value" id="valKpi5"></div>
            </div>
            <div class="rep-card">
              <div class="rep-card-label" id="lblKpi6"></div>
              <div class="rep-card-value" id="valKpi6"></div>
            </div>
          </div>
        </div>

        <div id="repSectionGraph">
          <div class="rep-section-title">Gr√°fica</div>
          <img id="repGraficoImg" src="">
        </div>

        <div class="rep-section-title" style="margin-top:20px;">Detalle</div>
        <table class="rep-table" id="repTablaMain">
          <thead>
          </thead>
          <tbody id="repTablaBody"></tbody>
        </table>

        <div
          style="margin-top: 40px; border-top: 1px solid #ccc; padding-top: 10px; font-size: 10px; color: #888; text-align: center;">
          Generado autom√°ticamente por BQA ONE. <span id="repFooterFecha"></span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 1. CONTROL DE MEN√ö M√ìVIL (NUEVO)
    function toggleMenu() {
      const sidebar = document.getElementById('sidebarMenu');
      const overlay = document.getElementById('mobileOverlay');
      sidebar.classList.toggle('show');
      overlay.classList.toggle('show');
    }

    // Cerrar men√∫ al hacer clic en opciones (Solo m√≥vil)
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        if (window.innerWidth < 992) {
          toggleMenu();
        }
      });
    });

    // 2. LOGICA AUDIT LOG
    let auditInterval = null;
    function abrirAuditLog() {
      new bootstrap.Modal(document.getElementById('modalAuditLog')).show();
      document.getElementById('selectEmpresaAudit').value = "";
      document.getElementById('auditTimeline').innerHTML = '<div class="text-center text-muted mt-4">Selecciona una empresa...</div>';
      if (auditInterval) clearInterval(auditInterval);
      document.getElementById('modalAuditLog').addEventListener('hidden.bs.modal', function () {
        if (auditInterval) clearInterval(auditInterval);
      });
    }
    function cargarLogAudit() {
      const nit = document.getElementById('selectEmpresaAudit').value;
      if (!nit) return;
      fetchAuditData(nit);
      if (auditInterval) clearInterval(auditInterval);
      auditInterval = setInterval(() => { fetchAuditData(nit); }, 5000);
    }
    function fetchAuditData(nit) {
      const formData = new FormData(); formData.append('empresa_id', nit);
      fetch('/obtener_audit_log', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => { if (data.success) renderTimeline(data.logs); });
    }
    function renderTimeline(logs) {
      const container = document.getElementById('auditTimeline');

      if (logs.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">No hay eventos.</div>';
        return;
      }

      let html = '';

      logs.forEach(log => {
        // 1. L√≥gica para el Borde Lateral (M√≥dulo)
        let modClass = 'mod-admin'; // Por defecto
        if (log.modulo === 'GLP') modClass = 'mod-glp';

        // 2. L√≥gica para Iconos de Estado (√âxito vs Error)
        const nivel = (log.nivel || 'INFO').toUpperCase();
        let iconStatus = '‚úÖ';        // Por defecto: Chulito Verde
        let titleColor = '#198754';   // Verde Bootstrap (text-success)

        // Si detectamos palabras clave de error
        if (nivel.includes('ERROR') || nivel.includes('ALERTA') || nivel.includes('FALLO') || nivel.includes('CRITICO')) {
          modClass = 'mod-alerta';  // Borde rojo
          iconStatus = '‚ùå';        // X Roja
          titleColor = '#dc3545';   // Rojo Bootstrap (text-danger)
        }
        // Opcional: Si es una advertencia
        else if (nivel.includes('WARN') || nivel.includes('ADVERTENCIA')) {
          iconStatus = '‚ö†Ô∏è';
          titleColor = '#ffc107';   // Amarillo
        }

        const userIcon = log.usuario === 'Sistema' ? 'ü§ñ' : 'üë§';

        html += `
            <div class="timeline-item ${modClass}">
                <div class="timeline-dot"></div>
                <div class="t-header">
                    <span class="t-module">${log.modulo}</span>
                    <span class="t-date">${log.fecha}</span>
                </div>
                
                <div class="t-title" style="color: ${titleColor}; font-weight: 700;">
                    ${iconStatus} ${log.accion}
                </div>
                
                <div class="t-user" style="font-size:0.8rem; color:#555;">${userIcon} ${log.usuario}</div>
                <div class="t-detail text-muted small">${log.detalle}</div>
            </div>`;
      });

      container.innerHTML = html;
    }

    // 3. NAVEGACION
    function activarMenu(elemento, formularioId) {
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      if (elemento) elemento.classList.add('active');
      mostrarFormulario(formularioId);
      cerrarInforme();
    }

    function cargarOperacionesModerno(elemento, clienteId) {
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      if (elemento) elemento.classList.add('active');
      const contenedor = document.getElementById("contenedorOperaciones");
      const lista = document.getElementById("listaOperacionesDinamica");
      lista.innerHTML = '';

      // Actualizar select oculto para compatibilidad
      const selectViejo = document.getElementById("clienteSelect");
      if (selectViejo) { selectViejo.value = clienteId; }

      if (operaciones[clienteId]) {
        contenedor.style.display = 'block';
        operaciones[clienteId].forEach(op => {
          const btn = document.createElement("button");
          btn.className = "nav-item submenu-operacion";
          btn.innerHTML = `<span class="icon-spacer">üîπ</span> ${op.replace('Gestion ', '')}`;
          if (op === "Gestion Gas Avicola") {
            btn.onclick = function () {
              document.querySelectorAll('.submenu-operacion').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              activarL√≥gicaInteractividadInformes(clienteId);
            };
            lista.appendChild(btn);
          } else {
            btn.onclick = function () { alert("Opci√≥n: " + op); };
            lista.appendChild(btn);
          }
        });
      } else { contenedor.style.display = 'none'; }

      document.querySelectorAll('.form-section').forEach(div => div.style.display = 'none');
      cerrarInforme();
      if (typeof cerrarValidacionView === 'function') cerrarValidacionView();
    }

    // 4. VALIDACI√ìN DE TANQUEOS (MODIFICADO PARA M√ìVIL)
    let idTanqueoSeleccionado = null;
    function cerrarValidacionView() { document.getElementById('seccionValidacionTanqueos').style.display = 'none'; }
    function verFoto(src) { document.getElementById('lbImg').src = src; document.getElementById('lightboxSimple').style.display = 'flex'; }

    function cargarValidacionesTanqueos(empresaId) {
      // Mostrar secci√≥n
      document.querySelectorAll('.form-section').forEach(el => el.style.display = 'none');
      document.getElementById('seccionValidacionTanqueos').style.display = 'block';

      const grid = document.getElementById('gridTanqueos');
      const loading = document.getElementById('loadingTanqueos');
      const empty = document.getElementById('emptyTanqueos');

      grid.innerHTML = '';
      loading.style.display = 'block';
      empty.style.display = 'none';

      fetch('/obtener_tanqueos_validacion', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ empresa_id: empresaId })
      })
        .then(r => r.json())
        .then(data => {
          loading.style.display = 'none';
          if (data.success && data.items.length > 0) {
            data.items.forEach(item => {
              let filasHtml = '';
              item.subfilas.forEach(t => {
                const imgA = t.foto_antes ? `<img src="${t.foto_antes}" class="thumb-val" onclick="verFoto(this.src)">` : '<span class="badge bg-light text-dark border">Sin foto</span>';
                const imgD = t.foto_despues ? `<img src="${t.foto_despues}" class="thumb-val" onclick="verFoto(this.src)">` : '<span class="badge bg-light text-dark border">Sin foto</span>';
                const imgV = t.foto_voucher ? `<img src="${t.foto_voucher}" class="thumb-val" onclick="verFoto(this.src)">` : '<span class="badge bg-warning text-dark">Pendiente</span>';

                filasHtml += `
                    <tr>
                        <td class="fw-bold text-primary">TK-${t.numero}</td>
                        <td class="text-center border-start"><div class="small text-muted">Antes</div><strong>${t.pct_antes}%</strong>${imgA}</td>
                        <td class="text-center border-start"><div class="small text-muted">Desp</div><strong>${t.pct_despues}%</strong>${imgD}</td>
                        <td class="text-center border-start"><div class="small text-muted">Voucher</div>${imgV}</td>
                        <td class="text-center align-middle border-start"><input type="checkbox" class="chk-pre form-check-input" style="width:20px;height:20px;"></td>
                    </tr>`;
              });

              // --- AQU√ç EST√Å EL CAMBIO CLAVE PARA RESPONSIVE (BOOTSTRAP GRID) ---
              const card = document.createElement('div');
              card.className = 'tanqueo-card shadow-sm mb-3';
              card.id = `card-t-${item.id}`;

              card.innerHTML = `
                    <div class="tanqueo-header d-flex justify-content-between">
                        <span>üìÖ ${item.fecha}</span>
                        <span>${item.ubicacion}</span>
                    </div>
                    <div class="row g-0">
                        <div class="col-12 col-md-3 p-3 bg-light border-bottom border-md-end">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-secondary">${item.empresa}</span>
                                <span class="badge bg-info text-dark">${item.usuario}</span>
                            </div>
                            <div class="small text-muted">Lote:</div>
                            <code class="d-block mb-2 text-dark">${item.lote}</code>
                            <div class="alert alert-warning py-1 px-2 small mb-0"><i class="icon-info"></i> Verificar fotos.</div>
                        </div>
                        
                        <div class="col-12 col-md-7 p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-borderless align-middle mb-0"><tbody>${filasHtml}</tbody></table>
                            </div>
                        </div>

                        <div class="col-12 col-md-2 p-3 border-top border-md-start bg-white">
                             <div class="d-grid gap-2 h-100 align-content-center">
                                <button class="btn btn-success" onclick="validarChecks(${item.id})">‚úÖ VALIDAR</button>
                                <button class="btn btn-outline-danger" onclick="abrirModalDecision(${item.id}, 'NO')">‚ùå RECHAZAR</button>
                             </div>
                        </div>
                    </div>
                `;
              grid.appendChild(card);
            });
          } else { empty.style.display = 'block'; }
        })
        .catch(err => { loading.style.display = 'none'; console.error(err); alert("Error cargando datos."); });
    }

    function validarChecks(id) {
      const card = document.getElementById(`card-t-${id}`);
      const checks = card.querySelectorAll('.chk-pre');
      let ok = true;
      checks.forEach(c => { if (!c.checked) ok = false; });
      if (!ok) { alert("‚ö†Ô∏è Marca todos los checkboxes de revisi√≥n."); return; }
      idTanqueoSeleccionado = id;
      confirmarDecisionTanqueo('SI');
    }

    function abrirModalDecision(id, tipo) {
      idTanqueoSeleccionado = id;
      if (tipo === 'NO') { if (confirm("¬øRechazar y alertar a Gerencia?")) confirmarDecisionTanqueo('NO'); }
      else { new bootstrap.Modal(document.getElementById('modalDecisionTanqueo')).show(); }
    }

    function confirmarDecisionTanqueo(decision) {
      if (!idTanqueoSeleccionado) return;
      const card = document.getElementById(`card-t-${idTanqueoSeleccionado}`);
      if (card) card.style.opacity = '0.5';

      // Cerrar modal si est√° abierto
      const modalEl = document.getElementById('modalDecisionTanqueo');
      const modal = bootstrap.Modal.getInstance(modalEl);
      if (modal) modal.hide();

      fetch('/procesar_validacion_tanqueo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: idTanqueoSeleccionado, decision: decision })
      })
        .then(r => r.json())
        .then(resp => {
          if (resp.success) {
            if (card) card.remove();
            if (document.getElementById('gridTanqueos').children.length === 0) document.getElementById('emptyTanqueos').style.display = 'block';
            alert(decision === 'SI' ? "‚úÖ Validado" : "üì© Rechazado");
          } else { if (card) card.style.opacity = '1'; alert(resp.message); }
        })
        .catch(() => { if (card) card.style.opacity = '1'; alert("Error conexi√≥n"); });
    }

    // 5. UTILIDADES FORMULARIOS
    document.addEventListener('DOMContentLoaded', function () {
      window.mostrarFormulario = function (id) {
        document.querySelectorAll('.form-section').forEach(div => div.style.display = 'none');
        const t = document.getElementById(id); if (t) t.style.display = 'block';
      }
    });

    let formularioActivo = null;
    function confirmarEnvioGenerico(formId) {
      const form = document.getElementById(formId); if (!form) return;
      formularioActivo = form;
      document.getElementById('modalMensajeGlobal').textContent = form.dataset.confirmar || "¬øContinuar?";
      new bootstrap.Modal(document.getElementById('modalConfirmacionGlobal')).show();
    }
    document.getElementById('btnConfirmarGlobal').addEventListener('click', () => {
      if (!formularioActivo) return;
      const url = formularioActivo.dataset.url;
      const data = new FormData(formularioActivo);
      fetch(url, { method: 'POST', body: data }).then(res => res.json()).then(result => {
        alert(result.message);
        if (result.success) { formularioActivo.reset(); document.querySelectorAll('.form-section').forEach(e => e.style.display = 'none'); }
      });
      bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionGlobal')).hide();
    });

    // 6. INFORMES Y GRAFICOS
    const operaciones = {
      "890707006": ["Gestion Electricidad", "Gestion Gas Avicola", "Gestion Carb√≥n", "Gestion Flota Cautiva", "Gestion Transporte Especial", "Gestion Mantenimiento", "Gestion Procesos Industriales", "Gestion EDS"],
      "900977113": ["Gestion Electricidad", "Gestion Gas Avicola", "Gestion Carb√≥n"],
      "901370428": ["Gestion Electricidad", "Gestion Gas Avicola"]
    };
    let chartInstancia = null, datosGlobales = null;

    function cerrarInforme() { document.getElementById('seccionInforme').style.display = 'none'; }

    function activarL√≥gicaInteractividadInformes(cid) {
      let opts = [
        { value: "granja", text: "Por Granja" },
        { value: "zona", text: "Por Zona" },
        { value: "general", text: "General" }
      ];

      // Opciones exclusivas para Pollos Gar (cid: 890707006)
      if (cid === '890707006') {
        opts.push({ value: "validacion", text: "üßê Validaci√≥n Tanqueos" });
        opts.push({ value: "aprobacion_glp", text: "‚úÖ Aprobaci√≥n Solicitudes" });
        opts.push({ value: "pendientes_tanqueo", text: "‚è≥ Pendientes de Tanqueo" });

        // --- AQU√ç AGREGAMOS LA OPCI√ìN AL MEN√ö ---
        opts.push({ value: "saldos", text: "üí∞ Informe de Saldos (Cierre)" });
      }

      mostrarPregunta("Tipo de informe", opts, (t) => {

        // --- CORRECCI√ìN: INTERCEPTAR "SALDOS" AQU√ç ---
        if (t === "saldos") {
          generarInformeSaldos(cid);
          return; // <--- EL RETURN ES CLAVE PARA QUE NO SIGA EJECUTANDO
        }
        // ---------------------------------------------

        // --- 1. APROBACI√ìN ---
        if (t === "aprobacion_glp") {
          mostrarSeccionAprobacionesGLP();
          return;
        }

        // --- 2. PENDIENTES DE TANQUEO ---
        if (t === "pendientes_tanqueo") {
          abrirModalPendientesTanqueo(cid);
          return;
        }

        // --- 3. VALIDACI√ìN ---
        if (t === "validacion") {
          cargarValidacionesTanqueos(cid);
          return;
        }

        // --- 4. GENERAL ---
        if (t === "general") {
          pregPeriodo(cid, t, null);
          return; // Agrega return por seguridad
        }

        // --- 5. POR GRANJA O ZONA (Cualquier otra cosa cae aqu√≠) ---
        // Al haber puesto los 'return' arriba, solo entrar√°n aqu√≠ 'granja' y 'zona'
        fetch('/obtener_ubicaciones', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tipo: t, empresa_id: cid })
        })
          .then(r => r.json()).then(d => {
            if (d.success) {
              mostrarPregunta(`Seleccione ${t}`, d.ubicaciones.map(u => ({ value: u, text: u })), (u) => pregPeriodo(cid, t, u));
            }
          });
      });
    }

    function pregPeriodo(cid, t, u) {
      mostrarPregunta("Periodo", [{ value: "Actual", text: "Actual" }, { value: "Personalizado", text: "Hist√≥rico" }], (p) => {
        if (p === "Personalizado") mostrarSelectorFechas((ini, fin) => generarInformeFinal(cid, t, u, p, ini, fin));
        else generarInformeFinal(cid, t, u, p, null, null);
      });
    }

    function mostrarPregunta(txt, opts, cb) {
      const ov = document.createElement("div"); ov.className = "pregunta-overlay";
      const card = document.createElement("div"); card.className = "pregunta-card";
      card.innerHTML = `<h5 class="text-center mb-3 text-primary">${txt}</h5>`;
      const sel = document.createElement("select"); sel.className = "form-select mb-3";
      sel.innerHTML = '<option value="">Seleccione...</option>';
      opts.forEach(o => sel.innerHTML += `<option value="${o.value}">${o.text}</option>`);
      card.appendChild(sel);
      const row = document.createElement("div"); row.className = "d-flex gap-2";
      row.innerHTML = `<button class="btn btn-secondary flex-fill" onclick="this.closest('.pregunta-overlay').remove()">Cancelar</button>`;
      const b2 = document.createElement("button"); b2.className = "btn btn-custom flex-fill"; b2.innerText = "Continuar";
      b2.onclick = () => { if (sel.value) { ov.remove(); cb(sel.value); } };
      row.appendChild(b2); card.appendChild(row); ov.appendChild(card); document.body.appendChild(ov);
    }

    function mostrarSelectorFechas(cb) {
      const ov = document.createElement("div"); ov.className = "pregunta-overlay";
      ov.innerHTML = `
           <div class="pregunta-card">
             <h5 class="text-center mb-3 text-primary">Seleccione Rango</h5>
             <label class="small fw-bold">Inicio</label><input type="date" id="tIni" class="form-control mb-2">
             <label class="small fw-bold">Fin</label><input type="date" id="tFin" class="form-control mb-4">
             <div class="d-flex gap-2">
               <button class="btn btn-secondary flex-fill" onclick="this.closest('.pregunta-overlay').remove()">Cancelar</button>
               <button class="btn btn-custom flex-fill" id="btnOkF">Generar</button>
             </div>
           </div>`;
      document.body.appendChild(ov);
      document.getElementById('btnOkF').onclick = () => {
        const i = document.getElementById('tIni').value, f = document.getElementById('tFin').value;
        if (i && f) { ov.remove(); cb(i, f); } else alert("Fechas incompletas");
      };
    }

    function generarInformeFinal(eid, t, u, p, ini, fin) {
      // 1. ACTUALIZAR UI (T√çTULOS Y FECHAS)
      let tituloTexto = "Informe General GLP";
      if (t === 'granja') tituloTexto = `Informe Granja: ${u}`;
      else if (t === 'zona') tituloTexto = `Informe Zona: ${u}`;

      document.getElementById('tituloInforme').textContent = tituloTexto;

      let periodoTexto = `Periodo: ${p}`;
      if (p === 'Personalizado' && ini && fin) {
        periodoTexto += ` (${ini} al ${fin})`;
      }
      document.getElementById('subtituloPeriodo').textContent = periodoTexto;

      // 2. PETICI√ìN AL SERVIDOR
      fetch('/generar_informe', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tipo_informe: t, periodo: p, fecha_inicio: ini, fecha_fin: fin, ubicacion: u, empresa_id: eid })
      }).then(r => r.json()).then(resp => {
        if (resp.success) {
          datosGlobales = resp.data;
          renderizarInforme(resp.data);
        } else {
          alert(resp.message);
        }
      });
    }

    function renderizarInforme(data) {
      // 1. Asegurar que la secci√≥n es visible
      document.getElementById('seccionInforme').style.display = 'block';

      // ============================================================
      // BLOQUE DE RESTAURACI√ìN DE VISTA (Crucial para corregir UI)
      // ============================================================
      // Si ven√≠amos del 'Informe de Saldos' (que oculta cosas), aqu√≠ las volvemos a mostrar.
      document.getElementById('kpiContainer').style.display = 'flex'; // Restaurar los KPIs

      // Restaurar el contenedor del Gr√°fico (buscando por la clase card que lo contiene)
      // Nota: querySelector busca la tarjeta que contiene el canvas
      const cardGrafico = document.getElementById('graficoConsumo').closest('.card');
      if (cardGrafico) {
        cardGrafico.style.display = 'block';
      }

      // Restaurar el encabezado original de la tabla (Granja, Consumo, etc.)
      const thead = document.getElementById('tablaConsumo').querySelector('thead tr');
      thead.innerHTML = '<th>Granja</th><th>Consumo (kg)</th><th>Poblaci√≥n</th><th>Eficiencia</th>';
      // ============================================================

      const k = data.kpis;

      // 2. ACTUALIZAR ETIQUETAS DE LOS KPIs
      document.getElementById('kpi1Label').textContent = k.card1_label;
      document.getElementById('kpi2Label').textContent = k.card2_label;
      document.getElementById('kpi3Label').textContent = k.card3_label;
      document.getElementById('kpi4Label').textContent = k.card4_label;
      document.getElementById('kpi5Label').textContent = k.card5_label;
      document.getElementById('kpi6Label').textContent = k.card6_label;

      // 3. ACTUALIZAR VALORES DE LOS KPIs
      document.getElementById('kpi1Value').textContent = Number(k.card1_value).toLocaleString();
      document.getElementById('kpi2Value').textContent = Number(k.card2_value).toLocaleString();
      document.getElementById('kpi3Value').textContent = Number(k.card3_value).toLocaleString();

      // La eficiencia suele requerir m√°s decimales (4)
      document.getElementById('kpi4Value').textContent = Number(k.card4_value).toFixed(4);

      document.getElementById('kpi5Value').textContent = Number(k.card5_value).toLocaleString();

      // Formato moneda para la inversi√≥n
      document.getElementById('kpi6Value').textContent = "$ " + Number(k.card6_value).toLocaleString();

      // 4. LLENAR LA TABLA DE RESUMEN
      const tb = document.getElementById('tablaConsumo').querySelector('tbody');
      tb.innerHTML = ''; // Limpiar datos anteriores

      data.tabla_resumen.forEach(r => {
        tb.innerHTML += `
          <tr>
            <td class="text-start fw-bold">${r.granja}</td>
            <td>${Number(r.total_kg).toLocaleString()}</td>
            <td>${Number(r.pollitos).toLocaleString()}</td>
            <td>${Number(r.kg_pollito).toFixed(4)}</td>
          </tr>
        `;
      });

      // 5. ACTUALIZAR EL GR√ÅFICO
      // Llamamos a la funci√≥n auxiliar que destruye y recrea el Chart.js
      cambiarVistaGrafico('rendimiento');
    }

    function cambiarVistaGrafico(vista) {
      if (!datosGlobales) return;
      const ctx = document.getElementById('graficoConsumo').getContext('2d');
      if (chartInstancia) chartInstancia.destroy();
      const s = datosGlobales.series;
      let d = [];
      if (vista === 'rendimiento') d = [{ label: 'Rendimiento', data: s.kg_pollito, borderColor: '#6366f1', fill: true, backgroundColor: 'rgba(99,102,241,0.1)', tension: 0.3 }];
      else d = [{ label: 'Saldos', data: s.saldo_inicial, borderColor: '#3b82f6' }];
      chartInstancia = new Chart(ctx, { type: 'line', data: { labels: s.fechas, datasets: d }, options: { responsive: true, maintainAspectRatio: false } });
    }

    // PDF
    function descargarPDF() {
      const btn = document.getElementById('btnDescargarPdf');
      const originalText = btn.textContent;
      btn.textContent = "Generando PDF...";
      btn.disabled = true;

      // 1. DATOS DE ENCABEZADO COMUNES (Cliente, Fecha, Responsable)
      const selCliente = document.getElementById("clienteSelect");
      document.getElementById("repCliente").textContent = selCliente.options[selCliente.selectedIndex].text;
      document.getElementById("repFecha").textContent = new Date().toLocaleString();

      // Mostrar el contenedor fantasma oculto para poder editarlo antes de la foto
      const phantom = document.getElementById('reporteImpresion');
      phantom.style.display = 'block';

      // =========================================================
      // L√ìGICA CONDICIONAL: ¬øES SALDOS O GENERAL?
      // =========================================================

      if (datosGlobales && datosGlobales.tipo === 'saldos') {
        // --- MODO SALDOS ---

        // A. Ocultar secciones que NO van en saldos
        document.getElementById('repSectionKPIs').style.display = 'none';  // Ocultar KPIs
        document.getElementById('repSectionGraph').style.display = 'none'; // Ocultar Gr√°fico

        // B. Configurar Textos Espec√≠ficos
        document.getElementById('repTituloPrincipal').textContent = "INFORME DE SALDOS AL CIERRE";
        document.getElementById('repSubtituloPrincipal').textContent = "Inventario de Gas en √öltimo Lote Inactivo";
        document.getElementById('repUbicacion').textContent = "Todas las Granjas (Detallado)";
        document.getElementById('repPeriodo').textContent = "√öltimo Cierre Registrado";

        // C. Construir la Tabla Espec√≠fica para PDF (Formato Limpio)
        const tabla = document.getElementById('repTablaMain');

        // Encabezado Tabla PDF
        tabla.querySelector('thead').innerHTML = `
              <tr style="background-color: #015249; color: white;">
                  <th style="padding:8px; border:1px solid #000;">Ubicaci√≥n / Lote</th>
                  <th style="padding:8px; border:1px solid #000;">Fecha Cierre</th>
                  <th style="padding:8px; border:1px solid #000;">Tanque</th>
                  <th style="padding:8px; border:1px solid #000;">Capacidad</th>
                  <th style="padding:8px; border:1px solid #000;">Nivel Final</th>
                  <th style="padding:8px; border:1px solid #000;">Saldo (kg)</th>
              </tr>
          `;

        // Cuerpo Tabla PDF (Iteraci√≥n Jer√°rquica)
        let htmlBody = '';
        if (datosGlobales.data && datosGlobales.data.length > 0) {
          datosGlobales.data.forEach(g => {
            // 1. Fila Granja (Fondo Gris Claro)
            htmlBody += `
                      <tr style="background-color: #f0f0f0;">
                          <td colspan="6" style="text-align: left; padding: 10px; font-weight: bold; border: 1px solid #000; color: #000;">
                              üè† ${g.ubicacion} <span style="font-weight:normal; font-size: 0.9em; margin-left:10px;">(Lote: ${g.lote_cerrado})</span>
                          </td>
                      </tr>
                  `;

            // 2. Filas Tanques
            g.tanques.forEach(tk => {
              htmlBody += `
                          <tr>
                              <td style="border: 1px solid #000;"></td> <td style="border: 1px solid #000; padding:5px;">${g.fecha_cierre}</td>
                              <td style="border: 1px solid #000; padding:5px;">${tk.tanque}</td>
                              <td style="border: 1px solid #000; padding:5px;">${tk.capacidad_gl} gl</td>
                              <td style="border: 1px solid #000; padding:5px;">${tk.nivel.toFixed(1)}%</td>
                              <td style="border: 1px solid #000; padding:5px; font-weight:bold;">${tk.saldo_kg.toFixed(2)}</td>
                          </tr>
                      `;
            });

            // 3. Fila Total Granja
            htmlBody += `
                      <tr>
                          <td colspan="5" style="text-align: right; padding: 6px; font-weight: bold; border: 1px solid #000;">TOTAL REMANENTE GRANJA:</td>
                          <td style="background-color: #e8f5e9; font-weight: bold; padding: 6px; border: 1px solid #000;">${g.total_kg_granja.toFixed(2)}</td>
                      </tr>
                  `;
          });
        } else {
          htmlBody = '<tr><td colspan="6" style="padding:20px; text-align:center;">No hay datos para mostrar.</td></tr>';
        }
        tabla.querySelector('tbody').innerHTML = htmlBody;

      } else {
        // --- MODO GENERAL (EST√ÅNDAR) ---

        // A. Mostrar secciones est√°ndar
        document.getElementById('repSectionKPIs').style.display = 'grid';
        document.getElementById('repSectionGraph').style.display = 'block';

        // B. Restaurar Textos
        document.getElementById('repTituloPrincipal').textContent = "INFORME DE GESTI√ìN GLP";
        document.getElementById('repSubtituloPrincipal').textContent = "An√°lisis de Consumo y Eficiencia";

        // Datos de UI
        const tituloUI = document.getElementById("tituloInforme").textContent;
        document.getElementById("repUbicacion").textContent = tituloUI.replace('Informe ', '').replace('Granja: ', '').replace('Zona: ', '');
        document.getElementById("repPeriodo").textContent = document.getElementById("subtituloPeriodo").textContent;

        // C. Copiar KPIs desde la pantalla
        for (let i = 1; i <= 6; i++) {
          document.getElementById(`lblKpi${i}`).textContent = document.getElementById(`kpi${i}Label`).textContent;
          document.getElementById(`valKpi${i}`).textContent = document.getElementById(`kpi${i}Value`).textContent;
        }

        // D. Copiar Gr√°fica
        const canvas = document.getElementById('graficoConsumo');
        if (canvas) {
          document.getElementById("repGraficoImg").src = canvas.toDataURL("image/jpeg", 1.0);
        }

        // E. Copiar Tabla General (Clonamos la de la pantalla)
        const tabla = document.getElementById('repTablaMain');
        tabla.querySelector('thead').innerHTML = `
              <tr style="background-color: #eee;">
                  <th style="border:1px solid #000; padding:5px;">Granja</th>
                  <th style="border:1px solid #000; padding:5px;">Consumo (kg)</th>
                  <th style="border:1px solid #000; padding:5px;">Poblaci√≥n</th>
                  <th style="border:1px solid #000; padding:5px;">Eficiencia</th>
              </tr>
          `;

        // Limpiamos estilos de la tabla web para el PDF (bordes negros simples)
        const tbodyWeb = document.getElementById('tablaConsumo').querySelector('tbody').innerHTML;
        // Reemplazar clases de bootstrap con estilos inline b√°sicos para PDF si es necesario, 
        // pero html2pdf suele renderizar bien. Aseguramos bordes.
        tabla.querySelector('tbody').innerHTML = tbodyWeb;

        // Forzar bordes en las celdas copiadas
        const celdas = tabla.querySelectorAll('td');
        celdas.forEach(td => td.style.border = "1px solid #000");
      }

      // =========================================================
      // GENERAR ARCHIVO
      // =========================================================
      const nombreArchivo = `Informe_${datosGlobales && datosGlobales.tipo === 'saldos' ? 'Saldos' : 'Gestion'}_GLP.pdf`;

      html2pdf().set({
        margin: 0.5, // M√°rgenes en pulgadas
        filename: nombreArchivo,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, logging: false },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      })
        .from(phantom).save()
        .then(() => {
          phantom.style.display = 'none'; // Volver a ocultar el fantasma
          btn.textContent = originalText;
          btn.disabled = false;
        })
        .catch(err => {
          console.error("Error PDF:", err);
          alert("Error generando el PDF.");
          phantom.style.display = 'none';
          btn.textContent = originalText;
          btn.disabled = false;
        });
    }

    function actualizarEmpresaUsuario() {
      const s = document.getElementById('empresa_select_usuario');
      document.getElementById('empresa_id').value = s.options[s.selectedIndex].getAttribute('data-id') || '';
      actualizarPerfilesPorEmpresaYOperacion();
    }
    function actualizarPerfilesPorEmpresaYOperacion() {
      const eid = document.getElementById('empresa_id').value;
      const op = document.getElementById('operacion_usuario').value;
      if (!eid || !op) return;
      fetch(`/obtener_perfiles?empresa_id=${eid}&operacion=${op}`).then(r => r.json()).then(d => {
        const s = document.getElementById('perfil_usuario'); s.innerHTML = '';
        d.perfiles.forEach(p => { const o = document.createElement('option'); o.value = p; o.textContent = p; s.appendChild(o); });
      });
    }
    function actualizarNit() {
      const s = document.querySelector('[name="empresa_select"]');
      const nit = s.options[s.selectedIndex].getAttribute('data-nit');
      document.getElementById('nit').value = nit || '';
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Llamada silenciosa al backend para limpiar fotos viejas
      fetch('/ejecutar_limpieza_automatica')
        .then(response => response.json())
        .then(data => {
          // CONDICI√ìN: Si fue exitoso Y el mensaje NO dice "limpio" (es decir, s√≠ borr√≥ algo)
          if (data.success && !data.message.includes('limpio')) {
            // Muestra la alerta visual que pediste
            alert("üßπ MANTENIMIENTO: " + data.message);
          } else {
            // Si no borr√≥ nada, solo lo registra en consola (F12) para no molestar
            console.log("Sistema limpio o sin cambios: ", data.message);
          }
        })
        .catch(err => console.log("Error en limpieza autom√°tica:", err));
    });
    function mostrarSeccionAprobacionesGLP() {
      // Ocultar otras secciones y mostrar esta
      document.querySelectorAll('.form-section').forEach(el => el.style.display = 'none');
      document.getElementById('seccionAprobacionesGLP').style.display = 'block';

      cargarAprobacionesGLP();
    }

    function cargarAprobacionesGLP() {
      const tbody = document.getElementById('tablaAprobacionesGLP');
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">Cargando...</td></tr>';

      fetch('/glp/admin/obtener_solicitudes_pendientes')
        .then(r => r.json())
        .then(data => {
          tbody.innerHTML = '';

          // Validaci√≥n de datos vac√≠os
          if (!data.success || data.items.length === 0) {
            document.getElementById('msgSinAprobaciones').style.display = 'block';
            return;
          }
          document.getElementById('msgSinAprobaciones').style.display = 'none';

          data.items.forEach(item => {
            // 1. Renderizar la columna de Tanques (con fotos y alertas de nivel)
            let htmlTanques = '<div class="d-flex gap-2">';
            item.tanques.forEach(t => {
              let fotoHtml = t.foto ?
                `<br><a href="${t.foto}" target="_blank" style="font-size:0.7rem;">Ver Foto</a>` : '';

              // Alerta visual en rojo si el nivel es cr√≠tico (<= 25%)
              let color = t.nivel <= 25 ? 'text-danger fw-bold' : '';

              htmlTanques += `
                        <div class="border p-1 rounded text-center" style="min-width:60px;">
                            <div class="small fw-bold">${t.numero}</div>
                            <div class="${color}">${t.nivel}%</div>
                            ${fotoHtml}
                        </div>
                    `;
            });
            htmlTanques += '</div>';

            // 2. Construir la fila completa
            const tr = document.createElement('tr');
            tr.innerHTML = `
                    <td>${item.fecha.substring(0, 16)}</td>
                    <td>
                        <div class="fw-bold">${item.cliente}</div>
                        <div class="small text-muted">${item.ubicacion}</div>
                    </td>
                    <td>
                        <div>${item.lote}</div>
                        <div class="badge bg-info text-dark">D√≠a ${item.dias_operacion}</div>
                    </td>
                    <td>${htmlTanques}</td>
                    <td class="text-center">
                        <div class="fs-5 fw-bold text-success">${item.nivel_solicitado}%</div>
                        <div class="small text-muted">Llenar hasta</div>
                    </td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-2">
                            <button class="btn btn-success btn-sm" onclick="aprobarSolicitudGLP(${item.id}, this)">
                                üëç
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="abrirSimuladorProyeccion(${item.id})">
                                üìà Analizar
                            </button>
                        </div>
                    </td>
                `;
            tbody.appendChild(tr);
          });
        })
        .catch(error => {
          console.error('Error cargando aprobaciones:', error);
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error al cargar datos.</td></tr>';
        });
    }



    function aprobarSolicitudGLP(id, btn) {
      if (!confirm("¬øAprobar esta solicitud para que el cliente pueda enviarla?")) return;

      btn.disabled = true;
      btn.textContent = "Procesando...";

      fetch('/glp/admin/aprobar_solicitud', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }, // <--- CORRECCI√ìN CR√çTICA (Error 415)
        body: JSON.stringify({ id: id })
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            alert("Aprobada correctamente.");
            cargarAprobacionesGLP(); // Recargar tabla
          } else {
            alert("Error: " + data.message);
            btn.disabled = false;
            btn.textContent = "üëç"; // Restaurar icono si fall√≥
          }
        })
        .catch(error => {
          console.error("Error de red:", error);
          alert("Error de conexi√≥n al aprobar.");
          btn.disabled = false;
          btn.textContent = "üëç";
        });
    }

    function abrirModalPendientesTanqueo(empresaId) {
      const modal = new bootstrap.Modal(document.getElementById('modalPendientesTanqueo'));
      const tbody = document.getElementById('tablaPendientesTanqueoBody');
      const msg = document.getElementById('msgSinPendientesTanqueo');

      tbody.innerHTML = '<tr><td colspan="5">Cargando datos...</td></tr>';
      msg.style.display = 'none';
      modal.show();

      fetch('/obtener_pendientes_tanqueo_reporte', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ empresa_id: empresaId })
      })
        .then(r => r.json())
        .then(data => {
          tbody.innerHTML = '';

          if (!data.success || data.items.length === 0) {
            msg.style.display = 'block';
            return;
          }

          data.items.forEach(item => {
            // L√≥gica de Sem√°foro
            let badgeColor = 'bg-success';
            let badgeText = 'Normal';

            if (item.dias >= 1 && item.dias <= 2) {
              badgeColor = 'bg-warning text-dark';
              badgeText = 'Alerta Leve';
            } else if (item.dias >= 3) {
              badgeColor = 'bg-danger';
              badgeText = 'Cr√≠tico';
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>
                <div>${item.fecha}</div>
                <small class="text-muted text-uppercase" style="font-size:0.7em">${item.codigo}</small>
            </td>
            <td class="fw-bold text-primary">${item.ubicacion}</td>
            <td>${item.proveedor || 'N/D'}</td>
            <td>
                <span class="fw-bold">${item.solicitado}%</span>
                <span class="text-muted small">aprox</span>
            </td>
            <td>
                <div class="badge ${badgeColor}" style="font-size:0.9em;">
                    ${item.dias} D√≠as
                </div>
            </td>
          `;
            tbody.appendChild(tr);
          });
        })
        .catch(err => {
          console.error(err);
          tbody.innerHTML = '<tr><td colspan="5" class="text-danger">Error cargando datos</td></tr>';
        });
    }

    let chartSimulador = null;
    let datosSimulacion = null;
    let idPedidoEnAnalisis = null;

    function abrirSimuladorProyeccion(idPedido) {
      idPedidoEnAnalisis = idPedido;
      const modal = new bootstrap.Modal(document.getElementById('modalProyeccion'));
      modal.show();

      // Feedback visual inicial
      document.getElementById('sim_nivel_actual').innerText = "...";
      document.getElementById('sim_tasa').innerText = "...";
      document.getElementById('sim_detalle_kg').innerText = "";
      document.getElementById('sim_input_solicita').value = "";

      fetch('/glp/admin/analizar_proyeccion', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }, // <--- CORRECCI√ìN CR√çTICA (Error 415)
        body: JSON.stringify({ id: idPedido })
      })
        .then(r => r.json())
        .then(data => {
          if (!data.success) {
            alert(data.message);
            modal.hide();
            return;
          }

          datosSimulacion = data;

          document.getElementById('sim_nivel_actual').innerText = data.nivel_actual + "%";
          document.getElementById('sim_tasa').innerText = "-" + data.tasa_descenso_diaria + "%";
          document.getElementById('sim_detalle_kg').innerText = "(" + data.kg_ave_calculado + " kg/ave)";
          document.getElementById('sim_input_solicita').value = data.solicitado_original;

          renderizarGraficaProyeccion();
        })
        .catch(error => {
          console.error("Error analizando:", error);
          alert("Error al cargar la proyecci√≥n.");
          modal.hide();
        });
    }

    function actualizarGraficaSimulacion() {
      if (chartSimulador) renderizarGraficaProyeccion();
    }

    function renderizarGraficaProyeccion() {
      const ctx = document.getElementById('chartProyeccion').getContext('2d');
      let solicita = parseFloat(document.getElementById('sim_input_solicita').value) || 0;

      const labels = [];
      const dataProyeccion = [];
      const dataSeguridad = [];

      let nivelSimulado = datosSimulacion.nivel_actual + solicita;
      if (nivelSimulado > 100) nivelSimulado = 100;

      let diaInicio = datosSimulacion.dia_actual;
      // Proyectamos hasta el d√≠a 16 para ver c√≥mo amanece despu√©s del cierre
      let diaFin = 16;
      if (diaInicio >= 15) diaFin = diaInicio + 3; // Si ya pas√≥, mostramos 3 d√≠as m√°s

      for (let d = diaInicio; d <= diaFin; d++) {
        labels.push("D√≠a " + d);
        dataProyeccion.push(nivelSimulado.toFixed(1));
        dataSeguridad.push(20); // L√≠nea roja fija

        nivelSimulado -= datosSimulacion.tasa_descenso_diaria;
        if (nivelSimulado < 0) nivelSimulado = 0;
      }

      if (chartSimulador) chartSimulador.destroy();

      chartSimulador = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Proyecci√≥n Nivel (%)',
              data: dataProyeccion,
              borderColor: '#015249',
              backgroundColor: 'rgba(1, 82, 73, 0.1)',
              borderDash: [5, 5],
              pointRadius: 4,
              fill: true,
              tension: 0.1
            },
            {
              label: 'M√≠nimo Seguro (20%)',
              data: dataSeguridad,
              borderColor: '#dc3545',
              borderWidth: 2,
              pointRadius: 0,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Nivel %' } }
          }
        }
      });
    }

    function confirmarAprobacionSimulada() {
      const valorFinal = document.getElementById('sim_input_solicita').value;
      if (!confirm(`¬øAprobar solicitud con ${valorFinal}%?`)) return;

      fetch('/glp/admin/aprobar_solicitud', {
        method: 'POST',
        body: JSON.stringify({
          id: idPedidoEnAnalisis,
          nivel_aprobado: valorFinal
        })
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            alert("‚úÖ Aprobado y ajustado.");
            bootstrap.Modal.getInstance(document.getElementById('modalProyeccion')).hide();
            cargarAprobacionesGLP();
          } else {
            alert("Error: " + data.message);
          }
        });
    }

    function generarInformeSaldos(empresaId) {
      // 1. Preparar la vista (Ocultar gr√°ficos y KPIs que no aplican a saldos)
      document.getElementById('seccionInforme').style.display = 'block';
      document.getElementById('kpiContainer').style.display = 'none';

      // Ocultar el contenedor de la tarjeta del gr√°fico
      const cardGrafico = document.getElementById('graficoConsumo').closest('.card');
      if (cardGrafico) {
        cardGrafico.style.display = 'none';
      }

      // 2. Configurar T√≠tulos
      document.getElementById('tituloInforme').textContent = "Informe de Saldos al Cierre";
      document.getElementById('subtituloPeriodo').textContent = "Remanente en √∫ltimo lote inactivo";

      // 3. Limpiar tabla y mostrar spinner
      const tbody = document.getElementById('tablaConsumo').querySelector('tbody');
      const thead = document.getElementById('tablaConsumo').querySelector('thead tr');

      tbody.innerHTML = '<tr><td colspan="5" class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2">Consultando cierres...</p></td></tr>';

      // 4. Fetch al Backend
      fetch('/generar_informe_saldos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ empresa_id: empresaId })
      })
        .then(r => r.json())
        .then(resp => {
          if (!resp.success) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-danger text-center p-3">${resp.error || 'Error desconocido del servidor'}</td></tr>`;
            return;
          }

          // === CORRECCI√ìN CLAVE: GUARDAR MODO INMEDIATAMENTE ===
          // Esto asegura que el PDF sepa que es "saldos" aunque la lista est√© vac√≠a.
          datosGlobales = {
            tipo: 'saldos',
            data: resp.data || [],
            fecha_gen: resp.fecha_generacion
          };

          const data = resp.data;

          // 5. Reconstruir Encabezado de Tabla (Pantalla)
          thead.innerHTML = `
              <th class="bg-dark text-white">Ubicaci√≥n / Lote</th>
              <th class="bg-dark text-white">Fecha Cierre</th>
              <th class="bg-dark text-white">Tanque</th>
              <th class="bg-dark text-white">Nivel Final</th>
              <th class="bg-dark text-white">Saldo (kg)</th>
          `;

          if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted p-5">No se encontraron lotes inactivos recientes con saldos registrados.</td></tr>';
            return;
          }

          // 6. Renderizar Filas (Estructura Jer√°rquica)
          let html = '';

          data.forEach(granja => {
            // A. Encabezado de Grupo (Granja)
            html += `
                  <tr class="table-primary">
                      <td colspan="5" class="fw-bold text-dark text-start ps-3 align-middle">
                          üè† ${granja.ubicacion} 
                          <span class="badge bg-secondary ms-2" style="font-weight:normal">Lote: ${granja.lote_cerrado}</span>
                      </td>
                  </tr>
              `;

            // B. Filas de Detalle (Tanques)
            granja.tanques.forEach(tk => {
              let estiloNivel = tk.nivel < 10 ? 'text-danger fw-bold' : '';
              html += `
                      <tr>
                          <td></td> 
                          <td class="small text-muted align-middle">${granja.fecha_cierre}</td>
                          <td class="align-middle">${tk.tanque} <span class="text-muted small">(${tk.capacidad_gl} gl)</span></td>
                          <td class="${estiloNivel} align-middle">${tk.nivel.toFixed(1)}%</td>
                          <td class="fw-bold text-success align-middle">${tk.saldo_kg.toFixed(2)}</td>
                      </tr>
                  `;
            });

            // C. Pie de Grupo (Total Granja)
            html += `
                  <tr style="border-top: 2px solid #dee2e6;">
                      <td colspan="4" class="text-end small text-uppercase fw-bold align-middle">Total Remanente Granja:</td>
                      <td class="fw-bold bg-light fs-6 align-middle">${granja.total_kg_granja.toFixed(2)}</td>
                  </tr>
              `;
          });

          tbody.innerHTML = html;
        })
        .catch(err => {
          console.error(err);
          tbody.innerHTML = '<tr><td colspan="5" class="text-danger text-center p-3">Error de conexi√≥n al cargar el informe.</td></tr>';
        });
    }

  </script>
  <div class="modal fade" id="modalProyeccion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title">üîÆ Proyecci√≥n de Cierre de Lote</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <div class="row mb-3 align-items-center">
            <div class="col-md-4 text-center">
              <label class="small fw-bold text-muted">Nivel Actual</label>
              <h3 class="text-secondary" id="sim_nivel_actual">0%</h3>
            </div>
            <div class="col-md-4 text-center">
              <label class="small fw-bold text-muted">Consumo Diario</label>
              <h3 class="text-danger" id="sim_tasa">0% / d√≠a</h3>
              <small class="text-muted" id="sim_detalle_kg">Calc. basado en historia</small>
            </div>
            <div class="col-md-4">
              <label class="small fw-bold text-primary">A SOLICITAR (Editable)</label>
              <div class="input-group">
                <input type="number" id="sim_input_solicita" class="form-control fw-bold text-primary fs-4"
                  onchange="actualizarGraficaSimulacion()" onkeyup="actualizarGraficaSimulacion()">
                <span class="input-group-text">%</span>
              </div>
            </div>
          </div>

          <div style="height: 300px; width: 100%;">
            <canvas id="chartProyeccion"></canvas>
          </div>

          <div class="alert alert-light border mt-3 py-2 small text-center">
            La l√≠nea punteada proyecta el consumo futuro hasta el <b>D√≠a 15</b>.<br>
            Ajusta el valor "A Solicitar" para evitar caer en la zona roja (20%).
          </div>

        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success fw-bold px-4" onclick="confirmarAprobacionSimulada()">
            ‚úÖ Confirmar y Aprobar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalPendientesTanqueo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title fw-bold">‚è≥ Solicitudes sin Tanqueo Registrado</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-hover mb-0 text-center align-middle">
              <thead class="table-light">
                <tr>
                  <th>Fecha Solicitud</th>
                  <th>Sede</th>
                  <th>Proveedor Asignado</th>
                  <th>Cant. Solicitada</th>
                  <th>Tiempo de Espera</th>
                </tr>
              </thead>
              <tbody id="tablaPendientesTanqueoBody">
              </tbody>
            </table>
          </div>
          <div id="msgSinPendientesTanqueo" class="text-center p-4 text-muted" style="display:none;">
            ‚úÖ Todo al d√≠a. No hay solicitudes pendientes de tanqueo.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

</body>

</html>