<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Webmaster - Energix 360</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
    :root {
      --color-primary: #015249;
      --color-primary-dark: #013d36;
      --color-bg: #f6f7f8;
      --color-surface: #ffffff;
      --color-border: #e5e7eb;
      --color-text: #111827;
      --color-muted: #6b7280;
      --color-danger: #b00020;
      --color-danger-dark: #8f0017;
      --shadow-soft: 0 4px 14px rgba(15, 23, 42, 0.08);
      --radius-card: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Verdana, Geneva, Tahoma, sans-serif;
      background: radial-gradient(circle at top, #d7f2ec 0, #f6f7f8 45%, #f6f7f8 100%);
      color: var(--color-text);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      padding: 12px 16px;
      max-width: 1120px;
      margin: 0 auto 6px auto;
    }

    .header .logo {
      max-height: 52px;
      width: auto;
      object-fit: contain;
    }

    .header-title {
      flex: 1 1 200px;
      text-align: center;
    }

    .header-title h1 {
      margin: 0;
      font-size: clamp(1.2rem, 3vw, 1.5rem);
      color: var(--color-primary-dark);
    }

    .header-title p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--color-muted);
    }

    .layout {
      display: flex;
      flex-wrap: wrap;
      max-width: 1120px;
      margin: 0 auto;
      padding: 8px 12px 20px;
      gap: 12px;
    }

    .sidebar-left {
      flex: 0 0 240px;
      max-width: 240px;
      background: var(--color-primary-dark);
      color: #fff;
      border-radius: 16px;
      padding: 14px 12px;
      box-shadow: var(--shadow-soft);
      height: fit-content;
    }

    .sidebar-left h5 {
      font-size: 0.98rem;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .sidebar-left .btn-custom {
      width: 100%;
      margin-bottom: 6px;
    }

    .content {
      flex: 1 1 0;
      min-width: 0;
      background: var(--color-surface);
      border-radius: 16px;
      padding: 16px 14px 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--color-border);
    }

    .content-section {
      margin-bottom: 18px;
    }

    .content-section h4 {
      margin-bottom: 10px;
      color: var(--color-primary-dark);
    }

    .form-section {
      display: none;
      margin-bottom: 20px;
      padding: 14px 12px;
      border-radius: 14px;
      border: 1px solid var(--color-border);
      background: #f9fafb;
    }

    .form-section.active {
      display: block;
    }

    .table-section {
      margin-top: 8px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--color-border);
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.04);
      max-height: 420px;
      overflow: auto;
    }

    table.table {
      font-size: 0.85rem;
    }

    table.table thead th {
      position: sticky;
      top: 0;
      background: #f3f4f6;
      z-index: 1;
    }

    .btn-custom {
      background-color: #01675b;
      border-color: #01675b;
      color: #fff;
      border-radius: 999px;
      font-size: 0.9rem;
      padding: 8px 12px;
    }

    .btn-custom:hover {
      background-color: #013d36;
      border-color: #013d36;
    }

    .btn-secondary {
      border-radius: 999px;
      font-size: 0.88rem;
    }

    .btn-danger {
      background-color: var(--color-danger);
      border-color: var(--color-danger);
      border-radius: 999px;
      font-size: 0.88rem;
    }

    .btn-danger:hover {
      background-color: var(--color-danger-dark);
      border-color: var(--color-danger-dark);
    }

    .form-label {
      font-size: 0.86rem;
      font-weight: 600;
      color: var(--color-text);
    }

    .form-control,
    .form-select {
      border-radius: 10px;
      border-color: var(--color-border);
      font-size: 0.9rem;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(1, 82, 73, 0.18);
    }

    .modal-content {
      border-radius: 16px;
      border-color: var(--color-border);
      box-shadow: var(--shadow-soft);
    }

    .modal-header {
      background: #f9fafb;
      border-bottom-color: var(--color-border);
    }

    .modal-title {
      color: var(--color-primary-dark);
    }

    .modal-footer {
      border-top-color: var(--color-border);
    }

    .alert {
      border-radius: 10px;
      font-size: 0.9rem;
    }

    .table thead {
      background: #f3f4f6;
    }

    .badge-rol {
      display: inline-block;
      padding: 3px 7px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #075985;
      font-size: 0.7rem;
      font-weight: 600;
    }

    @media (max-width: 900px) {
      .layout {
        flex-direction: column;
      }

      .sidebar-left {
        max-width: 100%;
      }
    }

    @media (max-width: 560px) {
      .header {
        flex-direction: column;
        text-align: center;
      }

      .header .logo {
        max-height: 46px;
      }
    }
</style>

</head>

<body>
    <div class="header">
        <div style="flex: 1; text-align: left;">
            <h4 class="m-0">Panel de Control</h4>
        </div>
        <div style="flex: 1; text-align: center;">
            <p class="m-0 fw-bold text-muted">Bienvenido {{ nombre }} | Empresa: {{ empresa }}</p>
        </div>
        <div style="flex: 1; text-align: right;">
            <a href="/logout" class="btn btn-custom">Cerrar sesión</a>
        </div>
    </div>

    <div class="layout">
        <div class="sidebar-left">
            <div class="d-grid gap-2">
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('crearEmpresa')">Crear empresa</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('editarEmpresa')">Editar empresa</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('borrarEmpresa')">Borrar empresa</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('crearPerfil')">Crear perfiles</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('editarPerfil')">Editar perfiles</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('borrarPerfil')">Borrar perfiles</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('crearUsuario')">Crear usuario</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('editarUsuario')">Editar usuario</button>
                <button class="btn btn-custom mb-2" onclick="mostrarFormulario('borrarUsuario')">Borrar usuario</button>
            </div>
        </div>

        <div class="main-content">
            <!-- FORMULARIOS ORIGINALES INSERTADOS AQUÍ -->

            <!-- Crear Empresa -->
            <div id="crearEmpresa" class="form-section">
                <h4>Crear Empresa</h4>
                <form id="formCrearEmpresa" data-url="/registrar_empresa"
                    data-confirmar="¿Desea registrar esta empresa?">
                    <div class="mb-2">
                        <label for="nombre_comercial">Nombre Comercial</label>
                        <input type="text" id="nombre_comercial" name="nombre_comercial" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label for="nit">NIT</label>
                        <input type="text" id="nit" name="nit" class="form-control">
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-custom"
                            onclick="confirmarEnvioGenerico('formCrearEmpresa')">Registrar</button>
                        <button type="button" class="btn btn-secondary"
                            onclick="limpiarFormulario('crearEmpresa')">Limpiar</button>
                        <button type="button" class="btn btn-danger"
                            onclick="ocultarFormulario('crearEmpresa')">Cerrar</button>
                    </div>
                </form>
            </div>

            <!-- Aquí irían los demás formularios: editarEmpresa, borrarEmpresa, crearPerfil, etc. -->
            <!-- Se recomienda que cada <form> tenga data-url y data-confirmar para integrarse con el modal unificado -->


            <div id="crearPerfil" class="form-section">
                <h5>Crear Perfil</h5>
                <form id="form_crearPerfil" data-url="/registrar_perfil" data-confirmar="¿Desea registrar este perfil?">
                    <div class="mb-3">
                        <label for="empresa_select" class="form-label">Empresa</label>
                        <select id="empresa_select" name="empresa_select" class="form-select"
                            onchange="actualizarNit()">
                            <option value="">Seleccione una empresa</option>
                            {% for empresa in empresas %}
                            <option data-nit="{{ empresa.nit }}" value="{{ empresa.nombre_comercial }}">{{
                                empresa.nombre_comercial }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="nit" class="form-label">NIT</label>
                        <input type="text" id="nit" name="nit" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label for="operacion" class="form-label">Operación</label>
                        <select id="operacion" name="operacion" class="form-select">
                            <option value="">Seleccione operación</option>
                            <option value="Electricidad">Electricidad</option>
                            <option value="Gas">Gas</option>
                            <option value="Carbon">Carbón</option>
                            <option value="Flota">Flota</option>
                            <option value="Flota">Control mermas</option>
                            <option value="Mantenimiento">Mantenimiento</option>
                            <option value="Gerencia">Gerencia</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="perfil" class="form-label">Nombre del Perfil</label>
                        <input type="text" id="perfil" name="perfil" class="form-control"
                            placeholder="Ingrese el perfil">
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-custom"
                            onclick="confirmarEnvioGenerico('form_crearPerfil')">Registrar</button>
                        <button type="button" class="btn btn-secondary"
                            onclick="limpiarFormulario('crearPerfil')">Limpiar</button>
                        <button type="button" class="btn btn-danger"
                            onclick="ocultarFormulario('crearPerfil')">Cerrar</button>
                    </div>
                </form>
            </div>
            <!-- Crear Usuario -->
            <!-- Crear Usuario -->
            <div id="crearUsuario" class="form-section">
                <h4>Crear Usuario</h4>
                <form id="form_crearUsuario" data-url="/registrar_usuario"
                    data-confirmar="¿Desea registrar este usuario?">
                    <div class="mb-2">
                        <label for="cedula">Cédula</label>
                        <input type="text" id="cedula" name="cedula" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label for="nombre">Nombre completo</label>
                        <input type="text" id="nombre" name="nombre" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label for="password">Contraseña</label>
                        <input type="password" id="password" name="password" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label for="empresa_select_usuario">Empresa</label>
                        <select id="empresa_select_usuario" name="empresa_select" class="form-select"
                            onchange="actualizarEmpresaUsuario()">
                            <option value="">Seleccione una empresa</option>
                            {% for empresa in empresas %}
                            <option data-id="{{ empresa.nit }}" value="{{ empresa.nombre_comercial }}">{{
                                empresa.nombre_comercial }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="empresa_id">NIT Empresa</label>
                        <input type="text" id="empresa_id" name="empresa_id" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label for="operacion_usuario">Operación</label>
                        <select id="operacion_usuario" name="operacion" class="form-select"
                            onchange="actualizarPerfilesPorEmpresaYOperacion()">
                            <option value="">Seleccione operación</option>
                            <option value="Electricidad">Electricidad</option>
                            <option value="Gas">Gas</option>
                            <option value="Carbon">Carbón</option>
                            <option value="Flota">Flota</option>
                            <option value="Flota">Control mermas</option>
                            <option value="Mantenimiento">Mantenimiento</option>
                            <option value="Gerencia">Gerencia</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="tipo_usuario">Tipo de usuario</label>
                        <select id="tipo_usuario" name="tipo_usuario" class="form-select">
                            <option value="">Seleccione tipo</option>
                            <option value="cliente">Cliente</option>
                            <option value="webmaster">Webmaster</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="clase">Clase</label>
                        <select id="clase" name="clase" class="form-select">
                            <option value="">Seleccione clase</option>
                            <option value="op">Operativo</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="perfil_usuario">Perfil</label>
                        <select id="perfil_usuario" name="perfil" class="form-select">
                            <option value="">Seleccione un perfil disponible</option>
                        </select>
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-custom"
                            onclick="confirmarEnvioGenerico('form_crearUsuario')">Registrar</button>
                        <button type="button" class="btn btn-secondary"
                            onclick="limpiarFormulario('crearUsuario')">Limpiar</button>
                        <button type="button" class="btn btn-danger"
                            onclick="ocultarFormulario('crearUsuario')">Cerrar</button>
                    </div>
                </form>
            </div>

        </div>


        <!-- MODAL DE CONFIRMACION GLOBAL -->
        <div class="modal fade" id="modalConfirmacionGlobal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="modalMensajeGlobal">
                        <!-- mensaje se inserta dinámicamente -->
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                        <button class="btn btn-custom" id="btnConfirmarGlobal">Sí</button>
                    </div>
                </div>
            </div>

            <!--JS-AJAX PARA OCULTAR MOSTRAR LOS MODALES Y LIMPIAR LOS INPUTS PARA LOS FORMULARIOS-->
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    function mostrarFormulario(id) {
                        document.querySelectorAll('.form-section').forEach(div => div.style.display = 'none');
                        const target = document.getElementById(id);
                        if (target) {
                            target.style.display = 'block';
                        }
                    }

                    window.mostrarFormulario = mostrarFormulario;

                    window.ocultarFormulario = function (id) {
                        document.getElementById(id).style.display = 'none';
                        const select = document.getElementById('opcionesEmpresas');
                        if (select) {
                            select.value = "";
                        }
                    }

                    window.limpiarFormulario = function (id) {
                        const form = document.querySelector(`#${id} form`);
                        const inputs = form.querySelectorAll('input');
                        inputs.forEach(input => input.value = '');
                        const selects = form.querySelectorAll('select');
                        selects.forEach(select => select.selectedIndex = 0);
                    }
                });
            </script>
            <!--JS-AJAX PARA OCULTAR MOSTRAR LOS MODALES Y LIMPIAR LOS INPUTS PARA LOS FORMULARIOS-->

            <!--JS-AJAX PARA EL MODAL DE CONFIRMACIÓN-->

            <script>
                let formularioActivo = null;

                function confirmarEnvioGenerico(formId) {
                    const form = document.getElementById(formId);
                    if (!form) return;

                    formularioActivo = form;
                    const mensaje = form.dataset.confirmar || "¿Desea continuar?";
                    document.getElementById('modalMensajeGlobal').textContent = mensaje;

                    const modal = new bootstrap.Modal(document.getElementById('modalConfirmacionGlobal'));
                    modal.show();
                }

                document.getElementById('btnConfirmarGlobal').addEventListener('click', () => {
                    if (!formularioActivo) return;

                    const url = formularioActivo.dataset.url;
                    const data = new FormData(formularioActivo);
                    const contenedor = formularioActivo.closest('.form-section');

                    fetch(url, {
                        method: 'POST',
                        body: data
                    })
                        .then(res => res.json())
                        .then(result => {
                            alert(result.message);
                            if (result.success && contenedor) {
                                formularioActivo.reset();
                                ocultarFormulario(contenedor.id);
                            }
                        })
                        .catch(err => {
                            alert('Error al procesar la operación.');
                            console.error(err);
                        });

                    bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionGlobal')).hide();
                });
            </script>
            <!--JS-AJAX PARA EL MODAL DE CONFIRMACIÓN-->

            <!--JS AJAX SELECCIONAR ROLES EN CRERA USUARIO-->
            <script>
                function actualizarEmpresaUsuario() {
                    const select = document.getElementById('empresa_select_usuario');
                    const selected = select.options[select.selectedIndex];
                    const id = selected.getAttribute('data-id') || '';
                    document.getElementById('empresa_id').value = id;
                    actualizarPerfilesPorEmpresaYOperacion();
                }

                function actualizarPerfilesPorEmpresaYOperacion() {
                    const empresaId = document.getElementById('empresa_id').value;
                    const operacion = document.getElementById('operacion_usuario').value;

                    console.log("→ buscando perfiles para:", empresaId, operacion); // ✅ nuevo

                    if (!empresaId || !operacion) {
                        document.getElementById('perfil').innerHTML = '<option value="">Seleccione un perfil disponible</option>';
                        return;
                    }

                    fetch(`/obtener_perfiles?empresa_id=${encodeURIComponent(empresaId)}&operacion=${encodeURIComponent(operacion)}`)
                        .then(res => res.json())
                        .then(data => {
                            const perfilSelect = document.getElementById('perfil_usuario');
                            perfilSelect.innerHTML = '<option value="">Seleccione un perfil disponible</option>';
                            data.perfiles.forEach(perfil => {
                                const option = document.createElement('option');
                                option.value = perfil;
                                option.textContent = perfil;
                                perfilSelect.appendChild(option);
                            });
                        })
                        .catch(err => {
                            console.error('Error al obtener perfiles:', err);
                            alert('No se pudieron cargar los perfiles.');
                        });
                }

            </script>



            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>