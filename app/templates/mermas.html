<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro Mermas | BQA ONE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#015249">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root { --primary: #015249; --primary-light: #e0f2f1; --accent: #2e7d32; --bg-body: #f8fafc; --text-dark: #1e293b; --text-gray: #64748b; --border-color: #cbd5e1; --radius: 12px; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-dark); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    
    .app-header { width: 100%; max-width: 500px; background: white; padding: 12px 20px; border-radius: var(--radius); box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 3px solid var(--primary); }
    .logos-container { display: flex; align-items: center; gap: 15px; }
    .logo-img { height: 35px; width: auto; object-fit: contain; }
    .divider { width: 1px; height: 25px; background: var(--border-color); }
    .btn-logout { font-size: 0.75rem; color: #ef4444; text-decoration: none; font-weight: bold; }

    .card { background: white; width: 100%; max-width: 500px; padding: 25px 20px; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
    .hidden { display: none !important; }
    h2 { color: var(--primary); font-size: 1.3rem; margin: 0 0 15px 0; text-align: center; }
    label { display: block; font-weight: 600; margin-bottom: 6px; margin-top: 15px; font-size: 0.9rem; }
    input, select { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
    .btn { width: 100%; padding: 16px; font-size: 1rem; font-weight: 700; border-radius: 10px; border: none; cursor: pointer; margin-top: 25px; }
    .btn:disabled { background: #94a3b8; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); margin-top: 10px; }

    .upload-box { border: 2px dashed #cbd5e1; padding: 15px; text-align: center; border-radius: 8px; margin-top: 10px; position: relative; background: #fafafa; transition: all 0.2s; }
    .upload-box input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor: pointer; }
    .upload-box.file-loaded { background: #dcfce7; border-color: #16a34a; color: #166534; font-weight: bold; }
    .upload-box.file-loaded::after { content: "‚úÖ Cargado"; display: block; font-size: 0.8rem; margin-top: 5px; }

    .summary-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
    .summary-table th { background: #f1f5f9; padding: 8px; text-align: left; }
    .summary-table td { border-bottom: 1px solid #eee; padding: 8px; }

    .status-wait { text-align: center; padding: 40px 20px; }
    .spinner { width: 48px; height: 48px; border: 5px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .info-bar { background: #f0fdf4; color: #15803d; padding: 10px; border-radius: 8px; text-align: center; font-size: 0.85rem; font-weight: bold; margin-bottom: 15px; }
  </style>
</head>
<body>

  <header class="app-header">
    <div class="logos-container">
        <img src="{{ url_for('static', filename='logo_' + session.get('empresa', 'default') + '.png') }}" class="logo-img" onerror="this.style.display='none'">
        <div class="divider"></div>
        <img src="/static/logo_energix360.png" class="logo-img">
    </div>
    <a href="/logout" class="btn-logout">Salir</a>
  </header>

  <div id="step-header" class="card">
    <h2>üöö Datos del Viaje</h2>
    <label>NIT Cliente (Sin DV)</label> 
    <input type="number" id="cliente_nit" placeholder="Ej: 890900608">
    <label>Veh√≠culo</label>
    <select id="vehiculo">
        <option value="" disabled selected>Seleccione...</option>
        <option value="TGU321">TGU321</option><option value="WNV689">WNV689</option>
        <option value="TGT260">TGT260</option><option value="TGN967">TGN967</option>
        <option value="TGU158">TGU158</option><option value="WTL092">WTL092</option>
        <option value="WTL606">WTL606</option><option value="TGM827">TGM827</option>
        <option value="WTP830">WTP830</option><option value="TGT894">TGT894</option>
        <option value="TGU357">TGU357</option><option value="GIL637">GIL637</option>
        <option value="WTN176">WTN176</option>
    </select>
    <label>N√∫mero de Factura</label> 
    <input type="text" id="factura" placeholder="Ej: F-12345">
    <label>Total Kg Factura</label>
    <input type="number" id="total_factura_kg" step="0.01" placeholder="Ej: 5000.00">
    <button class="btn btn-primary" onclick="goToItems()">Iniciar Factura</button>
  </div>

  <div id="step-item" class="card hidden">
    <div class="info-bar" id="lbl_info_header"></div>
    <h2 id="item-title-text">üì¶ Agregar √çtem</h2>
    <label>Producto</label>
    <input type="text" id="item_name" list="list_prods" placeholder="Buscar producto...">
    <datalist id="list_prods">
        <option value="Pollo en Canal"><option value="Pechuga"><option value="Muslo"><option value="Alas"><option value="Menudencia">
    </datalist>
    <div style="display:flex; gap:15px;">
        <div style="flex:1;"><label>Kg Fact.</label><input type="number" id="kg_f" step="0.01"></div>
        <div style="flex:1;"><label>Kg Entr.</label><input type="number" id="kg_e" step="0.01"></div>
    </div>
    <label style="margin-top:20px;">Evidencias (Obligatorias)</label>
    <div class="upload-box" id="box_vid">üìπ Video <input type="file" id="f_vid" accept="video/*" capture="environment" onchange="handleFile(this, 'box_vid')"></div>
    <div style="display:flex; gap:10px;">
        <div class="upload-box" id="box_f1" style="flex:1;">üì∏ Foto 1 <input type="file" id="f_1" accept="image/*" capture="environment" onchange="handleFile(this, 'box_f1')"></div>
        <div class="upload-box" id="box_f2" style="flex:1;">üì∏ Foto 2 <input type="file" id="f_2" accept="image/*" capture="environment" onchange="handleFile(this, 'box_f2')"></div>
    </div>
    <button id="btn-submit-item" class="btn btn-primary" onclick="submitItem()">Registrar √çtem</button>
  </div>

  <div id="step-wait" class="card hidden status-wait">
    <div class="spinner"></div>
    <h3 style="color:#d97706;">Esperando Aprobaci√≥n</h3>
    <p>La merma excede el l√≠mite permitido.</p>
    <div style="background:#fff7ed; padding:15px; border-radius:8px; color:#9a3412; font-size:0.9rem; margin-top:15px;">
        El controlador est√° revisando su solicitud.<br>Por favor espere en esta pantalla.
    </div>
  </div>

  <div id="step-decide" class="card hidden" style="text-align:center;">
    <div style="font-size:3rem; margin-bottom:10px;">‚úÖ</div>
    <h2>√çtem Registrado</h2>
    <p>¬øDesea agregar otro √≠tem a esta factura?</p>
    <button class="btn btn-primary" onclick="nextItem(true)">S√≠, agregar otro</button>
    <button class="btn btn-outline" onclick="nextItem(false)">No, terminar factura</button>
  </div>

  <div id="step-summary" class="card hidden">
    <h2>üìÑ Resumen Factura</h2>
    <div style="margin-bottom:10px; font-size:0.9rem;">
        <b>Cliente:</b> <span id="sum_cli"></span><br>
        <b>Factura:</b> <span id="sum_fac"></span><br>
        <b>Total Kg Factura:</b> <span id="sum_kg_total"></span>
    </div>
    <table class="summary-table">
        <thead><tr><th>Prod</th><th>Fact</th><th>Entr</th><th>%</th></tr></thead>
        <tbody id="table_body"></tbody>
    </table>
    <div style="margin-top:20px; text-align:right; font-weight:bold; font-size:1.1rem;">
        Total Merma: <span id="total_merma_kg" style="color:#b91c1c;">0.00</span> kg
    </div>
    <label style="margin-top:30px; color:#d97706;">N√∫mero de Nota General</label>
    <input type="text" id="nota_general" placeholder="Ingrese consecutivo..." style="border:2px solid #fbbf24; background:#fffbeb; text-align:center; font-weight:bold;">
    <button class="btn btn-primary" onclick="finishInvoice()">TERMINAR FACTURA</button>
  </div>

  <div id="step-next-inv" class="card hidden" style="text-align:center;">
    <h2>Factura Finalizada</h2>
    <p>¬øDesea agregar <b>otra factura</b> para el mismo cliente (<span id="next_cli_name"></span>)?</p>
    <button class="btn btn-primary" onclick="sameClientNewInvoice()">S√≠, mismo cliente</button>
    <button class="btn btn-outline" onclick="location.reload()">No, salir / otro cliente</button>
  </div>

  <script>
    let HEADER_DATA = {};
    let CURRENT_ITEMS_LOCAL = []; 
    let IS_RETRY_MODE = false;
    let RETRY_ITEM_ID = null;

    const getEl = id => document.getElementById(id);
    const showStep = (id) => {
        ['step-header', 'step-item', 'step-wait', 'step-decide', 'step-summary', 'step-next-inv'].forEach(sid => getEl(sid).classList.add('hidden'));
        getEl(id).classList.remove('hidden');
    };
    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    function handleFile(input, boxId) {
        if(input.files && input.files[0]) {
            document.getElementById(boxId).classList.add('file-loaded');
        } else {
            document.getElementById(boxId).classList.remove('file-loaded');
        }
    }
    function resetFileBoxes() {
        ['box_vid', 'box_f1', 'box_f2'].forEach(id => getEl(id).classList.remove('file-loaded'));
        ['f_vid', 'f_1', 'f_2'].forEach(id => getEl(id).value = "");
    }

    function goToItems() {
        const cli = getEl('cliente_nit').value;
        const veh = getEl('vehiculo').value;
        const fac = getEl('factura').value;
        const tot = getEl('total_factura_kg').value;
        if(!cli || !veh || !fac || !tot) return alert("Complete todos los datos de la cabecera (incluyendo Total Kg).");
        HEADER_DATA = { cliente: cli, vehiculo: veh, factura: fac, total_kg: tot };
        getEl('lbl_info_header').innerText = `Factura: ${fac} | Veh√≠culo: ${veh}`;
        IS_RETRY_MODE = false;
        showStep('step-item');
    }

    async function submitItem() {
        const prod = getEl('item_name').value;
        const kgf = parseFloat(getEl('kg_f').value);
        const kge = parseFloat(getEl('kg_e').value);
        const fv = getEl('f_vid').files[0];
        const f1 = getEl('f_1').files[0];
        const f2 = getEl('f_2').files[0];

        if(!prod || isNaN(kgf) || isNaN(kge)) return alert("Datos del √≠tem incompletos.");
        if(!fv || !f1 || !f2) return alert("Debe cargar Video y 2 Fotos.");

        const btn = getEl('btn-submit-item');
        const originalText = IS_RETRY_MODE ? "Rectificar √çtem" : "Registrar √çtem";
        btn.innerHTML = "‚è≥ Enviando..."; btn.disabled = true;

        try {
            const [bVid, bFoto1, bFoto2] = await Promise.all([toBase64(fv), toBase64(f1), toBase64(f2)]);
            const itemPayload = { item: prod, kg_facturados: kgf, kg_entregados: kge, evidencia_url: bVid, evidencia_url2: bFoto1, evidencia_url3: bFoto2 };
            const payload = { ...HEADER_DATA, items: [itemPayload], is_retry: IS_RETRY_MODE, retry_id: RETRY_ITEM_ID };

            const r = await fetch('/mermas/registrar', { method: 'POST', body: JSON.stringify(payload) });
            const resp = await r.json();
            if(!resp.success) throw new Error(resp.message || "Error desconocido");

            if(IS_RETRY_MODE) CURRENT_ITEMS_LOCAL.pop(); 
            CURRENT_ITEMS_LOCAL.push({ prod, kgf, kge, merma: kgf-kge, pct: ((kgf-kge)/kgf)*100 });

            if(resp.status === 'pendiente' || resp.status === 'segunda_revision') {
                showStep('step-wait');
                startPolling(HEADER_DATA.factura);
            } else {
                IS_RETRY_MODE = false;
                showStep('step-decide');
            }
        } catch(e) { alert("Error: " + e.message); } finally { btn.innerHTML = originalText; btn.disabled = false; }
    }

    let pollInterval;
    function startPolling(fac) {
        if(pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(async () => {
            try {
                const r = await fetch(`/mermas/check_status_live?factura=${fac}&nc=${Date.now()}`);
                const d = await r.json();
                if(d.completed) {
                    clearInterval(pollInterval);
                    if(d.status === 'en_revision') {
                        // AQU√ç EST√Å EL MENSAJE CLAVE PARA EL OPERADOR
                        alert("‚ö†Ô∏è SU PESAJE FUE OBJETADO. Por favor, vuelva a pesar el producto asegurando que la b√°scula est√© en ceros y suba nuevas evidencias.");
                        prepareRectification(d.id);
                    } else if (d.status === 'objetada') {
                        alert("‚ö†Ô∏è MERMA EN AUDITOR√çA. El sistema permite continuar, pero el caso queda bajo investigaci√≥n.");
                        IS_RETRY_MODE = false;
                        showStep('step-decide');
                    } else if (d.status === 'rechazada') {
                        alert("‚ùå MERMA RECHAZADA.");
                        IS_RETRY_MODE = false;
                        showStep('step-decide');
                    } else {
                        IS_RETRY_MODE = false;
                        showStep('step-decide'); 
                    }
                }
            } catch(e) {}
        }, 5000);
    }

    function prepareRectification(id) {
        showStep('step-item');
        IS_RETRY_MODE = true;
        RETRY_ITEM_ID = id;
        getEl('item-title-text').innerText = "‚ö†Ô∏è RECTIFICAR: VUELVA A PESAR";
        getEl('item-title-text').style.color = "#b45309";
        getEl('btn-submit-item').innerText = "Reenviar Rectificaci√≥n";
        resetFileBoxes();
        getEl('kg_f').value = "";
        getEl('kg_e').value = "";
    }

    function nextItem(addAnother) {
        if(addAnother) {
            getEl('item_name').value = "";
            getEl('kg_f').value = "";
            getEl('kg_e').value = "";
            resetFileBoxes();
            IS_RETRY_MODE = false;
            getEl('item-title-text').innerText = "üì¶ Agregar √çtem";
            getEl('item-title-text').style.color = "var(--primary)";
            getEl('btn-submit-item').innerText = "Registrar √çtem";
            showStep('step-item');
        } else {
            buildSummary();
            showStep('step-summary');
        }
    }

    function buildSummary() {
        getEl('sum_cli').innerText = HEADER_DATA.cliente;
        getEl('sum_fac').innerText = HEADER_DATA.factura;
        getEl('sum_kg_total').innerText = HEADER_DATA.total_kg; 
        const tbody = getEl('table_body');
        tbody.innerHTML = '';
        let totalMerma = 0;
        CURRENT_ITEMS_LOCAL.forEach(it => {
            totalMerma += it.merma;
            tbody.innerHTML += `<tr><td>${it.prod}</td><td>${it.kgf}</td><td>${it.kge}</td><td style="color:${it.pct>2?'#b91c1c':'#15803d'}">${it.pct.toFixed(1)}%</td></tr>`;
        });
        getEl('total_merma_kg').innerText = totalMerma.toFixed(2);
    }

    async function finishInvoice() {
        const nota = getEl('nota_general').value;
        if(!nota) return alert("Debe ingresar el n√∫mero de la Nota General.");
        const btn = document.querySelector('#step-summary .btn-primary');
        btn.innerHTML = "Finalizando..."; btn.disabled = true;
        try {
            await fetch('/mermas/finalizar_con_nota', { method: 'POST', body: JSON.stringify({ factura: HEADER_DATA.factura, nota: nota }) });
            getEl('next_cli_name').innerText = HEADER_DATA.cliente;
            showStep('step-next-inv');
        } catch(e) { alert("Error al finalizar. Intente nuevamente."); } finally { btn.innerHTML = "TERMINAR FACTURA"; btn.disabled = false; }
    }

    function sameClientNewInvoice() {
        getEl('factura').value = "";
        getEl('total_factura_kg').value = ""; 
        getEl('item_name').value = "";
        getEl('kg_f').value = "";
        getEl('kg_e').value = "";
        resetFileBoxes();
        CURRENT_ITEMS_LOCAL = []; 
        IS_RETRY_MODE = false;
        showStep('step-header');
    }
  </script>
</body>
</html>