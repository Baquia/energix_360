<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro Mermas | BQA ONE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#015249">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root { --primary: #015249; --bg-body: #f8fafc; --text-dark: #1e293b; --border-color: #cbd5e1; --radius: 12px; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-dark); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    
    .app-header { width: 100%; max-width: 500px; background: white; padding: 12px 20px; border-radius: var(--radius); box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 3px solid var(--primary); }
    .logos-container { display: flex; align-items: center; gap: 15px; }
    .logo-img { height: 35px; width: auto; object-fit: contain; }
    .divider { width: 1px; height: 25px; background: var(--border-color); }
    .btn-logout { font-size: 0.75rem; color: #ef4444; text-decoration: none; font-weight: bold; }

    .card { background: white; width: 100%; max-width: 500px; padding: 25px 20px; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .hidden { display: none !important; }
    h2 { color: var(--primary); font-size: 1.3rem; margin: 0 0 15px 0; text-align: center; }
    label { display: block; font-weight: 600; margin-bottom: 6px; margin-top: 15px; font-size: 0.9rem; }
    input, select { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
    
    .btn { width: 100%; padding: 16px; font-size: 1rem; font-weight: 700; border-radius: 10px; border: none; cursor: pointer; margin-top: 25px; }
    .btn:disabled { background: #94a3b8; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); margin-top: 10px; }
    .btn-danger { background: #b91c1c; color: white; margin-top: 10px; }

    /* ESTILOS DE EVIDENCIA */
    .upload-box { border: 2px dashed #cbd5e1; padding: 15px; text-align: center; border-radius: 8px; margin-top: 10px; position: relative; background: #fafafa; }
    .upload-box input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor: pointer; }
    .upload-box.file-loaded { background: #dcfce7; border-color: #16a34a; color: #166534; font-weight: bold; }
    .upload-box.file-loaded::after { content: "‚úÖ Listo"; display: block; font-size: 0.8rem; margin-top: 5px; }

    /* ESTILOS C√ÅMARA WEB */
    #camera-container { display: none; margin-top: 15px; background: #000; border-radius: 8px; overflow: hidden; position: relative; }
    #camera-preview { width: 100%; height: 250px; object-fit: cover; background: #000; }
    .rec-indicator { position: absolute; top: 10px; right: 10px; background: red; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; animation: blink 1s infinite; display: none; }
    @keyframes blink { 50% { opacity: 0.5; } }
    
    .video-status { font-size: 0.9rem; margin-top: 5px; text-align: center; color: #666; font-weight: bold; }
    .video-status.success { color: #16a34a; }

    .summary-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
    .summary-table th { background: #f1f5f9; padding: 8px; text-align: left; }
    .summary-table td { border-bottom: 1px solid #eee; padding: 8px; }
    .info-bar { background: #f0fdf4; color: #15803d; padding: 10px; border-radius: 8px; text-align: center; font-size: 0.85rem; font-weight: bold; margin-bottom: 15px; }
  </style>
</head>
<body>

  <header class="app-header">
    <div class="logos-container">
        <img src="{{ url_for('static', filename='logo_' + session.get('empresa', 'default') + '.png') }}" class="logo-img" onerror="this.style.display='none'">
        <div class="divider"></div>
        <img src="/static/logo_energix360.png" class="logo-img">
    </div>
    <a href="/logout" class="btn-logout">Salir</a>
  </header>

  <div id="step-header" class="card">
    <h2>üöö Datos del Viaje</h2>
    <label>NIT Cliente (Sin DV)</label> 
    <input type="number" id="cliente_nit" placeholder="Ej: 890900608">
    <label>Veh√≠culo</label>
    <select id="vehiculo">
        <option value="" disabled selected>Seleccione...</option>
        <option value="TGU321">TGU321</option><option value="WNV689">WNV689</option>
        <option value="TGT260">TGT260</option><option value="TGN967">TGN967</option>
        <option value="TGU158">TGU158</option><option value="WTL092">WTL092</option>
        <option value="WTL606">WTL606</option><option value="TGM827">TGM827</option>
        <option value="WTP830">WTP830</option><option value="TGT894">TGT894</option>
        <option value="TGU357">TGU357</option><option value="GIL637">GIL637</option>
        <option value="WTN176">WTN176</option>
    </select>
    <label>N√∫mero de Factura</label> 
    <input type="text" id="factura" placeholder="Ej: F-12345">
    <label>Total Kg Factura</label>
    <input type="number" id="total_factura_kg" step="0.01" placeholder="Ej: 5000.00">
    <button class="btn btn-primary" onclick="goToItems()">Iniciar Factura</button>
  </div>

  <div id="step-item" class="card hidden">
    <div class="info-bar" id="lbl_info_header"></div>
    <h2 id="item-title-text">üì¶ Agregar √çtem</h2>
    <label>Producto</label>
    <input type="text" id="item_name" list="list_prods" placeholder="Buscar producto...">
    <datalist id="list_prods">
        <option value="Pollo en Canal"><option value="Pechuga"><option value="Muslo"><option value="Alas"><option value="Menudencia">
    </datalist>
    <div style="display:flex; gap:15px;">
        <div style="flex:1;"><label>Kg Fact.</label><input type="number" id="kg_f" step="0.01"></div>
        <div style="flex:1;"><label>Kg Entr.</label><input type="number" id="kg_e" step="0.01"></div>
    </div>
    
    <label style="margin-top:20px;">Evidencias</label>
    
    <div style="border:1px solid #ddd; padding:10px; border-radius:8px; margin-bottom:10px;">
        <div class="video-status" id="video-status-text">üìπ Video requerido (Max 6 seg)</div>
        
        <button id="btn-open-camera" class="btn btn-outline" style="margin-top:5px; padding:10px;" onclick="openCamera()">Abrir C√°mara</button>
        
        <div id="camera-container">
            <video id="camera-preview" autoplay muted playsinline></video>
            <div id="rec-dot" class="rec-indicator">GRABANDO</div>
        </div>
        
        <button id="btn-record" class="btn btn-danger hidden" style="margin-top:5px; padding:10px;" onclick="startRecording()">üî¥ GRABAR (6s)</button>
    </div>

    <div style="display:flex; gap:10px;">
        <div class="upload-box" id="box_f1" style="flex:1;">
            üì∏ Foto 1 <input type="file" id="f_1" accept="image/*" capture="environment" onchange="processImage(this, 'box_f1')">
        </div>
        <div class="upload-box" id="box_f2" style="flex:1;">
            üì∏ Foto 2 <input type="file" id="f_2" accept="image/*" capture="environment" onchange="processImage(this, 'box_f2')">
        </div>
    </div>
    
    <button id="btn-submit-item" class="btn btn-primary" onclick="submitItem()">Registrar √çtem</button>
  </div>

  <div id="step-wait" class="card hidden status-wait">
    <h3 style="color:#d97706;">Esperando Aprobaci√≥n</h3>
    <div style="font-size:3rem;">‚è≥</div>
    <p>La merma excede el l√≠mite permitido.</p>
    <div style="background:#fff7ed; padding:15px; border-radius:8px; color:#9a3412; font-size:0.9rem; margin-top:15px;">
        El controlador est√° revisando su solicitud.
    </div>
  </div>

  <div id="step-decide" class="card hidden" style="text-align:center;">
    <div style="font-size:3rem; margin-bottom:10px;">‚úÖ</div>
    <h2>√çtem Registrado</h2>
    <p>¬øDesea agregar otro √≠tem a esta factura?</p>
    <button class="btn btn-primary" onclick="nextItem(true)">S√≠, agregar otro</button>
    <button class="btn btn-outline" onclick="nextItem(false)">No, terminar factura</button>
  </div>

  <div id="step-summary" class="card hidden">
    <h2>üìÑ Resumen Factura</h2>
    <div style="margin-bottom:10px; font-size:0.9rem;">
        <b>Cliente:</b> <span id="sum_cli"></span> | <b>Factura:</b> <span id="sum_fac"></span>
    </div>
    <table class="summary-table">
        <thead><tr><th>Prod</th><th>Fact</th><th>Entr</th><th>%</th></tr></thead>
        <tbody id="table_body"></tbody>
    </table>
    <div style="margin-top:20px; text-align:right; font-weight:bold; font-size:1.1rem;">
        Total Merma: <span id="total_merma_kg" style="color:#b91c1c;">0.00</span> kg
    </div>
    <label style="margin-top:30px; color:#d97706;">N√∫mero de Nota General</label>
    <input type="text" id="nota_general" placeholder="Ingrese consecutivo..." style="border:2px solid #fbbf24; background:#fffbeb; text-align:center; font-weight:bold;">
    <button class="btn btn-primary" onclick="finishInvoice()">TERMINAR FACTURA</button>
  </div>

  <div id="step-next-inv" class="card hidden" style="text-align:center;">
    <h2>Factura Finalizada</h2>
    <p>¬øOtra factura para <b id="next_cli_name"></b>?</p>
    <button class="btn btn-primary" onclick="sameClientNewInvoice()">S√≠, mismo cliente</button>
    <button class="btn btn-outline" onclick="location.reload()">No, otro cliente</button>
  </div>

  <script>
    let HEADER_DATA = {};
    let CURRENT_ITEMS_LOCAL = []; 
    let IS_RETRY_MODE = false;
    let RETRY_ITEM_ID = null;
    
    // Variables para archivos
    let finalVideoBlob = null;
    let finalVideoBase64 = null;
    let processedFiles = { f1: null, f2: null };
    
    // Variables de c√°mara
    let mediaStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];

    const getEl = id => document.getElementById(id);
    const showStep = (id) => {
        ['step-header', 'step-item', 'step-wait', 'step-decide', 'step-summary', 'step-next-inv'].forEach(sid => getEl(sid).classList.add('hidden'));
        getEl(id).classList.remove('hidden');
    };

    // --- L√ìGICA DE C√ÅMARA INTEGRADA (BAJO PESO) ---
    async function openCamera() {
        try {
            // Pedimos video de baja resoluci√≥n (480p ideal, 240p minimo)
            const constraints = { 
                video: { 
                    facingMode: "environment",
                    width: { ideal: 640 }, 
                    height: { ideal: 480 } 
                }, 
                audio: false 
            };
            
            mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
            const videoEl = getEl('camera-preview');
            videoEl.srcObject = mediaStream;
            
            getEl('camera-container').style.display = 'block';
            getEl('btn-open-camera').classList.add('hidden');
            getEl('btn-record').classList.remove('hidden');
            getEl('video-status-text').innerText = "Encuadre y presione GRABAR";
            
        } catch (err) {
            alert("No se pudo acceder a la c√°mara. Aseg√∫rese de dar permisos.");
            console.error(err);
        }
    }

    function startRecording() {
        recordedChunks = [];
        let options = { mimeType: 'video/webm;codecs=vp8', videoBitsPerSecond: 500000 }; 
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
            options = { mimeType: 'video/mp4', videoBitsPerSecond: 500000 }; 
             if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options = {}; 
             }
        }

        try {
            mediaRecorder = new MediaRecorder(mediaStream, options);
        } catch (e) {
            mediaRecorder = new MediaRecorder(mediaStream);
        }

        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) recordedChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            finalVideoBlob = blob;
            finalVideoBase64 = await blobToBase64(blob);
            
            getEl('camera-container').style.display = 'none';
            getEl('btn-record').classList.add('hidden');
            getEl('video-status-text').innerText = `‚úÖ Video grabado (${(blob.size/1024).toFixed(0)} KB)`;
            getEl('video-status-text').classList.add('success');
            
            if(mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
        };

        mediaRecorder.start();
        getEl('rec-dot').style.display = 'block';
        
        // UI grabando
        const btnRec = getEl('btn-record');
        btnRec.disabled = true;
        btnRec.innerText = "Grabando...";

        setTimeout(() => {
            if(mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                getEl('rec-dot').style.display = 'none';
            }
        }, 6000);
    }

    // --- PROCESAMIENTO DE FOTOS (COMPRESI√ìN) ---
    async function processImage(input, boxId) {
        const file = input.files[0];
        if (!file) return;
        
        const box = getEl(boxId);
        box.style.opacity = '0.5';
        
        try {
            const compressed = await compressImage(file);
            if(boxId === 'box_f1') processedFiles.f1 = compressed;
            if(boxId === 'box_f2') processedFiles.f2 = compressed;
            
            box.classList.add('file-loaded');
            box.style.opacity = '1';
        } catch (e) {
            alert("Error procesando imagen");
            box.style.opacity = '1';
        }
    }

    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; 
                    const scaleSize = MAX_WIDTH / img.width;
                    const width = (img.width > MAX_WIDTH) ? MAX_WIDTH : img.width;
                    const height = (img.width > MAX_WIDTH) ? (img.height * scaleSize) : img.height;
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
            };
        });
    }

    const blobToBase64 = blob => new Promise((resolve, _) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
    });

    // --- FUNCION DE LIMPIEZA DE C√ÅMARA (CORRECCI√ìN) ---
    function resetCameraUI() {
        // 1. Limpiar variables
        finalVideoBase64 = null;
        processedFiles = { f1: null, f2: null };
        mediaStream = null;
        mediaRecorder = null;

        // 2. Restaurar Textos y Clases de UI
        const statusTxt = getEl('video-status-text');
        statusTxt.innerText = "üìπ Video requerido (Max 6 seg)";
        statusTxt.classList.remove('success');

        const btnOpen = getEl('btn-open-camera');
        btnOpen.classList.remove('hidden');

        const btnRec = getEl('btn-record');
        btnRec.classList.add('hidden');
        btnRec.disabled = false;       // <--- Importante: Reactivar bot√≥n
        btnRec.innerText = "üî¥ GRABAR (6s)"; // <--- Importante: Restaurar texto

        getEl('camera-container').style.display = 'none';
        getEl('rec-dot').style.display = 'none';

        // 3. Limpiar Inputs Fotos
        getEl('box_f1').classList.remove('file-loaded');
        getEl('box_f2').classList.remove('file-loaded');
        getEl('f_1').value = "";
        getEl('f_2').value = "";
    }

    // --- FLUJO DE NAVEGACI√ìN ---
    function goToItems() {
        const cli = getEl('cliente_nit').value;
        const veh = getEl('vehiculo').value;
        const fac = getEl('factura').value;
        const tot = getEl('total_factura_kg').value;
        if(!cli || !veh || !fac || !tot) return alert("Complete los datos del viaje.");
        HEADER_DATA = { cliente: cli, vehiculo: veh, factura: fac, total_kg: tot };
        getEl('lbl_info_header').innerText = `Fac: ${fac} | Veh: ${veh}`;
        IS_RETRY_MODE = false;
        resetCameraUI(); // Asegurar limpieza al entrar
        showStep('step-item');
    }

    async function submitItem() {
        const prod = getEl('item_name').value;
        const kgf = parseFloat(getEl('kg_f').value);
        const kge = parseFloat(getEl('kg_e').value);

        if(!prod || isNaN(kgf) || isNaN(kge)) return alert("Complete los datos del √≠tem.");
        if(!finalVideoBase64) return alert("Debe grabar el video de evidencia.");
        if(!processedFiles.f1 || !processedFiles.f2) return alert("Debe tomar las 2 fotos.");

        const btn = getEl('btn-submit-item');
        const originalText = btn.innerText;
        btn.innerText = "Enviando..."; btn.disabled = true;

        try {
            const itemPayload = { 
                item: prod, kg_facturados: kgf, kg_entregados: kge, 
                evidencia_url: finalVideoBase64, 
                evidencia_url2: processedFiles.f1, 
                evidencia_url3: processedFiles.f2 
            };
            const payload = { ...HEADER_DATA, items: [itemPayload], is_retry: IS_RETRY_MODE, retry_id: RETRY_ITEM_ID };

            const r = await fetch('/mermas/registrar', { method: 'POST', body: JSON.stringify(payload) });
            
            // Manejo de HTML error response
            if (!r.ok) {
               throw new Error("Error del Servidor. Intente nuevamente.");
            }

            const resp = await r.json();
            
            if(!resp.success) throw new Error(resp.message || "Error");

            if(IS_RETRY_MODE) CURRENT_ITEMS_LOCAL.pop(); 
            CURRENT_ITEMS_LOCAL.push({ prod, kgf, kge, merma: kgf-kge, pct: ((kgf-kge)/kgf)*100 });

            if(resp.status === 'pendiente' || resp.status === 'segunda_revision') {
                showStep('step-wait');
                startPolling(HEADER_DATA.factura);
            } else {
                IS_RETRY_MODE = false;
                showStep('step-decide');
            }
        } catch(e) { alert("Error: " + e.message); } finally { btn.innerText = originalText; btn.disabled = false; }
    }

    let pollInterval;
    let pollInterval;
    function startPolling(fac) {
        if(pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(async () => {
            try {
                const r = await fetch(`/mermas/check_status_live?factura=${fac}&nc=${Date.now()}`);
                const d = await r.json();
                
                if(d.completed) {
                    clearInterval(pollInterval);

                    // CASO 1: PRIMER RECHAZO (Controlador pide rectificar)
                    if(d.status === 'en_revision') {
                        alert("‚ö†Ô∏è SU PESAJE FUE OBJETADO. Rectifique.");
                        prepareRectification(d.id);
                    
                    // CASO 2: SEGUNDO RECHAZO (Controlador objeta definitivamente) -> NUEVA L√ìGICA
                    } else if (d.status === 'objetada') {
                        alert("üö® ATENCI√ìN: La validaci√≥n sigue NO CONFORME.\n\nEl registro se ha guardado, pero el caso pasar√° a INVESTIGACI√ìN.\n\nPuede continuar con el siguiente √≠tem.");
                        IS_RETRY_MODE = false;
                        showStep('step-decide');

                    // CASO 3: APROBADO (Todo OK)
                    } else {
                        // Aqu√≠ entra 'aprobada' o 'validada'
                        IS_RETRY_MODE = false;
                        showStep('step-decide');
                    }
                }
            } catch(e) {}
        }, 5000);
    }

    function prepareRectification(id) {
        showStep('step-item');
        IS_RETRY_MODE = true; RETRY_ITEM_ID = id;
        resetCameraUI(); // Limpiar UI para la nueva toma
        
        getEl('item-title-text').innerText = "‚ö†Ô∏è RECTIFICAR";
        getEl('item-title-text').style.color = "#b45309";
        getEl('kg_f').value = ""; getEl('kg_e').value = "";
    }

    function nextItem(addAnother) {
        if(addAnother) {
            getEl('item_name').value = ""; getEl('kg_f').value = ""; getEl('kg_e').value = "";
            resetCameraUI(); // <--- AQU√ç SE CORRIGE EL BUG
            
            IS_RETRY_MODE = false;
            getEl('item-title-text').innerText = "üì¶ Agregar √çtem";
            getEl('item-title-text').style.color = "var(--primary)";
            showStep('step-item');
        } else {
            buildSummary();
            showStep('step-summary');
        }
    }

    function buildSummary() {
        getEl('sum_cli').innerText = HEADER_DATA.cliente;
        getEl('sum_fac').innerText = HEADER_DATA.factura;
        const tbody = getEl('table_body');
        tbody.innerHTML = '';
        let totalMerma = 0;
        CURRENT_ITEMS_LOCAL.forEach(it => {
            totalMerma += it.merma;
            tbody.innerHTML += `<tr><td>${it.prod}</td><td>${it.kgf}</td><td>${it.kge}</td><td>${it.pct.toFixed(1)}%</td></tr>`;
        });
        getEl('total_merma_kg').innerText = totalMerma.toFixed(2);
    }

    async function finishInvoice() {
        const nota = getEl('nota_general').value;
        if(!nota) return alert("Ingrese Nota General");
        const btn = document.querySelector('#step-summary .btn-primary');
        btn.innerText = "Finalizando..."; btn.disabled = true;
        try {
            await fetch('/mermas/finalizar_con_nota', { method: 'POST', body: JSON.stringify({ factura: HEADER_DATA.factura, nota: nota }) });
            getEl('next_cli_name').innerText = HEADER_DATA.cliente;
            showStep('step-next-inv');
        } catch(e) { alert("Error"); } finally { btn.innerText = "TERMINAR"; btn.disabled = false; }
    }

    function sameClientNewInvoice() {
        location.reload(); 
    }
  </script>
</body>
</html>