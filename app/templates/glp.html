<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>M√≥dulo GLP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="apple-touch-icon" href="/static/icon-192.png">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#015249">
  <script src="/static/js/html5-qrcode.min.js"></script>


  <style>
    :root {
      --verde: #015249;
      --verde-osc: #003b35;
      --bg: #f4f6f7;
      --rojo: #cc0000;
      --rojo-osc: #990000;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Verdana, Geneva, Tahoma, sans-serif;
      background: radial-gradient(circle at top, #d7f2ec 0, #f6f7f8 45%, #f6f7f8 100%);
      color: #111827;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .header {
      width: 100%;
      max-width: 720px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px 0 20px;
    }

    .logo {
      max-height: 52px;
      width: auto;
      object-fit: contain;
    }

    .wrap {
      width: 100%;
      max-width: 720px;
      margin: 16px auto 40px;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
      padding: 22px 18px 28px;
    }

    #saludo {
      color: var(--verde);
      font-size: 20px;
      text-align: left;
      margin: 0 0 6px;
      font-weight: 700;
    }

    #preguntaTexto {
      color: #111827;
      text-align: left;
      min-height: 24px;
      margin: 0 0 8px;
      font-size: 15px;
    }

    .menu {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }

    .menu-btn {
      flex: 1 1 calc(50% - 10px);
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #cfd8dc;
      background: #e5f4f1;
      color: #013b35;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s, transform .05s, box-shadow .15s;
    }

    .menu-btn:hover {
      background: #015249;
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, .18);
    }

    #conversacion {
      margin-top: 14px;
    }

    #lectorQR {
      width: 100%;
      max-width: 420px;
      margin: 12px auto;
    }

    #respuestaInput {
      width: 100%;
      border: 1px solid #cfd8dc;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 15px;
      margin-top: 10px;
    }

    #inputFoto {
      margin-top: 10px;
      font-size: 14px;
    }

    #preguntaSiNo {
      text-align: center;
      margin-top: 14px;
      display: none;
      gap: 8px;
      justify-content: center;
    }

    #btnSi,
    #btnNo {
      padding: 10px 18px;
      font-size: 15px;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      min-width: 90px;
    }

    #btnSi {
      background: #015249;
      margin-right: 6px;
    }

    #btnNo {
      background: #cc0000;
    }

    #botonEnviar {
      display: none;
      width: 100%;
      background: var(--verde);
      color: #ffffff;
      border: none;
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
    }

    #botonEnviar:hover {
      background: var(--verde-osc);
    }

    #panelResumen {
      margin-top: 20px;
      background: #f9fbfb;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 16px 14px 18px;
      display: none;
      font-size: 14px;
    }

    #panelResumen h3 {
      margin-top: 0;
      margin-bottom: 8px;
      color: var(--verde-osc);
      font-size: 18px;
      text-align: center;
    }

    #panelResumen p {
      margin: 3px 0;
    }

    #panelResumen .resumen-msg {
      margin-top: 10px;
      font-weight: bold;
      color: #333333;
      text-align: center;
    }

    #btnCerrarResumen {
      margin-top: 14px;
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: none;
      background: var(--verde);
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    #btnCerrarResumen:hover {
      background: var(--verde-osc);
    }

    .logout {
      margin-top: 20px;
      display: inline-block;
      background: var(--rojo);
      color: #ffffff;
      padding: 8px 14px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
    }

    .logout:hover {
      background: var(--rojo-osc);
    }

    /* Aviso de operaciones pendientes de sincronizar */
    #syncWarning {
      display: none;
      width: 100%;
      background: #fff5f5;
      border-radius: 10px;
      border: 1px solid #ffcdd2;
      padding: 10px 12px;
      margin: 8px 0 10px;
      color: #b71c1c;
      font-size: 14px;
      line-height: 1.4;
    }

    #syncWarning-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      font-weight: 700;
      color: #b71c1c;
    }

    #syncWarning-icon {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #b71c1c;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    #syncWarning-body {
      font-weight: 500;
      margin-bottom: 4px;
    }

    #syncWarning-steps {
      margin: 4px 0 0;
      padding-left: 18px;
      font-size: 13px;
    }

    #syncWarning-steps li {
      margin-bottom: 2px;
    }

    @media (max-width: 600px) {
      #syncWarning {
        font-size: 13px;
        padding: 8px 10px;
      }

      #syncWarning-steps {
        font-size: 12px;
      }
    }



    @media (max-width: 600px) {
      .header {
        flex-direction: column;
        align-items: center;
        gap: 6px;
      }

      .wrap {
        margin: 12px auto 28px;
        padding: 18px 14px 24px;
      }

      .menu-btn {
        flex: 1 1 100%;
      }
    }
  </style>

</head>



<body>
  <div class="header">
    <img src="{{ url_for('static', filename='logo_' + session['empresa'] + '.png') }}" class="logo" alt="Logo cliente">
    <img src="{{ url_for('static', filename='logo_energix360.png') }}" class="logo" alt="Logo Energix360">
  </div>

  <div class="wrap">
    <p id="saludo">¬°Hola {{ session.get('nombre','Usuario') }}!</p>

    <!-- Aviso de sincronizaci√≥n pendiente (se muestra solo cuando haga falta) -->
    <div id="syncWarning" style="display:none;">
      <!-- El contenido se llena desde JS -->
    </div>

    <p id="preguntaTexto"></p>


    <div id="menuOpciones" class="menu" style="display:flex">
      <button class="menu-btn" onclick="iniciarCalefaccion()">üî• Iniciar calefacci√≥n</button>
      <button class="menu-btn" onclick="registrarTanqueo()">‚õΩ Registrar tanqueo</button>
      <button class="menu-btn" onclick="registrarConsumo()">üìä Registrar consumo</button>
      <button class="menu-btn" onclick="finalizarCalefaccion()">üî• Finalizar calefacci√≥n</button>
    </div>

    <div id="conversacion" style="display:none">
      <div id="lectorQR" style="display:none"></div>
      <input id="respuestaInput" type="text" style="display:none" />
      <input id="inputFoto" type="file" accept="image/*" capture="environment" style="display:none" />
      <div id="preguntaSiNo" style="display:none; text-align:center; margin-top:14px;">
        <button id="btnSi" style="
        padding:10px 18px;
        margin-right:12px;
        font-size:16px;
        background:#015249;
        color:white;
        border:none;
        border-radius:8px;
    ">S√≠</button>

        <button id="btnNo" style="
        padding:10px 18px;
        font-size:16px;
        background:#cc0000;
        color:white;
        border:none;
        border-radius:8px;
    ">No</button>
      </div>

      <button id="botonEnviar">Enviar</button>
    </div>

    <!-- Panel reutilizable para el resumen de TODAS las operaciones -->
    <div id="panelResumen"></div>

    <a class="logout" href="/logout">Cerrar sesi√≥n</a>
  </div>

  <script>
    function generarOpId() {
      // Navegadores modernos
      if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
      // Fallback simple
      return "op_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    }


    /* ======================================
    VARIABLES PARA REGISTRAR TANQUEO NUEVO
    =======================================*/

    let registrarTanqueoData = {
      sede: "",
      tanques: [],
      op_id: generarOpId()
    };

    // Este arreglo se llenar√° con los tanques activos de la sede (TK-1, TK-2, etc)
    let tanquesDisponibles = [];

    // √çndice del tanque que estamos procesando
    let tanqueActualIndex = 0;

    // =======================================================
    // PROTECCI√ìN BASE CONTRA RECARGA, CIERRE Y NAVEGACI√ìN FUERA
    // =======================================================

    let GLP_OPERACION_EN_CURSO = false;

    // Evita recargar/cerrar la p√°gina mientras hay una operaci√≥n en curso
    function bloquearSalida(e) {
      if (GLP_OPERACION_EN_CURSO) {
        e.preventDefault();
        e.returnValue = "";
        return "";
      }
    }

    // Activar protecci√≥n
    function activarProteccionOperacion() {
      GLP_OPERACION_EN_CURSO = true;
      window.addEventListener("beforeunload", bloquearSalida);
    }

    // Desactivar protecci√≥n
    function desactivarProteccionOperacion() {
      GLP_OPERACION_EN_CURSO = false;
      window.removeEventListener("beforeunload", bloquearSalida);
    }

    // =======================================================
    // BLOQUEO DEL BOT√ìN ATR√ÅS DEL NAVEGADOR
    // =======================================================

    function bloquearBotonAtras() {
      // Insertamos una entrada ficticia en el historial
      history.pushState(null, "", location.href);

      window.onpopstate = function () {
        if (GLP_OPERACION_EN_CURSO) {
          // Evitar retroceder
          history.pushState(null, "", location.href);
          alert("No puedes retroceder mientras realizas una operaci√≥n GLP.");
        } else {
          // Si no hay operaci√≥n, permitimos navegaci√≥n normal
          history.go(-1);
        }
      };
    }

    // Activamos el bloqueo del bot√≥n atr√°s al cargar la p√°gina
    window.addEventListener("load", bloquearBotonAtras);

    /* ============================
    Normalizaci√≥n + lector de QR
    ============================ */
    function normalizarQR(decodedText) {
      let sede = "", empresa = "", tanques_qr = null;

      // 1) JSON
      try {
        const obj = JSON.parse(decodedText);
        if (obj && (obj.sede || obj.empresa)) {
          sede = (obj.sede || "").trim();
          empresa = (obj.empresa || "").trim();

          // NUEVO: tanques embebidos en el QR
          if (Array.isArray(obj.tanques)) {
            tanques_qr = obj.tanques.map(t => ({
              numero: String(t.numero || "").toLowerCase().trim(),
              capacidad: Number(t.capacidad || 0)
            })).filter(t => t.numero);
          }
        }
      } catch (_) { }

      // 2) URL
      if (!sede) {
        try {
          const u = new URL(decodedText);
          sede = (u.searchParams.get("sede") || "").trim();
          empresa = (u.searchParams.get("empresa") || "").trim();
        } catch (_) { }
      }

      // 3) "SEDE | EMPRESA"
      if (!sede && decodedText.includes("|")) {
        const [s, e] = decodedText.split("|", 2);
        sede = (s || "").trim();
        empresa = (e || "").trim();
      }

      // 4) Texto plano
      if (!sede) { sede = (decodedText || "").trim(); }

      // Limpiezas
      sede = sede.replace(/\u00A0/g, " ").replace(/\s+/g, " ").trim();
      empresa = empresa.replace(/\u00A0/g, " ").replace(/\s+/g, " ").trim();

      return { sede, empresa, tanques: tanques_qr };
    }


    const FORCE_OFFLINE_KEY = "glp_force_offline"; // "1" o "0"

    function isForceOffline() {
      return localStorage.getItem(FORCE_OFFLINE_KEY) === "1";
    }

    function setForceOffline(v) {
      localStorage.setItem(FORCE_OFFLINE_KEY, v ? "1" : "0");

      // informar al Service Worker (para bloquear POST reales)
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ type: "GLP_FORCE_OFFLINE", value: !!v });
      }

      // opcional: pinta un banner visible ‚ÄúMODO OFFLINE ACTIVO‚Äù
      try { renderForceOfflineBanner(); } catch (e) { console.warn(e); }
    }
    function isForceOffline() {
      return localStorage.getItem(FORCE_OFFLINE_KEY) === "1";
    }
    /* ============================
    MONITOR operatividad_pwa (AUTO)
    ============================ */

    const OPERATIVIDAD = {
      CHECK_EVERY_MS: 8000,          // cada 8s
      TIMEOUT_MS: 4500,              // timeout del ping (4.5s)
      FAIL_THRESHOLD: 2,             // 2 fallos seguidos -> entrar OFFLINE
      SUCCESS_THRESHOLD: 3,          // 3 √©xitos seguidos -> salir OFFLINE + sync
      ENDPOINT: "/glp/context"       // ping liviano (GET)
    };

    let _opw = {
      timer: null,
      inFlight: false,
      fails: 0,
      oks: 0
    };
    async function pingOperatividadPWA() {
      // CORRECCI√ìN CR√çTICA: Se elimin√≥ la l√≠nea "if (isForceOffline()) return false;"
      // Ahora el sistema SIEMPRE verificar√° si hay se√±al para poder despertar.

      const ctrl = new AbortController();
      // Damos 6 segundos de espera (ideal para zonas con se√±al inestable)
      const timeout = setTimeout(() => ctrl.abort(), 6000);

      try {
        // Usamos timestamp para evitar que el navegador use memoria vieja
        const pingUrl = "/glp/context?ping=" + Date.now();

        const r = await fetch(pingUrl, {
          method: "GET",
          cache: "no-store",
          credentials: "include",
          signal: ctrl.signal,
          headers: { "Accept": "application/json" }
        });

        clearTimeout(timeout);

        if (!r.ok) return false;

        const ct = (r.headers.get("content-type") || "").toLowerCase();
        if (!ct.includes("application/json")) return false;

        // ¬°√âxito! El servidor respondi√≥. Confirmado que hay internet.
        await r.json();
        return true;

      } catch (e) {
        clearTimeout(timeout);
        return false; // Solo aqu√≠ confirmamos que no hay se√±al real
      }
    }

    async function evaluarYAplicarOperatividadPWA() {
      const isOffline = await pingOperatividadPWA();  // Realiza el ping para ver si el servidor est√° disponible

      if (isOffline) {
        // Si no hay operatividad (offline)
        if (!isForceOffline()) {
          setForceOffline(true);  // Activa el modo offline en el frontend y en el SW
          console.log("[Operatividad] Entrando en modo OFFLINE...");

          // Enviar el estado al Service Worker
          if (navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
              type: "GLP_FORCE_OFFLINE",
              value: true
            });
          }
        }
      } else {
        // Si hay operatividad (online)
        if (isForceOffline()) {
          setForceOffline(false);  // Desactiva el modo offline
          console.log("[Operatividad] Volviendo a modo ONLINE...");

          // Enviar el estado al Service Worker
          if (navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
              type: "GLP_FORCE_OFFLINE",
              value: false
            });
          }

          flushOfflineQueue();  // Sincroniza la cola de operaciones
        }
      }
    }

    function iniciarMonitorOperatividadPWA() {
      if (_opw.timer) return;

      // chequeo inmediato
      evaluarYAplicarOperatividadPWA();

      _opw.timer = setInterval(evaluarYAplicarOperatividadPWA, OPERATIVIDAD.CHECK_EVERY_MS);

      window.addEventListener("online", () => evaluarYAplicarOperatividadPWA());
      window.addEventListener("offline", () => evaluarYAplicarOperatividadPWA());
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) evaluarYAplicarOperatividadPWA();
      });
    }


    // al cargar la p√°gina, empuja el estado actual al SW
    window.addEventListener("load", () => {
      setForceOffline(isForceOffline());
      iniciarMonitorOperatividadPWA();
    });

    // ===================================================
    //   UTILIDADES OFFLINE: cola + cache tanques
    // ===================================================

    // --- Cola offline para env√≠os POST ---
    // ===================================================
    //   COLA OFFLINE EN INDEXEDDB (soporta fotos grandes)
    // ===================================================
    const DB_NAME = "glp_offline_db";
    const STORE = "queue";

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(STORE)) {
            db.createObjectStore(STORE, { keyPath: "id", autoIncrement: true });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function idbAdd(item) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).add(item);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    async function idbGetAll() {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readonly");
        const req = tx.objectStore(STORE).getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
    }

    async function idbClear() {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).clear();
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    // --- API compatible con tu l√≥gica actual ---
    async function enqueueOffline(item) {
      await idbAdd({ ...item, ts: Date.now() });
    }

    async function getQueue() {
      try { return await idbGetAll(); }
      catch { return []; }
    }

    async function setQueue(q) {
      await idbClear();
      for (const it of q) await idbAdd(it);
    }

    let GLP_LOGIN_WARNING_SHOWN = false;

    async function flushOfflineQueue() {
      // 1. No hacer sync si estamos en modo OFFLINE manual
      if (typeof isForceOffline === "function" && isForceOffline()) {
        console.log("[SW] Modo offline. No se sincronizan las operaciones.");
        return;
      }

      // 2. Verificar si hay algo en la cola
      const q = await getQueue();
      if (!q.length) {
        // Si la cola est√° vac√≠a, ocultamos el aviso rojo por si acaso
        const warningDiv = document.getElementById("syncWarning");
        if (warningDiv) warningDiv.style.display = 'none';
        return;
      }

      console.log(`[Sync] Intentando sincronizar ${q.length} operaciones...`);

      const remaining = [];
      let needLoginForSync = false; // Bandera para detectar sesi√≥n vencida
      let sincronizadosCount = 0;

      for (const it of q) {
        // Si ya detectamos que falta login, guardamos el resto y paramos
        // para no bombardear al servidor con errores.
        if (needLoginForSync) {
          remaining.push(it);
          continue;
        }

        try {
          const r = await fetch(it.url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(it.payload)
          });

          const status = r.status;
          const ct = (r.headers.get("content-type") || "").toLowerCase();

          // DETECCI√ìN DE SESI√ìN CADUCADA
          // Si devuelve HTML (p√°gina de login), redirecci√≥n (302) o error de auth (401/403)
          if (!ct.includes("application/json") || status === 401 || status === 403 || r.redirected) {
            console.warn("‚ö†Ô∏è La sesi√≥n caduc√≥ durante la sincronizaci√≥n.");
            needLoginForSync = true; // ¬°Activamos la alarma!
            remaining.push(it);      // Guardamos el dato para despu√©s
            continue;                // Pasamos al siguiente ciclo (que se detendr√° por el if de arriba)
          }

          const j = await r.json();

          if (!j.success) {
            // Error de l√≥gica del servidor (ej. datos inv√°lidos), lo guardamos para revisi√≥n
            console.error("‚ùå Error del servidor:", j.message);
            remaining.push(it);
          } else {
            // ¬°√âXITO!
            sincronizadosCount++;
            console.log("‚úÖ Operaci√≥n sincronizada:", it.payload.op_id);
          }

        } catch (e) {
          console.error("Error de red en sync:", e);
          remaining.push(it);
        }
      }

      // Guardamos lo que qued√≥ pendiente (por error de red o por sesi√≥n vencida)
      await setQueue(remaining);

      // === ACCIONES FINALES ===

      // A. Si hubo √©xito (total o parcial)
      if (sincronizadosCount > 0) {
        // Si ya no queda nada pendiente, ocultamos el aviso rojo
        if (remaining.length === 0) {
          const warningDiv = document.getElementById("syncWarning");
          if (warningDiv) warningDiv.style.display = 'none';

          // √âXITO TOTAL: Avisamos y recargamos para limpiar la pantalla
          alert(`‚úÖ Se han sincronizado ${sincronizadosCount} operaciones exitosamente.`);
          window.location.reload();
        }
      }

      // B. SI LA SESI√ìN VENCI√ì: MENSAJE TRANQUILIZADOR Y REDIRECCI√ìN
      if (needLoginForSync) {
        alert(
          "‚ö†Ô∏è ¬°ATENCI√ìN! TU SESI√ìN HA VENCIDO\n\n" +
          "‚úã Tranquilo, los datos de la operaci√≥n est√°n GUARDADOS y SEGUROS en este celular.\n\n" +
          "Para enviarlos al servidor, necesitamos confirmar tu identidad nuevamente.\n\n" +
          "üëâ Dale Aceptar, vuelve a ingresar tu usuario y contrase√±a, y los datos se enviar√°n AUTOM√ÅTICAMENTE apenas entres."
        );

        // Redirigimos al logout para obligar al usuario a loguearse de nuevo
        window.location.href = "/logout";
      }
    }

    function programarFlushOffline() {
      // 1. Cuando el navegador detecta que volvieron los datos/wifi
      window.addEventListener("online", () => {
        console.log("[GLP offline] Se√±al detectada. Iniciando secuencia de sincronizaci√≥n...");

        // ESTRATEGIA DE REINTENTOS ESCALONADOS (2.5s, 6s, 12s)
        // Ayuda a superar micro-cortes o inestabilidad inicial
        setTimeout(() => {
          console.log("üîÑ Sincronizando (Intento 1)...");
          flushOfflineQueue();
          // Forzamos tambi√©n la revisi√≥n del estado general (ping)
          if (typeof evaluarYAplicarOperatividadPWA === 'function') {
            evaluarYAplicarOperatividadPWA();
          }
        }, 2500);

        setTimeout(() => {
          console.log("üîÑ Sincronizando (Intento 2)...");
          flushOfflineQueue();
        }, 6000);

        setTimeout(() => {
          flushOfflineQueue();
        }, 12000);
      });

      // 2. Al abrir la app (EVENTO LOAD) - AQU√ç EST√Å LA MEJORA VISUAL
      window.addEventListener("load", async () => {
        try {
          // A. Verificar visualmente si hay pendientes para mostrar el aviso rojo
          if (typeof getQueue === 'function') {
            const q = await getQueue();
            if (q.length > 0) {
              console.log("‚ö†Ô∏è Se detectaron operaciones pendientes al iniciar.");
              if (typeof mostrarAvisoSyncPendiente === 'function') {
                mostrarAvisoSyncPendiente(); // Muestra el bot√≥n rojo
              }
            }
          }
        } catch (e) {
          console.error("Error verificando cola al inicio:", e);
        }

        // B. Intentar sincronizar autom√°ticamente tras 1.5s
        setTimeout(flushOfflineQueue, 1500);
      });

      // 3. Monitor constante (Cada 10 segundos)
      // Sigue intentando eternamente mientras haya internet
      setInterval(() => {
        if (navigator.onLine) flushOfflineQueue();
      }, 10000);
    }


    // Activamos la programaci√≥n del flush al cargar el script
    programarFlushOffline();



    // --- Cache local de tanques por sede ---
    const TANQUES_CACHE_PREFIX = "tanques_cache_";

    function cacheTanquesLocal(sede, tanques) {
      localStorage.setItem(TANQUES_CACHE_PREFIX + sede, JSON.stringify({
        tanques,
        ts: Date.now()
      }));
    }

    function getTanquesLocal(sede) {
      try {
        return JSON.parse(localStorage.getItem(TANQUES_CACHE_PREFIX + sede) || "null");
      } catch {
        return null;
      }
    }

    // ===================================================
    //   OBTENER TANQUES CON FALLBACK: BD -> CACHE -> QR
    // ===================================================
    async function obtenerTanquesConFallback(sede) {
      const offlineForzado = (typeof isForceOffline === "function" && isForceOffline());
      const onlineReal = navigator.onLine && !offlineForzado;

      // 1) Intento BD (online REAL)
      if (onlineReal) {
        try {
          const r = await fetch("/glp/obtener_tanques", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sede })
          });

          const ct = (r.headers.get("content-type") || "").toLowerCase();
          if (!r.ok || !ct.includes("application/json")) {
            console.warn("Respuesta no JSON/OK en /glp/obtener_tanques:", r.status, ct);
            throw new Error("bad-response");
          }

          const d = await r.json();
          if (d.success && Array.isArray(d.tanques) && d.tanques.length) {
            cacheTanquesLocal(sede, d.tanques);
            return { tanques: d.tanques, fuente: "bd" };
          } else {
            console.warn("Respuesta JSON sin tanques v√°lidos:", d);
          }
        } catch (e) {
          console.error("Error consultando /glp/obtener_tanques:", e);
        }
      }

      // 2) Tanques embebidos en QR (si vienen en el QR)
      if (Array.isArray(tanquesQR) && tanquesQR.length) {
        if (!onlineReal) {
          if (offlineForzado) {
            alert("Modo OFFLINE activo. Usando tanques embebidos en el QR.");
          } else {
            alert("Sin internet. Usando tanques embebidos en el QR.");
          }
        } else {
          alert("No se encontraron tanques v√°lidos en el servidor. Usando tanques embebidos en el QR.");
        }

        cacheTanquesLocal(sede, tanquesQR);
        return { tanques: tanquesQR, fuente: "qr" };
      }

      // 3) Cache local del celular
      const cached = getTanquesLocal(sede);
      if (cached && Array.isArray(cached.tanques) && cached.tanques.length) {
        if (!onlineReal) {
          if (offlineForzado) {
            alert("Modo OFFLINE activo. Usando tanques guardados en el celular.");
          } else {
            alert("Sin internet. Usando tanques guardados en el celular.");
          }
        } else {
          alert("No se encontraron tanques v√°lidos en el servidor. Usando tanques guardados en el celular.");
        }

        return { tanques: cached.tanques, fuente: "cache", ts: cached.ts };
      }

      // Nada disponible
      if (!onlineReal) {
        if (offlineForzado) {
          alert("Modo OFFLINE activo y no hay tanques guardados ni en el QR. Con√©ctate para sincronizar o escanea un QR con tanques embebidos para iniciar.");
        } else {
          alert("Sin internet y no hay tanques guardados ni en el QR. Con√©ctate para iniciar.");
        }
      } else {
        alert("No se pudieron obtener tanques ni del servidor, ni del celular, ni del QR.");
      }

      throw new Error("No hay tanques disponibles");
    }

    // ===================================================
    //   ENV√çO POST CON OFFLINE-FALLBACK
    // ===================================================
    async function sendWithOffline(url, payload, onSuccess) {
      // 1. Si est√° en modo offline manual, guardar y salir
      if (typeof isForceOffline === "function" && isForceOffline()) {
        await enqueueOffline({ url, payload });

        const fakeResponse = {
          success: true,
          offline: true,
          message: "Guardado offline (modo OFFLINE activo). Se enviar√° autom√°ticamente al recuperar operatividad.",
          op_id: payload.op_id,
          data: payload
        };

        if (typeof onSuccess === "function") {
          onSuccess(fakeResponse);
        } else {
          alert(fakeResponse.message);
          mostrarMenu();
        }
        limpiarEstadoOperacion();
        return fakeResponse;
      }

      // 2. Intento de env√≠o normal
      try {
        const r = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const ct = (r.headers.get("content-type") || "").toLowerCase();

        // Si no es JSON (ej. HTML de login o error de servidor), forzar error
        if (!ct.includes("application/json")) {
          throw new Error("non-json-response");
        }

        const j = await r.json();
        if (!j.success) throw new Error(j.message || "Error servidor");

        // √âxito real
        if (typeof onSuccess === "function") onSuccess(j);
        limpiarEstadoOperacion();
        return j;

      } catch (e) {
        // 3. MANEJO DE ERROR Y REINTENTOS
        const msg = String(e || "");

        // Detectar si es error de conexi√≥n/red
        const isNetworkError =
          !navigator.onLine ||
          msg.includes("Failed to fetch") ||
          msg.includes("NetworkError") ||
          msg.includes("non-json-response") ||
          msg.includes("Unexpected token <") ||
          msg.includes("Load failed");

        if (isNetworkError) {
          console.warn("‚ö†Ô∏è Fallo de red. Iniciando protocolo de persistencia:", e);

          // A. Guardar en la cola (Seguridad)
          await enqueueOffline({ url, payload });

          // B. ACTIVAR AVISO VISUAL CON BOT√ìN MANUAL (¬°NUEVO!)
          mostrarAvisoSyncPendiente();

          // C. Respuesta visual al usuario ("Tranquilo, se guard√≥")
          const fakeResponse = {
            success: true,
            offline: true,
            message: "‚ö†Ô∏è Se√±al inestable. Operaci√≥n guardada en el dispositivo.",
            op_id: payload.op_id,
            data: payload
          };

          if (typeof onSuccess === "function") {
            onSuccess(fakeResponse);
          } else {
            alert(fakeResponse.message);
            mostrarMenu();
          }

          limpiarEstadoOperacion();

          // D. ESTRATEGIA DE R√ÅFAGA AUTOM√ÅTICA
          setTimeout(() => flushOfflineQueue(), 2000);
          setTimeout(() => flushOfflineQueue(), 5000);
          setTimeout(() => flushOfflineQueue(), 10000);

          return fakeResponse;
        }

        alert("No se pudo completar la operaci√≥n: " + (e.message || e));
        throw e;
      }
    }

    function leerQR(titulo) {
      return new Promise((resolve, reject) => {
        const menu = document.getElementById("menuOpciones");
        const convo = document.getElementById("conversacion");
        const lector = document.getElementById("lectorQR");
        const texto = document.getElementById("preguntaTexto");
        if (menu) menu.style.display = "none";
        if (convo) convo.style.display = "block";
        if (lector) lector.style.display = "block";
        if (texto) texto.textContent = titulo || "Escanea el QR de la sede";

        lector.innerHTML = "";
        const qr = new Html5Qrcode("lectorQR");
        const config = { fps: 10, qrbox: 250 };
        qr.start({ facingMode: "environment" }, config, (decodedText) => {
          qr.stop().then(() => {
            lector.innerHTML = "";
            resolve(normalizarQR(decodedText));
          });
        }).catch(err => reject(err));
      });
    }

    /* ============================
    Utilidades UI
    ============================ */
    function show(el, disp = "block") { if (el) el.style.display = disp; }
    function hide(el) { if (el) el.style.display = "none"; }

    const EMPRESA_SESION = "{{ session.get('empresa','') }}";

    function mostrarAvisoSyncPendiente() {
      const div = document.getElementById("syncWarning");
      if (!div) return;

      div.style.display = "block";
      div.innerHTML = `
        <div id="syncWarning-header">
          <div id="syncWarning-icon">!</div>
          <div>Operaciones pendientes</div>
        </div>
        <div id="syncWarning-body">
          Hay operaciones guardadas en el celular que no han subido al servidor.
        </div>
        
        <button onclick="flushOfflineQueue()" style="
            width: 100%;
            margin-top: 8px;
            padding: 10px;
            background-color: #b71c1c;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        ">
            üîÑ INTENTAR ENVIAR AHORA
        </button>
        
        <div style="margin-top:8px; font-size:12px; color:#555;">
           El sistema intentar√° enviarlas autom√°ticamente, pero puedes usar este bot√≥n para forzarlo si tienes internet.
        </div>
      `;
    }


    let sedeQR = "", empresaQR = "";
    let tanques = []; // [{numero, capacidad}]
    let tanquesQR = [];  // fallback de tanques le√≠dos desde el QR (si vienen)
    let items = [];   // [{numero, capacidad, nivel, testigo(base64)}]
    let idx = 0;

    /* ============================
    Panel de resumen (√∫nico)
    ============================ */
    function tituloOperacion(op) {
      switch (op) {
        case "inicio_calefaccion": return "Resumen - Inicio de calefacci√≥n";
        case "tanqueo": return "Resumen - Tanqueo de GLP";
        case "consumo": return "Resumen - Registro de consumo";
        case "finalizar_calefaccion": return "Resumen - Finalizaci√≥n de calefacci√≥n";
        default: return "Resumen de operaci√≥n GLP";
      }
    }

    function mostrarResumenOperacion(resp) {
      desactivarProteccionOperacion();
      const panel = document.getElementById("panelResumen");
      const menu = document.getElementById("menuOpciones");
      const convo = document.getElementById("conversacion");
      const pregunta = document.getElementById("preguntaTexto");

      if (!panel) {
        if (pregunta) pregunta.textContent = "";
        alert(resp.message || (resp.success ? "Operaci√≥n realizada" : "No se pudo completar la operaci√≥n"));
        mostrarMenu();
        return;
      }

      const r = resp.resumen || {};
      const op = r.operacion || "";

      if (pregunta) {
        pregunta.textContent = "";
      }

      const tanques = Array.isArray(r.tanques) ? r.tanques : [];
      const filasTanques = tanques.map(t => {
        const num = t.numero || "";
        const niv = (t.nivel !== undefined && t.nivel !== null) ? t.nivel : "";
        const cap = (t.capacidad !== undefined && t.capacidad !== null) ? t.capacidad : "";
        return `<tr>
      <td>${num}</td>
      <td>${niv === "" ? "" : niv + "%"}</td>
      <td>${cap}</td>
    </tr>`;
      }).join("");

      const saldoTexto = (r.saldo_estimado_kg !== undefined && r.saldo_estimado_kg !== null)
        ? `<p><strong>Saldo estimado:</strong> ${r.saldo_estimado_kg} kg (${r.saldo_estimado_galones} galones)</p>`
        : "";

      const avicolaTexto = (r.pollitos)
        ? `<p><strong>Pollitos:</strong> ${r.pollitos || "-"} </p>`
        : "";

      let diasTexto = "";
      if (typeof r.dias_operacion === "number" && r.dias_operacion > 0) {
        diasTexto = `<p><strong>D√≠a ${r.dias_operacion} de calefacci√≥n</strong></p>`;
      }

      let consumoTexto = "";
      if (r.kg_consumidos !== undefined && r.kg_consumidos !== null && Number(r.kg_consumidos) > 0) {
        consumoTexto = `<p><strong>Consumo desde la √∫ltima operaci√≥n:</strong> ${Number(r.kg_consumidos).toFixed(2)} kg</p>`;
        if (r.kg_pollito !== undefined && r.kg_pollito !== null && Number(r.kg_pollito) > 0) {
          consumoTexto += `<p><strong>Consumo por pollito:</strong> ${Number(r.kg_pollito).toFixed(6)} kg/pollito</p>`;
        }
      }

      panel.innerHTML = `
    <h3>${tituloOperacion(op)}</h3>
    <p><strong>Sede:</strong> ${r.sede || ""}</p>
    <p><strong>Lote:</strong> ${r.lote || ""}</p>
    ${r.fecha ? `<p><strong>Fecha:</strong> ${r.fecha}</p>` : ""}
    ${diasTexto}
    ${avicolaTexto}
    ${tanques.length ? `
      <table>
        <thead>
          <tr>
            <th>Tanque</th>
            <th>Nivel (%)</th>
            <th>Capacidad (gal)</th>
          </tr>
        </thead>
        <tbody>
          ${filasTanques}
        </tbody>
      </table>
    ` : ""}
    ${consumoTexto}
    ${saldoTexto}
    <p class="resumen-msg">${resp.message || ""}</p>
    <button id="btnCerrarResumen" onclick="cerrarResumen()">Volver al men√∫ principal</button>
  `;

      if (menu) menu.style.display = "none";
      if (convo) convo.style.display = "none";
      panel.style.display = "block";
    }

    function cerrarResumen() {
      desactivarProteccionOperacion();

      const panel = document.getElementById("panelResumen");
      const menu = document.getElementById("menuOpciones");
      const convo = document.getElementById("conversacion");
      const pregunta = document.getElementById("preguntaTexto");

      // Limpieza visual completa
      if (pregunta) pregunta.textContent = "";

      if (panel) {
        panel.innerHTML = "";
        panel.style.display = "none";
      }

      if (menu) menu.style.display = "flex";
      if (convo) convo.style.display = "none";

      // Opcional: si quieres evitar que quede ‚Äúposicionado‚Äù raro
      window.scrollTo({ top: 0, behavior: "instant" });
    }



    /**
    * Funci√≥n gen√©rica que usan TODAS las operaciones al recibir la respuesta.
    */
    function manejarRespuestaOperacion(resp) {
      if (!resp) {
        alert("Respuesta inv√°lida del servidor.");
        mostrarMenu();
        return;
      }
      if (resp.resumen) {
        mostrarResumenOperacion(resp);
      } else {
        alert(resp.message || (resp.success ? "Operaci√≥n realizada" : "No se pudo completar la operaci√≥n"));
        mostrarMenu();
      }
    }

    /* ============================
    Flujo com√∫n: cargar tanques
    ============================ */
    async function cargarTanques(callback) {
      try {
        const res = await obtenerTanquesConFallback(sedeQR);

        tanques = Array.isArray(res.tanques) ? res.tanques : [];
        if (tanques.length === 0) {
          alert("No se encontraron tanques para esta sede.");
          mostrarMenu();
          return;
        }

        // Normalizar numero/etiqueta a min√∫sculas (igual que antes)
        tanques = tanques.map(t => ({
          numero: String(t.numero || t.etiqueta || "").toLowerCase(),
          capacidad: Number(t.capacidad || 0),
          etiqueta: String(t.numero || t.etiqueta || "").toLowerCase()
        }));

        if (typeof callback === "function") callback();

      } catch (err) {
        console.error(err);
        mostrarMenu();
      }
    }

    function mostrarMenu() {
      desactivarProteccionOperacion();
      document.getElementById("menuOpciones").style.display = "flex";
      document.getElementById("conversacion").style.display = "none";
    }

    // =======================================
    //   COMPRESI√ìN DE IMAGEN ANTES DE GUARDAR
    // =======================================
    async function comprimirImagenArchivo(file, maxDim = 1024, quality = 0.7) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(reader.error || "Error leyendo la imagen");
        reader.onload = () => {
          const img = new Image();
          img.onerror = () => reject("No se pudo cargar la imagen");
          img.onload = () => {
            let width = img.width;
            let height = img.height;

            // Redimensionar manteniendo proporci√≥n
            if (width > height) {
              if (width > maxDim) {
                height = Math.round(height * (maxDim / width));
                width = maxDim;
              }
            } else {
              if (height > maxDim) {
                width = Math.round(width * (maxDim / height));
                height = maxDim;
              }
            }

            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            // Exportar como JPEG comprimido
            const dataUrl = canvas.toDataURL("image/jpeg", quality);
            resolve(dataUrl);
          };
          img.src = reader.result;
        };
        reader.readAsDataURL(file);
      });
    }

    /* ============================
    Captura nivel + foto (com√∫n)
    ============================ */
    function preguntarNivelFoto(onFinish) {
      const texto = document.getElementById("preguntaTexto");
      const input = document.getElementById("respuestaInput");
      const foto = document.getElementById("inputFoto");
      const btn = document.getElementById("botonEnviar");

      // Si ya no hay m√°s tanques, terminamos
      if (idx >= tanques.length) {
        hide(input); hide(foto); hide(btn);
        if (typeof onFinish === "function") onFinish();
        return;
      }

      const tk = tanques[idx];
      let nivelActual = 0;
      let archivoFoto = null;

      // Paso 1: preguntar NIVEL
      hide(foto);
      input.type = "number";
      input.value = "";
      show(input);

      texto.textContent = `Nivel actual del ${tk.numero} (0-100%)`;
      btn.textContent = "Guardar nivel";
      show(btn);

      input.onkeyup = (ev) => {
        if (ev.key === "Enter") { btn.click(); }
      };

      btn.onclick = () => {
        const nivel = Number(input.value || 0);
        if (isNaN(nivel) || nivel < 0 || nivel > 100) {
          alert("Ingresa un nivel v√°lido (0-100).");
          return;
        }
        nivelActual = nivel;
        pedirFoto();
      };

      // Paso 2: pedir FOTO + bot√≥n verde para continuar
      function pedirFoto() {
        hide(input);
        texto.textContent = `Adjunta la foto del ${tk.numero}`;
        foto.value = null;
        archivoFoto = null;

        show(foto);
        btn.textContent = "Subir foto y continuar";
        show(btn);

        foto.onchange = () => {
          const f = foto.files[0];
          if (!f) {
            alert("Debes seleccionar la foto.");
            archivoFoto = null;
            return;
          }
          archivoFoto = f;
        };

        btn.onclick = async () => {
          if (!archivoFoto) {
            alert("Debes seleccionar la foto antes de continuar.");
            return;
          }
          try {
            const base64 = await comprimirImagenArchivo(archivoFoto);

            items.push({
              numero: tk.numero,
              capacidad: tk.capacidad,
              nivel: nivelActual,
              testigo: base64
            });

            // Pasar al siguiente tanque
            idx++;
            preguntarNivelFoto(onFinish);

          } catch (err) {
            console.error(err);
            alert("No se pudo procesar la foto. Intenta de nuevo.");
          }
        };
      }
    }

    // ===============================
    //  OP_ID (idempotencia frontend)
    // ===============================
    function generarOpId() {
      // Navegadores modernos
      if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
      // Fallback simple
      return "op_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    }

    // Limpia estado de UI/datos al terminar o guardar offline
    function limpiarEstadoOperacion() {
      desactivarProteccionOperacion();
      items = [];
      idx = 0;
      tanques = [];
      tanquesDisponibles = [];
      tanqueActualDatos = null;
      tanqueActualIndex = 0;

      registrarTanqueoData = { sede: "", tanques: [] };


      const input = document.getElementById("respuestaInput");
      const foto = document.getElementById("inputFoto");
      const btn = document.getElementById("botonEnviar");
      const siNo = document.getElementById("preguntaSiNo");

      if (input) { input.value = ""; input.onkeyup = null; }
      if (foto) { foto.value = ""; foto.onchange = null; }
      if (btn) { btn.onclick = null; btn.style.display = "none"; }
      if (siNo) { siNo.style.display = "none"; }

      // ‚úÖ apagar panel de conversaci√≥n/lector por seguridad
      const convo = document.getElementById("conversacion");
      const lector = document.getElementById("lectorQR");
      if (convo) convo.style.display = "none";
      if (lector) lector.style.display = "none";

    }

    /* ============================
    INICIAR CALEFACCI√ìN
    ============================ */
    async function iniciarCalefaccion() {
      activarProteccionOperacion();
      try {
        const info = await leerQR("Escanea el QR de la sede para iniciar calefacci√≥n");
        sedeQR = info.sede; empresaQR = info.empresa;
        tanquesQR = Array.isArray(info.tanques) ? info.tanques : [];
        const texto = document.getElementById("preguntaTexto");
        const input = document.getElementById("respuestaInput");
        const foto = document.getElementById("inputFoto");
        const btn = document.getElementById("botonEnviar");
        document.getElementById("preguntaSiNo").style.display = "none";

        if (input) {
          input.onkeyup = null;
        }
        if (foto) {
          foto.onchange = null;
        }
        if (btn) {
          btn.onclick = null;
        }

        items = []; idx = 0;

        function despuesDeAvicola() {
          cargarTanques(() => { preguntarNivelFoto(enviarInicio); });
        }

        if (EMPRESA_SESION === "Pollos GAR SAS") {
          // Pollitos (√∫nica pregunta av√≠cola)
          show(input); hide(foto);
          input.type = "number"; input.value = "";
          texto.textContent = "¬øCon cu√°ntos pollitos inicias el lote?";
          btn.textContent = "Confirmar"; show(btn);

          btn.onclick = () => {
            const pollitos = Number(input.value || 0);
            if (isNaN(pollitos) || pollitos <= 0) { alert("Ingresa un n√∫mero v√°lido de pollitos."); return; }

            input.dataset.pollitos = String(pollitos);

            // Limpieza defensiva por si qued√≥ de versiones anteriores

            hide(btn); hide(input);
            despuesDeAvicola();
          };
        } else {
          hide(input); hide(btn); hide(foto);
          despuesDeAvicola();
        }
      } catch (e) {
        alert("No fue posible leer el QR: " + e);
        mostrarMenu();
      }
    }

    function enviarInicio() {
      const pollitos = Number(document.getElementById("respuestaInput").dataset.pollitos || 0) || null;
      const payload = {
        op_id: generarOpId(),
        sede: sedeQR,
        pollitos: (EMPRESA_SESION === "Pollos GAR SAS" ? pollitos : null),
        tanques: items
      };
      // Env√≠o con tolerancia a offline:
      sendWithOffline("/glp/registrar_inicio", payload, manejarRespuestaOperacion);
    }


    // ============================================
    // NUEVO FLUJO DE REGISTRAR TANQUEO
    // ============================================

    // Cargar tanques SOLO para la operaci√≥n registrar tanqueo (con fallback offline)
    async function cargarTanquesTanqueo(callback) {
      try {
        const res = await obtenerTanquesConFallback(sedeQR);

        tanquesDisponibles = Array.isArray(res.tanques) ? res.tanques : [];
        if (tanquesDisponibles.length === 0) {
          alert("No se encontraron tanques para esta sede.");
          mostrarMenu();
          return;
        }

        // Normalizar (igual que en el original)
        tanquesDisponibles = tanquesDisponibles.map(t => ({
          numero: String(t.numero || t.etiqueta || "").toLowerCase(),
          capacidad: Number(t.capacidad || 0)
        }));

        if (typeof callback === "function") callback();

      } catch (err) {
        console.error(err);
        mostrarMenu();
      }
    }

    // Inicia la operaci√≥n registrar tanqueo
    async function registrarTanqueo() {
      activarProteccionOperacion();
      try {
        registrarTanqueoData.sede = "";
        registrarTanqueoData.tanques = [];
        tanqueActualIndex = 0;

        const info = await leerQR("Escanea el QR de la sede para registrar el tanqueo");
        sedeQR = info.sede;
        empresaQR = info.empresa;
        tanquesQR = Array.isArray(info.tanques) ? info.tanques : [];
        registrarTanqueoData.sede = sedeQR;

        // üîπ Limpiamos cualquier handler viejo antes de empezar el flujo nuevo
        const input = document.getElementById("respuestaInput");
        const foto = document.getElementById("inputFoto");
        const btn = document.getElementById("botonEnviar");

        if (input) {
          input.onkeyup = null;
          input.dataset.pollitos = "";
        }
        if (foto) {
          foto.onchange = null;
        }
        if (btn) {
          btn.onclick = null;
        }

        cargarTanquesTanqueo(() => {
          tanqueActualIndex = 0;
          preguntarSiTanquearTanqueActual();
        });
      } catch (e) {
        console.error(e);
        alert("No fue posible leer el QR: " + e);
        mostrarMenu();
      }
    }

    // Pregunta: ¬øDesea tanquear el tanque TK-n?
    function preguntarSiTanquearTanqueActual() {
      const texto = document.getElementById("preguntaTexto");
      const input = document.getElementById("respuestaInput");
      const foto = document.getElementById("inputFoto");
      const btn = document.getElementById("botonEnviar");
      const panelSiNo = document.getElementById("preguntaSiNo");
      const btnSi = document.getElementById("btnSi");
      const btnNo = document.getElementById("btnNo");

      // Si ya terminamos los tanques, enviar
      if (tanqueActualIndex >= tanquesDisponibles.length) {
        enviarTanqueo();
        return;
      }

      const tk = tanquesDisponibles[tanqueActualIndex];

      // Mostrar pregunta
      texto.textContent = `¬øDesea tanquear el tanque ${tk.numero.toUpperCase()}?`;

      // Ocultar controles normales
      hide(input);
      hide(foto);
      hide(btn);

      // Mostrar botones s√≠/no
      panelSiNo.style.display = "block";

      // Acci√≥n SI
      btnSi.onclick = () => {
        panelSiNo.style.display = "none";
        prepararDatosTanqueActual(tk);
        pedirNivelInicial();
      };

      // Acci√≥n NO
      btnNo.onclick = () => {
        panelSiNo.style.display = "none";
        tanqueActualIndex++;
        preguntarSiTanquearTanqueActual();
      };
    }


    // Prepara objeto temporal del tanque actual
    let tanqueActualDatos = null;
    function prepararDatosTanqueActual(tk) {
      tanqueActualDatos = {
        numero: tk.numero,
        capacidad: tk.capacidad,
        nivel_inicial: 0,
        foto_nivel_inicial: "",
        nivel_final: 0,
        foto_nivel_final: "",
        densidad_suministrada: 0,
        kg_suministrados: 0,
        foto_baucher: ""
      };
    }

    // 1) Nivel inicial
    function pedirNivelInicial() {
      const texto = document.getElementById("preguntaTexto");
      const input = document.getElementById("respuestaInput");
      const foto = document.getElementById("inputFoto");
      const btn = document.getElementById("botonEnviar");

      show(input); hide(foto);
      input.type = "number";
      input.value = "";
      texto.textContent = `Ingresa el NIVEL ACTUAL del tanque ${tanqueActualDatos.numero.toUpperCase()} (0-100 %)`;
      btn.textContent = "Confirmar nivel";
      show(btn);

      btn.onclick = () => {
        const n = Number(input.value || 0);
        if (isNaN(n) || n < 0 || n > 100) {
          alert("Ingresa un nivel v√°lido entre 0 y 100.");
          return;
        }
        tanqueActualDatos.nivel_inicial = n;
        pedirFotoNivelInicial();
      };
    }

    // 2) Foto nivel inicial
    function pedirFotoNivelInicial() {
      const texto = document.getElementById("preguntaTexto");
      const input = document.getElementById("respuestaInput");
      const foto = document.getElementById("inputFoto");
      const btn = document.getElementById("botonEnviar");
      document.getElementById("preguntaSiNo").style.display = "none";


      hide(input);
      texto.textContent = `Toma una FOTO del NIVEL ACTUAL del tanque ${tanqueActualDatos.numero.toUpperCase()}.`;
      // üîπ limpiamos cualquier onchange anterior
      foto.onchange = null;
      foto.value = "";
      show(foto);
      btn.textContent = "Subir foto y continuar";
      show(btn);

      btn.onclick = async () => {
        const f = foto.files[0];
        if (!f) {
          alert("Debes seleccionar la foto.");
          return;
        }
        try {
          const base64 = await comprimirImagenArchivo(f);
          tanqueActualDatos.foto_nivel_inicial = String(base64 || "");
          mostrarMensajeProcederTanqueo();
        } catch (err) {
          console.error(err);
          alert("No se pudo procesar la foto. Intenta de nuevo.");
        }
      };

    }
    // 3) Mensaje: puede proceder con el tanqueo
    function mostrarMensajeProcederTanqueo() {
      const texto = document.getElementById("preguntaTexto");
      const input = document.getElementById("respuestaInput");
      const foto = document.getElementById("inputFoto");
      const btn = document.getElementById("botonEnviar");
      document.getElementById("preguntaSiNo").style.display = "none";

      hide(input); hide(foto);
      texto.textContent = `Puedes proceder con el TANQUEO del tanque ${tanqueActualDatos.numero.toUpperCase()}. Cuando termines, presiona "Continuar".`;
      btn.textContent = "Continuar";
      show(btn);

      btn.onclick = () => {
        pedirNivelFinal();
      };
    }

    // 4) Nivel final
    function pedirNivelFinal() {
      const texto = document.getElementById("preguntaTexto");
      const input = document.getElementById("respuestaInput");
      const foto = document.getElementById("inputFoto");
      const btn = document.getElementById("botonEnviar");
      document.getElementById("preguntaSiNo").style.display = "none";


      show(input); hide(foto);
      input.type = "number";
      input.value = "";
      texto.textContent = `Ingresa el NIVEL FINAL del tanque ${tanqueActualDatos.numero.toUpperCase()} (0-100 %)`;
      btn.textContent = "Confirmar nivel final";
      show(btn);

      btn.onclick = () => {
        const n = Number(input.value || 0);
        if (isNaN(n) || n < 0 || n > 100) {
          alert("Ingresa un nivel v√°lido entre 0 y 100.");
          return;
        }
        tanqueActualDatos.nivel_final = n;
        pedirFotoNivelFinal();
      };
    }

    // 5) Foto nivel final
    function pedirFotoNivelFinal() {
      const texto = document.getElementById("preguntaTexto");
      const input = document.getElementById("respuestaInput");
      const foto = document.getElementById("inputFoto");
      const btn = document.getElementById("botonEnviar");
      document.getElementById("preguntaSiNo").style.display = "none";

      hide(input);
      texto.textContent = `Toma una FOTO del NIVEL FINAL del tanque ${tanqueActualDatos.numero.toUpperCase()}.`;
      // üîπ limpiamos cualquier onchange anterior
      foto.onchange = null;
      foto.value = "";
      show(foto);
      btn.textContent = "Subir foto y continuar";
      show(btn);

      btn.onclick = async () => {
        const f = foto.files[0];
        if (!f) {
          alert("Debes seleccionar la foto.");
          return;
        }
        try {
          const base64 = await comprimirImagenArchivo(f);
          tanqueActualDatos.foto_nivel_final = String(base64 || "");
          pedirDensidadSuministrada();
        } catch (err) {
          console.error(err);
          alert("No se pudo procesar la foto. Intenta de nuevo.");
        }
      };

    }

    // 6) Densidad suministrada
    function pedirDensidadSuministrada() {
      const texto = document.getElementById("preguntaTexto");
      const input = document.getElementById("respuestaInput");
      const foto = document.getElementById("inputFoto");
      const btn = document.getElementById("botonEnviar");
      document.getElementById("preguntaSiNo").style.display = "none";


      show(input); hide(foto);
      input.type = "number";
      input.step = "0.01";
      input.value = "";
      texto.textContent = `Ingresa la DENSIDAD SUMINISTRADA (kg/gal) para el tanque ${tanqueActualDatos.numero.toUpperCase()}.`;
      btn.textContent = "Confirmar densidad";
      show(btn);

      btn.onclick = () => {
        const d = Number(input.value || 0);
        if (isNaN(d) || d <= 0) {
          alert("Ingresa una densidad v√°lida (>0).");
          return;
        }
        tanqueActualDatos.densidad_suministrada = d;
        pedirKgSuministrados();
      };
    }

    // 7) Kg suministrados
    function pedirKgSuministrados() {
      const texto = document.getElementById("preguntaTexto");
      const input = document.getElementById("respuestaInput");
      const foto = document.getElementById("inputFoto");
      const btn = document.getElementById("botonEnviar");
      document.getElementById("preguntaSiNo").style.display = "none";


      show(input); hide(foto);
      input.type = "number";
      input.step = "0.01";
      input.value = "";
      texto.textContent = `Ingresa los KG SUMINISTRADOS al tanque ${tanqueActualDatos.numero.toUpperCase()}.`;
      btn.textContent = "Confirmar kg";
      show(btn);

      btn.onclick = () => {
        const k = Number(input.value || 0);
        if (isNaN(k) || k <= 0) {
          alert("Ingresa un valor v√°lido de kg (>0).");
          return;
        }
        tanqueActualDatos.kg_suministrados = k;
        pedirFotoBaucher();
      };
    }

    // 8) Foto baucher
    function pedirFotoBaucher() {
      const texto = document.getElementById("preguntaTexto");
      const input = document.getElementById("respuestaInput");
      const foto = document.getElementById("inputFoto");
      const btn = document.getElementById("botonEnviar");
      document.getElementById("preguntaSiNo").style.display = "none";


      hide(input);
      texto.textContent = `Toma una FOTO del BAUCHER DEL MASICO del tanque ${tanqueActualDatos.numero.toUpperCase()}.`;
      // üîπ limpiamos cualquier onchange anterior
      foto.onchange = null;
      foto.value = "";
      show(foto);
      btn.textContent = "Subir baucher y continuar";
      show(btn);

      btn.onclick = async () => {
        const f = foto.files[0];
        if (!f) {
          alert("Debes seleccionar la foto.");
          return;
        }
        try {
          const base64 = await comprimirImagenArchivo(f);
          tanqueActualDatos.foto_baucher = String(base64 || "");
          // Guardamos en el arreglo general
          registrarTanqueoData.tanques.push(tanqueActualDatos);
          // Pasamos al siguiente tanque
          tanqueActualIndex++;
          preguntarSiTanquearTanqueActual();
        } catch (err) {
          console.error(err);
          alert("No se pudo procesar la foto. Intenta de nuevo.");
        }
      };

    }

    // 9) Enviar todo al backend
    function enviarTanqueo() {
      if (!registrarTanqueoData.sede) {
        alert("No se pudo determinar la sede del tanqueo.");
        mostrarMenu();
        return;
      }

      // Env√≠o con tolerancia a offline
      sendWithOffline(
        "/glp/registrar_tanqueo",
        registrarTanqueoData,
        manejarRespuestaOperacion
      );
    }

    /* ============================
      REGISTRAR CONSUMO
    ============================ */
    async function registrarConsumo() {
      activarProteccionOperacion();
      try {
        const info = await leerQR("Escanea el QR de la sede para registrar consumo");
        sedeQR = info.sede;
        empresaQR = info.empresa;
        tanquesQR = Array.isArray(info.tanques) ? info.tanques : [];
        const texto = document.getElementById("preguntaTexto");
        const input = document.getElementById("respuestaInput");
        const foto = document.getElementById("inputFoto");
        const btn = document.getElementById("botonEnviar");
        document.getElementById("preguntaSiNo").style.display = "none";


        // üîπ limpieza de handlers viejos
        if (input) {
          input.onkeyup = null;
          input.dataset.pollitos = "";
        }
        if (foto) {
          foto.onchange = null;
        }
        if (btn) {
          btn.onclick = null;
        }
        items = []; idx = 0;
        cargarTanques(() => { preguntarNivelFoto(enviarConsumo); });
      } catch (e) {
        alert("No fue posible leer el QR: " + e);
        mostrarMenu();
      }
    }

    function enviarConsumo() {
      const payload = {
        op_id: generarOpId(),
        sede: sedeQR,
        tanques: items
      };

      // Env√≠o con tolerancia a offline
      sendWithOffline(
        "/glp/registrar_consumo",
        payload,
        manejarRespuestaOperacion
      );
    }


    /* ============================
       FINALIZAR CALEFACCI√ìN
       ============================ */
    async function finalizarCalefaccion() {
      activarProteccionOperacion();
      try {
        const info = await leerQR("Escanea el QR de la sede para finalizar la calefacci√≥n");

        sedeQR = info.sede;
        empresaQR = info.empresa;
        tanquesQR = Array.isArray(info.tanques) ? info.tanques : [];
        const texto = document.getElementById("preguntaTexto");
        const input = document.getElementById("respuestaInput");
        const foto = document.getElementById("inputFoto");
        const btn = document.getElementById("botonEnviar");
        document.getElementById("preguntaSiNo").style.display = "none";


        // üîπ limpieza de handlers viejos
        if (input) {
          input.onkeyup = null;
          input.dataset.pollitos = "";
        }
        if (foto) {
          foto.onchange = null;
        }
        if (btn) {
          btn.onclick = null;
        }
        items = []; idx = 0;
        cargarTanques(() => { preguntarNivelFoto(enviarFinalizar); });
      } catch (e) {
        alert("No fue posible leer el QR: " + e);
        mostrarMenu();
      }
    }

    function enviarFinalizar() {
      const payload = {
        op_id: generarOpId(),
        sede: sedeQR,
        tanques: items
      };

      // Env√≠o con tolerancia a offline
      sendWithOffline(
        "/glp/finalizar_calefaccion_batch",
        payload,
        manejarRespuestaOperacion
      );
    }

  </script>
  <script>
    // Background Sync + mensajes desde el Service Worker para cola GLP
    if ("serviceWorker" in navigator && "SyncManager" in window) {
      window.addEventListener("online", () => {
        navigator.serviceWorker.ready
          .then(reg => reg.sync.register("sync-glp-queue"))
          .catch(err => console.warn("No se pudo registrar sync-glp-queue:", err));
      });
    }

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.addEventListener("message", (event) => {
        if (
          event.data &&
          event.data.type === "BQA_GLPSYNC" &&
          event.data.action === "flushQueue" &&
          typeof flushOfflineQueue === "function"
        ) {
          flushOfflineQueue();
        }
      });
    }

    // =======================================================
    // PROTECCI√ìN DE CERRAR SESI√ìN (logout)
    // =======================================================

    function actualizarBloqueoLogout() {
      const logoutLinks = document.querySelectorAll('a[href="/logout"]');

      logoutLinks.forEach(a => {
        // primero quitamos cualquier handler previo
        a.onclick = null;

        a.addEventListener("click", function (e) {

          // 1. Si hay operaci√≥n GLP en curso ‚Üí SIEMPRE bloquear
          if (GLP_OPERACION_EN_CURSO) {
            e.preventDefault();
            alert("Debes terminar la operaci√≥n de GLP antes de cerrar sesi√≥n.");
            return;
          }

          // 2. Si NO hay internet ‚Üí bloquear (ya que no puede cerrar sesi√≥n)
          if (!navigator.onLine) {
            e.preventDefault();
            alert("Est√°s sin conexi√≥n. El cierre de sesi√≥n requiere internet.");
            return;
          }

          // 3. Si todo est√° bien ‚Üí permitir cerrar sesi√≥n
        });
      });
    }

    // Se ejecuta en todos los estados posibles
    window.addEventListener("load", actualizarBloqueoLogout);
    window.addEventListener("online", actualizarBloqueoLogout);
    window.addEventListener("offline", actualizarBloqueoLogout);

  </script>

</body>

</html>